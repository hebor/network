# BGP

在EGP协议中，引入了AS（Autonomous System，自治系统）的概念。AS是指由同一个技术管理机构管理，使用统一选路策略的一些路由器的集合。AS的内部使用IGP来计算和发现路由，如OSPF、ISIS、RIP等，同一个AS内部的路由器之间是相互信任的，因此IGP的路由计算和信息泛洪完全处于开放状态，人工干预很少。不同AS之间的连接需求推动了外部网关协议的发展，BGP作为一种外部网关协议，用于在AS之间进行路由控制和优选

BGP更关注于以一个AS作为一个节点，在不同的AS之间传递路由，而IGP关注的是将一个路由器的路由传递到其他路由器

**AS**

- 自治系统（AS）：单一技术管理下的一组网络
  - 16位编号（自2009年1月起使用32位编号）
  - 1 至 65535
  - 私有AS：64512-65534，65535保留

- 互联网编号指派机构（IANA，现在改名叫ICANN）会分配 AS 号
- IGP在AS内运行，AS间使用BGP

国内比较常见的AS号：中国电信163（4134）、中国电信CN2（4809）、中国网通（9929）；AS同时在BGP中还起到 *最佳路由的选择、避免环路、路由过滤* 等关键性作用

**BGP特点**

- 更新可靠：BGP在TCP 179端口上运行
- 仅增量式、触发式的更新
- 定期提供存活（keepalive）消息以验证TCP连接性，默认60s发送一次keepalive包
- 丰富的度量标准，称作路径矢量或属性
- 专门为大型互联网络而设计

BGP是路径矢量协议，优于距离矢量协议。使用BGP的三大理由：

- 大量路由需要承载，IGP只能容纳千条路由，而BGP能够容纳上万路由
- 支撑MPLS/VPN应用，传递客户VPN路由
- 策略能力强，可以很好的实现路由决策与数据控制

依据这三个理由也可以反向理解，BGP能够容纳上万路由的前提也要求设备本身性能强大，在设备性能不够或工程师不具备足够强大的策略能力的情况下，不建议使用BGP

## BGP邻居

- BGP Speakers：运行BGP的路由器
- BGP Peers = BGP Neighbors = BGP对等体/邻居
- 邻居关系建立在 *TCP连接基础上* ，因此邻居 *不一定需要直连* ，可以通过 *IGP或静态* 路由来提供TCP连接的可达性。区别于其他IGP，以OSPF为例，OSPF通过组播或单播建立邻居，而它建立邻居的前提是两台路由器之间必须是三层网络上的直连
- BGP邻居 *必须手动* 指定，而非自动建立。区别于其他IGP，例如OSPF协议在组播网络下自动建立邻居
- 一台BGP路由器只能运行在 *一个AS内* （区别于其他IGP）

**BGP邻居类型**

| 类型 | 解析 |
| :-: | :-: |
| EGBP | 外部BGP邻居，位于不同AS |
| IBGP | 内部BGP邻居，位于相同AS |

**BGP邻居配置命令**

| 命令 | 作用 |
| :-: | :-: |
| bgp 123 | 声明所在AS号（创建进程） |
| router-id 1.1.1.1 | 配置RID，必须唯一；BGP下的router-id属于可选配置，不强制要求配置 |
| peer 12.0.0.2 as-number 123 | 配置邻居IP地址和邻居所在AS号 |
| display bgp peer | 查看BGP邻居状态 |

![BGP邻居信息](https://www.z4a.net/images/2023/10/31/BGP.png)

Established是BGP的最终状态，这个状态就表示邻居建立完成。BGP的邻居状态不会像OSPF一样展示过程，他只会展示最终状态

**BGP邻居建立条件**

- 邻居地址可达
- 自身配置中的 *邻居所在AS号* = 邻居配置中的 *声明所在AS号*
- 数据包 *源IP* = 对方配置的 *邻居IP* ，这个源IP也叫更新源，也将作为路由的下一跳IP