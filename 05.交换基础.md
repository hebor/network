# 交换基础

交换机工作在数据链路层，对数据帧进行操作。收到数据帧后交换机会根据数据帧的头部信息对数据帧进行转发，二层以太网封装的数据帧报头实际上也就只有4个字段：DMAC、SMAC、协议类型、校验和，交换机主要依据MAC地址转发数据，MAC地址与IP地址不一样，MAC地址没有层次化结构，不需要分析网段

网络分层设计：

| 层次 | 作用 | 备注 |
| :-: | :-- | :-- |
| 出口层 | 广域网接入、出口策略、带宽控制 | 出口设备不一定是路由器，也可能是防火墙 |
| 核心层 | 高速转发、服务器接入、路由选择 | 数据中心机房 |
| 汇聚层 | 流量汇聚、链路冗余、设备冗余、路由选择 | 楼栋机房 |
| 接入层 | 用户接入、接入安全、访问控制 | 楼层间弱电井 |

## 交换机工作原理

**交换机的主要功能**

- 终端设备的接入
- 以太网数据帧的交换，根据目标MAC地址转发数据帧
- 学习MAC地址，并维护MAC地址表
- 防止二层环路

**交换机的工作原理**

根据MAC地址表中的MAC地址记录智能转发

|     原理     | 备注                                                         |
| :----------: | :----------------------------------------------------------- |
|  学习 Learn  | 当从一个接口收到帧时，把帧内的源MAC与该接口绑定，存入MAC地址表 |
|  泛洪 Flood  | 当从一个接口收到广播帧、组播帧、未知单播帧（目标MAC不存在于MAC地址表中），把该帧向所有其他端口转发出去 |
| 转发 Forward | 当从一个接口收到已知单播帧，立即从相应的接口转发出去         |
| 更新 Update  | 默认每条记录保持300秒<br />交换机重启会清空所有接口学习到的记录<br />接口关闭后会清空该接口学习到的记录<br />一个源MAC出现在另外一个接口上，会删除老的记录，添加新的记录 |

对于一台交换机而言

- 一个MAC地址只能绑定在一个接口上
- 一个接口上可以学习到多个MAC

**以太网接口工作模式**

|        术语        | 备注                                                         |
| :----------------: | :----------------------------------------------------------- |
| 半双工 half-duplex | 通信双方都能发送和接收数据，但不能同时进行                   |
| 全双工 full-duplex | 通信双方都能同时接收和发送数据                               |
|     速率 speed     | 接口连接时两端进行协商，协商（Negotiation）失败则无法正常通信 |

```VRP
sys
inte g0/0/1
undo negotiation auto	#关闭自动协商
speed 100	#设置端口速率。强制端口速率前必须先关闭自动协商
duplex full	#全双工
```

## VLAN

VLAN（Virtual Local Area Network）虚拟局域网，是将一个物理局域网在逻辑上划分成多个广播域的技术。通过在交换机上配置VLAN可以实现在同一个VLAN内的用户可以进行二层互访，而不同VLAN间的用户被二层隔离。它解决了传统以太网面临的广播泛滥和安全性无法保障等各种问题。VLAN技术实现在二层隔离了广播域，也就意味着不同VLAN内的主机在互相访问时，发送的ARP广播包是不可达的，所以两端无法互相通信

**VLAN的优势**

1. 有效控制广播域范围
2. 增强局域网的安全性
3. 灵活构建虚拟工作组，不再强依赖地理位置来安排工作地点了，但仍建议最好是根据地理位置安排工作地点
4. 简化网络管理

**VLAN概述**

- 将一个物理局域网在逻辑上划分成多个广播域
- 广播不会在VLAN间转发，而是被限制在各自的VLAN中
- 不同VLAN间的设备默认无法通讯，需要三层设备才能实现互通

**VLAN范围**：0～4096个，0和4095保留，1是默认编号

![VLAN标签](https://www.z4a.net/images/2023/09/21/VLAN.png)

IEEE 802.1q（dot1q）：是VLAN的正式标准，对Ethernet帧格式进行流修改，在源MAC地址字段和协议类型字段之间加入了4字节的802.1q Tag，每台支持802.1q协议的交换机发送的数据包都会包含VLAN ID，以指明交换机属于哪一个VLAN。因此，在一个VLAN交换网络中，以太网帧有一下两种形式：

|||
| :-: | :-- |
| 有标记帧（TagGed frame） | 加入了4字节802.1q Tag的帧 |
| 无标记帧（UnTagged frame）| 原始的、未加入4字节802.1q Tag的帧 |

TagGed frame有标记帧一般都是在交换机之间才能看到的，但交换机之间传输的帧不是所有帧都包含VLAN ID的，例如交换机与PC之间的传输或两台交换机对端接口的PVID一致时不包含VLAN ID

**VLAN链路类型**

| 类型 | 备注 |
| :-: | :-- |
| Access Link 接入链路 | 用于连接主机和交换机的链路<br />接入链路上传输的帧都是UnTagged帧 |
| Trunk Link 干道/中继链路 | 用于交换机间的互连或交换机与路由器之间的链路<br />干道链路上传输的帧几乎都是TagGed帧用于两端识别 |

干道链路上传输的帧几乎都是TagGed帧，只有一种情况例外，就是PVID端口

**PVID**：即Port VLAN ID，代表端口的缺省VLAN，交换机的默认PVID基本上都是1

**VLAN端口类型**

| 类型 | 备注 |
| :-: | :-- |
| Access接入端口 | 用于连接主机，收到数据后会添加VLAN Tag，VLAN ID和端口的PVID相同，转发数据前会移除VLAN Tag<br />Access类型一般是用于连接主机，正常情况下主机只会发送UT（UnTagged）帧，但Access并不是只能接收UT帧，它也能够接收TG（TagGed）帧，但收到数据帧时，交换机会根据自身Access端口的PVID，将主机的TG帧中的VLAN ID修改为自身Access端口的PVID。假设主机发送了一个VLAN ID为20的TG帧，而交换机Access端口PVID是10，那么在收到主机TG帧后就会将主机TG帧的VLAN ID改为10<br />**Access端口能够接收TG或UT帧，并根据端口PVID对VLAN ID做出修改，但它只能发送UT帧** |
| Trunk干道端口 | 用于连接交换机或路由器<br />收到帧时<br />- 如果该帧不包含Tag，将打上接收数据帧的端口的PVID<br />- 如果该帧包含Tag，则不改变<br />发送帧时，该帧的VLAN ID需要在Trunk的允许发送列表中。华为交换机端口设置trunk类型后默认仅允许VLAN ID 1，思科默认允许所有<br />- 若与端口的PVID相同时，则剥离Tag发送，PVID与Trunk的VLAN ID放行列表不是同一个东西<br />- 若与端口的PVID不同时，则直接发送 |
| Hybrid混杂端口 | 既可以连接主机，又可以连接其他交换机。既可以连接接入链路又可以连接干道链路。允许多个VLAN的帧通过，并可以**在出接口方向**将某些VLAN的Tag剥掉（由命令决定） |

### VLAN配置

| 命令 | 备注 |
| :-: | :-- |
| vlan 10 | 创建单个vlan |
| vlan batch 10 to 20 | 创建多个vlan |
| port link-type access/trunk/hybrid | 配置接口类型 |
| port default vlan 10 | 配置Access关联VLAN/PVID |
| port trunk allow-pass vlan 10 | 配置Trunk允许的vlan列表，默认仅允许vlan 1 |
| port trunk pvid vlan 10 | 配置Trunk的PVID |
| port hybrid tagged/untagged vlan 10 | 配置hybrid的标记vlan |
| port hybrid pvid vlan 10 | 配置hybrid的PVID |
| display vlan | 验证 vlan |
| display port vlan | 验证vlan |

在端口下切换vlan接口类型是可以随意切换的，但是一旦在某个vlan接口类型下配置了子命令，那就要先删除子命令后才能切换其他的vlan接口类型

### VLAN基础实验

