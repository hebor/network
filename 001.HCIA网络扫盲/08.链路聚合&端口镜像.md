# 链路聚合

以太网链路聚合通过多个物理接口捆绑成一个逻辑接口，在不进行硬件升级的条件下，实现带宽汇聚和热备份。从理念上来说链路聚合可以实现负载均衡，在配置链路聚合时，缺省情况下它是基于源IP、目标IP进行负载均衡的，但同时，缺省情况下的链路聚合基于二层转发，这意味着它根本不会识别三层IP，所以实际上它只会将一条链路跑满之后才会使用其他链路。二层链路聚合通过修改基于源MAC、目标MAC负载即可

## 链路聚合的基本概念

- 聚合组（Linkzgregation Group，LAG）：若干条链路捆绑在一起所形成的的逻辑链路。每个聚合组唯一对应着一个逻辑接口，这个逻辑接口又被称为链路聚合接口或Eth-Trunk接口

- 成员接口和成员链路：组成Eth-Trunk接口的各个物理接口称为成员接口，成员接口对应的链路称为成员链路
- 活动接口和活动链路：活动接口又叫选中（Selected）接口，是参与数据转发的成员接口。活动接口对应的链路被称为活动链路（Active link）
- 非活动接口和非活动链路：又叫非选中（Unselected）接口，是不参与转发数据的成员接口。非活动接口对应的链路被称为非活动链路（Inactive link）
- 聚合模式：根据是否开启LACP（Link Aggregation Control Protocol，链路聚合控制协议），链路聚合可以分为静态模式和LACP模式
- 其他概念：活动接口上限阈值和活动接口下限阈值

### 静态模式

静态模式一般出现在一些老旧、低端设备上，其不支持LACP协议，*静态模式下Eth-Trunk的建立、成员接口的加入均由手动配置，双方系统之间不使用LACP进行协商*。正常情况下所有链路都是活动链路，该模式下所有活动链路都参与数据的转发，平均分担流量，如果某条活动链路故障，链路聚合组自动在剩余的活动链路中平均分担流量。当聚合的两端设备中存在一个不支持LACP协议时，可以使用手工模式

**静态模式缺陷**

- 为了使链路聚合接口正常工作，必须保证本端链路聚合接口中所有成员接口的对端接口都 *属于同一设备的同一链路聚合接口*
- 静态模式下，设备间没有报文交互，因此只能通过管理员人工确认
- 静态模式下，设备只能通过物理层状态判断对端接口是否正常工作，静态模式下无法判断成员端口的逻辑状态是否正常（能否正常转发报文）

### LACP模式

LACP模式是采用LACP协议的一种链路聚合模式。设备间通过链路聚合控制协议数据单元（Link Aggregation Control Protocol Data Unit，LACPDU）进行交互，通过协议协商确保对端是同一台设备、同一个聚合接口的成员接口。同时LACPDU报文中包含设备优先级、MAC地址、接口优先级、接口号等信息，在LACP模式下聚合链路上会产生LACPDU报文交互

**系统优先级**

LACP模式下，两端设备所选择的活动接口数目必须保持一致，否则链路聚合组就无法建立。此时
可以使其中一端成为主动端，另一端（被动端）根据主动端选择活动接口。通过 *系统LACP优先级* 确定主动端，系统LACP优先级默认32768，越小越优先，通常保持默认。当优先级一致时LACP会通过比较MAC地址选择主动端，MAC地址越小越优先

**接口优先级**

选出主动端后，两端都会以主动端的接口优先级来选择活动接口，优先级高的接口将优先被选为活动接口。接口LACP优先级默认32768，越小越优先，通常保持默认，当优先级一致时，LACP会通过接口编号选择活动接口，越小越优先

**最大活动接口数**

LACP模式支持配置最大活动接口数目，当成员接口数目超过最大活动接口数目时会通过比较接口优先级、接口号，选举出较优的接口成为活动接口，其余的则成为备份端口（非活动接口），同时对应的链路分别成为活动链路、非活动链路，交换机只会从活动接口中发送、接收报文。华为设备默认支持的最大活动接口数是8个

当活动链路中出现链路故障时，可以从非活动链路中找出一条优先级最高（接口优先级、接口编号比较）的链路替换故障链路，实现总体带宽不发生变化、业务的不间断转发

**活动链路选举**

1. 通过LACPDU报文选举出优先级较高的交换机，作为LACP协商过程的主动端
2. 主动端通过比较接口优先级、接口编号选举出活动接口
3. 主动端通过LACPDU报文将本端活动端口选举结果发送给对端
4. 对端交换机根据主动端的接口选举结果，明确自身的活动端口，同时对应的链路成为活动链路

### 负载均衡

**基于包的负载均衡**

在使用Eth-Trunk转发数据时，由于聚合组两端设备之间有多条物理链路，如果每个数据帧在不同的链路上转发，则有可能导致数据帧到达对端时间不一致，从而引起数据乱序

**基于流的负载均衡**

Eth-Trunk推荐采用逐流负载分担的方式，即一条相同的流负载到一条链路，这样既保证了同一数据流的数据帧在同一条物理链路转发，又实现了流量在聚合组内各物理链路上的负载分担

**负载分担模式**

Eth-trunk支持基于报文的IP地址或MAC地址来进行负载分担，可以配置不同的模式（本地有效，对出方向报文生效）将数据流分担到不同的成员接口上

常见的模式有：源IP、源MAC、目的IP、目的MAC、源目IP、源目MAC

实际业务中用户需要根据业务流量特征选择配置合适的负载分担方式。业务流量中某种参数变化越频繁，选择与此参数相关的负载分担方式就越容易实现负载均衡

### 链路聚合配置

链路聚合配置需要注意，物理口成员与聚合口的端口配置参数必须保持完全一致，否则验证聚合口状态时会看到物理口成员处于未被选中状态（Unselected Ports），这代表物理端口未正常工作。物理口成员与聚合口的端口配置不区分先后顺序，但仍建议在聚合口下配置参数，因为聚合口的配置参数会自动下发到所有物理口成员的端口配置上；如果先配置了物理口，则将物理口的配置复制到聚合口后，端口仍能正常工作

配置链路聚合时，聚合口也有二层（bridge）和三层（route）之分，创建bridge聚合口时，对应的物理口子成员的链路模式也必须是bridge，否则物理口成员无法加入聚合口；验证聚合端口时，物理端口必须是选中状态（Selected Ports）才是正常工作的

| 命令 | 说明 |
| :-- | :-- |
| interface Bridge-Aggregation 1 | 创建二层聚合口 |
| interface range GE1/0/1 to GE1/0/2 <br /> port link-aggregation group 1 |  <br /> 将物理端口加入聚合口 |
| display link-aggregation summary | 验证聚合口 |

# 端口镜像

端口镜像技术在不影响报文的正常处理流程的前提下，将镜像端口的报文复制一份到观察端口，管理员能够利用数据监控设备来分析复制到观察端口的报文，进行网络监控和故障排除。在网络维护的过程中需要对报文进行获取分析时，通过端口镜像技术可以实现不影响报文转发的前提下对报文进行获取和分析

端口镜像以采集器的距离作为对照，将端口镜像配置分为 *本地端口镜像* 和 *远端端口镜像* 配置，本地端口镜像代表着采集器与采集对象连接在同一个交换机上，远端端口镜像表示采集器与采集对象不直连在同一个交换机上，两者直接可能间隔N个网络设备，远端端口镜像的采集流量通过网络单播的方式传播到采集器

**本地端口镜像配置**

```topology
<PC1>-----------<AR1>------------<ISP>
                  |
                  |
                <PC2>
```

```VRP
observe-port interface G0/0/1	#指定观察端口
interface g0/0/2
mirror to observe-port inbound	#将G0/0/2端口的入站流量镜像复制到观察端口
interface g0/0/3
mirror to observe-port both		#将G0/0/3端口的所有流量镜像复制到观察端口
```

```Comware
mirror-group 1 local	#创建一个本地镜像组
mirror-group 1 mirroring-port g0/0/1 both	#指定镜像端口
mirror-group 1 monitor-port g0/0/2	#指定观察端口
```

**远端端口镜像（MQC，模块化QoS命令行）**

```VRP
observe-port interface g0/0/1
acl number 2000
rule 5 permit source 192.168.1.10 0
traffic classifier c1 operator or
if-match acl 2000
traffic behavior b1
mirror to observe-port
traffic policy p1
classifier c1 behavior b1
interface g0/0/2
traffic-policy p1 inbound
```

端口镜像还支持通过vlan的方式实现，网络设备支持的镜像端口组一般存在数量限制，当网络中存在多个需要使用镜像端口技术的安全设备时，可能会出现需要使用的镜像端口组数量超过网络设备限制的情况，通过两种方式可以解决这个问题：分流器、Vlan镜像端口组

分流器属于硬件设备，最简单的傻瓜式分流器也能够实现基本的镜像分流，既能够解决网络设备镜像组限制问题，又能够满足安全设备的使用需求，问题是需要资金费用；Vlan镜像组将多个端口划分在镜像Vlan下，镜像组源端口的流量会转发到镜像Vlan，从而实现镜像Vlan下的所有端口都能收到镜像流量，使用Vlan镜像组的方式则必须保证该镜像Vlan号不能被放通在Trunk口下，仅因为这一个条件都非常容易导致Vlan镜像组的方式出现问题，网络管理源的一个小疏忽就可能导致该镜像Vlan被放在Trunk口下

# 交换机端口安全技术

端口安全技术在此处仅做了解，在SE阶段做具体学习

## 802.1X基本原理及配置

802.1X协议起源于标准的无线局域网协议802.11，主要目的是为了解决局域网用户的接入认证问题。用户终端接入交换机端口后，需要先通过客户端软件输入账号密码，认证成功后才能与交换机上的局域网通信

802.1X分为*本地认证* 和*远程集中认证* 两种方式，本地认证一般指交换机内置本地服务器对客户端进行认证，远程认证是由远程的认证服务器对客户端进行认证

**端口接入控制方式**

- 基于端口的认证方式：交换机的某端口下无论接入单个或多个终端，只要有一个终端通过接入认证，其他所有终端都能够通过交换机的该端口接入局域网
- 基于MAC的认证方式：相比较基于端口认证的方式更加细致，基于MAC认证的方式，交换机会为每个MAC维护一个独立的认证状态

**802.1X基本配置**

```Topology
<Host>-------------<SW>
```

此实验需要连接windows虚拟网卡，需要windows使用iNode工具连接认证

```Comware
<H3C>system-view
[H3C]sysname SW1
[SW1]dot1x    #开启全局802.1X特性
[SW1]vlan 100
[SW1-vlan100]port g1/0/1
[SW1-vlan100]interface vlan 100
[SW1-Vlan-interface100]ip address 10.0.0.1 24
[SW1-Vlan-interface100]interface g1/0/1
[SW1-GigabitEthernet1/0/1]dot1x    #开启端口802.1X特性
[SW1-GigabitEthernet1/0/1]interface loopback 0
[SW1-LoopBack0]ip address 172.17.255.1 24
[SW1-LoopBack0]local-user hebor class network    #添加本地接入用户并设置相关参数
[SW1-luser-network-hebor]service-type lan-access
[SW1-luser-network-hebor]password simple Admin@huawei.com
```

实验因未知原因未成功，iNode连接不上

## 端口隔离技术及配置

端口隔离用于在VLAN内隔离以太网端口，可能会用于一些特殊需求，正常情况端口在不同VLAN下即可隔离广播域

```Comware
port-isolate group 1    #创建隔离组
port-isolate enable group 1    #将指定端口加入到隔离组中，端口成为隔离组的普通端口
```

同一个隔离组内的端口不能够互通