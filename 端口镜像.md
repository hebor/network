# 端口镜像

端口镜像技术在不影响报文的正常处理流程的前提下，将镜像端口的报文复制一份到观察端口，管理员能够利用数据监控设备来分析复制到观察端口的报文，进行网络监控和故障排除。在网络维护的过程中需要对报文进行获取分析时，通过端口镜像技术可以实现不影响报文转发的前提下对报文进行获取和分析

端口镜像以采集器的距离作为对照，将端口镜像配置分为 *本地端口镜像* 和 *远端端口镜像* 配置，本地端口镜像代表着采集器与采集对象连接在同一个交换机上，远端端口镜像表示采集器与采集对象不直连在同一个交换机上，两者直接可能间隔N个网络设备，远端端口镜像的采集流量通过网络单播的方式传播到采集器

**本地端口镜像配置**

```topology
<PC1>-----------<AR1>------------<ISP>
                  |
                  |
                <PC2>
```

```VRP
observe-port interface G0/0/1	#指定观察端口
interface g0/0/2
mirror to observe-port inbound	#将G0/0/2端口的入站流量镜像复制到观察端口
interface g0/0/3
mirror to observe-port both		#将G0/0/3端口的所有流量镜像复制到观察端口
```

```Comware
mirror-group 1 local	#创建一个本地镜像组
mirror-group 1 mirroring-port g0/0/1 both	#指定镜像端口
mirror-group 1 monitor-port g0/0/2	#指定观察端口
```



**远端端口镜像（MQC，模块化QoS命令行）**

```VRP
observe-port interface g0/0/1
acl number 2000
rule 5 permit source 192.168.1.10 0
traffic classifier c1 operator or
if-match acl 2000
traffic behavior b1
mirror to observe-port
traffic policy p1
classifier c1 behavior b1
interface g0/0/2
traffic-policy p1 inbound
```

端口镜像还支持通过vlan的方式实现，网络设备支持的镜像端口组一般存在数量限制，当网络中存在多个需要使用镜像端口技术的安全设备时，可能会出现需要使用的镜像端口组数量超过网络设备限制的情况，通过两种方式可以解决这个问题：分流器、Vlan镜像端口组

分流器属于硬件设备，最简单的傻瓜式分流器也能够实现基本的镜像分流，既能够解决网络设备镜像组限制问题，又能够满足安全设备的使用需求，问题是需要资金费用；Vlan镜像组将多个端口划分在镜像Vlan下，镜像组源端口的流量会转发到镜像Vlan，从而实现镜像Vlan下的所有端口都能收到镜像流量，使用Vlan镜像组的方式则必须保证该镜像Vlan号不能被放通在Trunk口下，仅因为这一个条件都非常容易导致Vlan镜像组的方式出现问题，网络管理源的一个小疏忽就可能导致该镜像Vlan被放在Trunk口下
