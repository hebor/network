# STP

为了提高网络可靠性，交换网络中通常会使用冗余链路。然而，冗余链路会给交换网络带来环路风险，并导致广播风暴以及MAC地址表不稳定等问题，影响到用户的通信质量。生成树协议STP（Spanning Tree Protocol）可以在提供可靠性的同时避免环路带来的各种问题

所有厂商的设备默认都是开启STP的，可管理交换机之间通过STP能够避免环路，但下层非网管交换机之间产生环路仍会不可避免的带来广播风暴

**环路产生的问题**

- **广播风暴**：交换机收到广播包的处理方式是泛洪，一旦交换网络中产生环路，广播包转发就停不下来了，网络中的主机会受到重复的数据帧
- **MAC地址表震荡**：交换机会学习数据帧里的源MAC并与端口绑定，产生广播风暴后，交换机的多个端口可能会收到同一个源MAC的广播包，根据交换机端口的Update原理，一个源MAC可能会在多个端口上反复变动

**STP提供两大功能**

- **消除环路**：逻辑上阻断冗余链路来消除网络中可能存在的环路
- **链路备份**：当活动路径发生故障时，激活备用链路，及时回复网络连通性

## STP选举

STP协议逻辑上通过构造一棵二叉树来消除交换网络中的环路，由于STP协议开发较早，早期的交换机又叫网桥，所以STP的名词多以桥指代交换机，*整个STP的比较值都是越小越优先*

在了解STP选举过程之前，先要对STP涉及到的一些名词有一些理解

| 名词 | 作用 |
|:-- | :-- |
| BID（Bridge ID） | 桥ID用于在STP中唯一标识一个交换机，由两部分组成：桥优先级.桥MAC地址，优先级的取值范围在0~65535之间，缺省值是32768；在交换机的配置信息中对应字段是 CIST Bridge |
| PID（Port ID） | 端口ID用于在STP中唯一标识一个交换机上的端口，由两部分组成：端口优先级.端口编号，优先级取值范围在0~255之间，缺省值是128。STP的端口编号与交换机端口号没有固定关系，STP端口编号只是一个流水号，在交换机的配置信息中对应字段是CIST RootPortId |
| Root Path Cost（根路径开销） | 确定到达根桥的最短路径，并生成无环树状网络，到根桥的路径上所有路径开销之和就是根路径开销，与路由表相似，`Root Path Cost`字段只记录到达根桥的最短路径的开销 |

**BPDU包结构**

Bridge Protocol Data Unit，桥协议数据单元，是STP协议的数据包，STP协议分三种：STP、RSTP、MSTP，华为设备默认开启的是MSTP，BPDU数据包会发往组播MAC：01-90-C2-00-00-00。BPDU包含桥ID、路径开销、端口ID、计时器等参数

| 字段 | 备注 |
| :-- | :-- |
| PID(Protocol Identifier) | 固定值，无论是STP/RSTP/MSTP该字段都是STP |
| PVI(Protocol Version Identifier) | 分3个版本：ST(STP)/RST(RSTP)/MST(MSTP) |
| BPDU Type | 网络稳定情况下大多为Configuration类型，当网络拓扑发生改变时变更为TCN（Topology Change Notification）类型|
| BPDU Flags | BPDU标记字段有8个bit位，只不过STP仅使用首位和末位，MSTP是8位都使用；收到TCN类型的BPDU后，在标记字段中会产生TCA（Topology Change Acknowledgment）回复包 |
| Root ID(Root Identifier) | 此字段表示发送此配置BPDU包的交换机所认为的根交换机的标识 |
| RPC(Root Path Cost) | 从发送此配置BPDU包的交换机到根交换机的最短路径开销<br />含交换机根端口的开销，不含发送此配置BPDU包的端口的开销 |
| Bridge ID(Bridge Identifier) | 发送此配置BPDU包的交换机标识；如果Root ID与Bridge ID一致，说明该交换机自身就是根桥 |
| Port ID(Port Identifier) | 发送此配置BPDU包的交换机端口的端口标识 |
| Message Age | |
| Max Age | BPDU包老化时间，默认20s |
| Hello Time | BPDU包发送周期，默认2s |
| Fwd Delay | |

**BPDU类型**

- 配置BPDU：Configuration
	- 选举根交换机以及确定每个交换机端口的角色和状态
	- 在初始化过程中，每个桥都主动发送配置BPDU
	- 在网络拓扑稳定后，只有根桥主动发送BPDU，其他交换机在收到上游传来的配置BPDU后才会发送自己的配置BPDU
	- 发送周期为Hello Time
	- 老化时间为Max Age
- 拓扑变更通告BPDU：TCN BPDU
	- 下游交换机感知到拓扑发生变化时向上游发送拓扑变化通知

**Path Cost（路径开销）**

路径开销用于衡量桥与桥之间路径的优劣，越低越好，STP中每条链路都具有开销值，开销值的计算方式有多个版本，802.1t是华为交换机默认的算法，通过链路捆绑技术也可以降低端口的开销值

| 链路速率 | 端口状态 | 802.1D-1998 | 802.1t |
| :-: | :-: | :-: | :-: |
| 100Mbps | Single Port<br />Aggregated Link 2 Ports<br />Aggregated Link 3 Ports<br />Aggregated Link 4 Ports | 19<br />19<br />19<br />19 | 200,000<br />100,000<br />66,666<br />50,000 |
| 1000Mbps | Single Port<br />Aggregated Link 2 Ports<br />Aggregated Link 3 Ports<br />Aggregated Link 4 Ports | 4<br />4<br />4<br />4 | 20,000<br />10,000<br />6,666<br />5,000 |
| 10Gbps | Single Port<br />Aggregated Link 2 Ports<br />Aggregated Link 3 Ports<br />Aggregated Link 4 Ports | 2<br />2<br />2<br />2 | 2,000<br />1,000<br />666<br />5,00 |

### STP选举过程

1. **选举根桥**

  在STP只有两种身份，根网桥和非根网桥，根网桥的作用就是控制整个网络的稳定和维护，根网桥的选举会依次比较BID的优先级和MAC，越小越优先。每一台交换机启动STP时都会认为自己就是根桥

2. **选举根端口（RP）**

  - 在非根交换机选举一个根端口，非根交换机通过根端口接收来自根桥的消息，每一个非根交换机有且仅有一个根端口。非根交换机在选举根端口时分别依次比较该端口的根路径开销、对端BID、对端PID和本端PID

  - 该端口的根路径开销：每个交换机的端口有固定开销值，根桥会将自身端口开销值标记为0，非根交换机从某个端口收到根桥得BPDU后，会在BPDU的开销值字段加上自身该端口的开销值，这个累加后的开销值也就代表着该端口到根桥的开销。比较根路径开销实际上就是比较从各个端口收到的BPDU后，那个端口的开销值最小，开销值越小意味着BPDU经过的中间设备越少

  - 对端BID：直连根桥的非根交换机的对端BID都是根桥，是相同的BID；没有直连根桥的非根交换机需要比较的对端BID，就是不同上联非根交换机的BID了

  - 对端PID：两台交换机通过两根线直接互联的场景可能需要比较对端PID

3. **选举指定端口（DP）**

  - 交换机选举指定端口用于发送来自根网桥的消息，*每一条链路有且仅有一个指定端口*，选举指定端口时依次比较根路径开销、本端BID、本端PID

  - 根路径开销：DP的根路径开销指的是，从RP接收到的BPDU，添加上非根交换机本身的RP端口的开销值后，会从其他端口转发出去，此时各个非根交换机互联的链路上会对比双方的BPDU的开销值，非RP转发出来的BPDU的开销值越小的端口成为指定端口

  一般情况下根桥上所有端口都是指定端口，因为根桥的端口开销值都是0，除非根桥自环，如果根桥上产生自环，那必然有一个端口是阻塞端口

4. **堵塞无身份端口**

   未被选举未根端口或指定端口的剩余端口被认为是预备端口，将会被逻辑堵塞

DP与RP的根路径开销的比较对象不一样，根路径开销指的是从根桥发出，直到到达非根交换机端口，这个过程中所经过的所有链路的开销总和，非根交换机上可能有多个端口能够到达根桥；RP的比较对象就是同一个非根交换机上的多个端口，比较根桥到达各个端口的开销值大小；DP的对比对象是不同非根交换机之间互联的一对端口，比较双方互联端口的开销值大小

