**手动建立邻居**

OSPF默认使用组播网络建立邻居关系，但有些网络环境下并不支持组播，对于不支持组播的网络，OSPF也支持通过单播方式建立邻居关系，需要手动配置实现邻居的发现与维护

```VRP
ospf 1
peer 2.2.2.2
```

**OSPF多区域的优势**

将所有的OSPF网络都放在单区域内可能会引起以下问题

- 收到LSA通告增多，OSPF路由器的负担增大，资源消耗过多，LSDB庞大，设备性能下降，影响数据转发
- 内部动荡会引起全网路由器的完全SPF计算
- 每台路由器都需要维护的路由表越来越大，**单区域内路由无法汇总**

为了优化单区域OSPF引起的这些问题，一般会将大型网络分隔为多个较小的、可管理的区域，优化的好处分为几点

- 减少LSA洪泛的范围，有效地把拓扑变化控制在区域内，达到网络优化的目的
- 在区域边界可以做路由汇总，减小路由表
- 充分利用OSPF特殊区域的特性，进一步减少LSA泛洪，从而优化路由
- 多区域提高了网络的扩展性，有利于组建大规模的网络

**验证命令**

| 命令 | 备注 |
| :-- | :-- |
| display ospf peer | 查看ospf邻居 |
| display ospf interface | 查看ospf接口 |
| display ospf routing | 查看ospf路由表 |
| display ospf abr-asbr | 查看ABR和ASBR |
| display ospf lsdb | 查看LSDB |

**流量工程**

OSPF的度量计算是通过带宽计算，接口cost=参考带宽(10^8)/实际带宽，

**网络类型**

NBMA

- 两台或两台以上路由器通过VC（虚链路）互连
- 不支持广播、组播

![NBMA网络](https://www.helloimg.com/images/2023/10/06/oH8Vwn.png)

OSPF默认的Hello包是通过组播发送的，NBMA网络由于不支持组播，所以在BNMA网络中路由器之间收不到Hello包，也无法建立OSPF邻居，需要通过单播的方式配置

NBMA也叫全连接的帧中继网络，通过帧中继交换机连接各个路由器，各个设备都使用串口互联，在NBMA网络中路由器和帧中继交换机互联的端口和链路与专线技术相似，由于帧中继网络应用在广域网环境中，网络规模大，设备的端口无法满足应用需求，所以全连接的帧中继网络通过VC的方式实现各个节点之间的连接

VC实现了在一个物理端口下，虚拟出多个信道，每个信道就类似一条专线，每个信道也就类似于一个点到点连接。但既然是一个物理端口虚拟出了多个信道，也就意味着一个端口可能会与多个节点互联，此时也就需要一个唯一标识，来确认一个虚拟信道是哪一个点到点连接，这个标识就是DLCI

简单点看，DLCI的作用也类似MAC，都用于标识设备节点。所有的DLCI都需要在帧中继交换机里配置，然后再到路由器端口做映射



P2MP

- 多个点到点网络的集合
- 支持广播、组播

P2MP也叫非完全连接的帧中继网络，它与NBMA网络的区别就在于，P2MP网络环境中只有一台路由器节点能够到任意节点，其他节点之间的互联都需要通过这台路由器节点转接

![P2MP网络](https://www.helloimg.com/images/2023/10/06/oH8YhR.png)

**帧中继拓扑**


以太网交换机在网络环境中无需配置也能满足各个路由器节点间的通信，它对于通信来说是透明的，但FR交换机在不做映射的前提下，路由器节点是无法通信的；帧中继网络的路由器配置有2种方式，路由器仅需在端口配置IP，通过设置FR交换机的映射关系后，路由器会自动学习FR交换机的映射关系

```VRP
#--------------------------AR1-----------------------
<Huawei>sys
[Huawei]sys AR1
[AR1]inte s4/0/0
[AR1-Serial4/0/0]ip add 123.0.0.1 24
[AR1-Serial4/0/0]link-pro fr	#未修改连接协议前，端口协议状态是down的

#--------------------------AR2-----------------------
<Huawei>sys
[Huawei]sys AR2
[AR2]inte s4/0/0
[AR2-Serial4/0/0]ip add 123.0.0.2 24
[AR2-Serial4/0/0]link-pro fr

#--------------------------AR3-----------------------
<Huawei>sys
[Huawei]sys AR3
[AR3]inte s4/0/0
[AR3-Serial4/0/0]ip add 123.0.0.3 24
[AR3-Serial4/0/0]link-pro fr
```

手动配置端口映射

```VRP
#--------------------------AR1-----------------------
[AR1]inte s4/0/0
[AR1-Serial4/0/0]fr map ip 123.0.0.2 102 broadcast	#指定去往指定IP需要通过哪个DLCI。broadcast可选，标识开启广播和组播
[AR1-Serial4/0/0]fr map ip 123.0.0.3 103 broadcast
[AR1-Serial4/0/0]undo fr inarp	#此命令可选
[AR1]dis fr map-info

#--------------------------AR2-----------------------
[AR2]inte s4/0/0
[AR2-Serial4/0/0]undo fr inarp
[AR2-Serial4/0/0] fr map ip 123.0.0.1 201 broadcast
[AR2-Serial4/0/0] fr map ip 123.0.0.3 203 broadcast

#--------------------------AR3-----------------------
[AR3]inte s4/0/0
[AR3-Serial4/0/0]undo fr inarp
[AR3-Serial4/0/0] fr map ip 123.0.0.1 301 broadcast
[AR3-Serial4/0/0] fr map ip 123.0.0.2 302 broadcast
```

运行ospf进程后正常情况下是查不到任何邻居的，通过抓包也看不到任何Hello包，执行peer命令后手动指定邻居，会进入OSPF的第8种状态Attempt，此时执行了peer命令的路由器会持续尝试唤醒对应IP的OSPF路由器

```VRP
#--------------------------AR1-----------------------
[AR1]ospf 1 
[AR1-ospf-1]a 0
[AR1-ospf-1]peer 123.0.0.2
[AR1-ospf-1-area-0.0.0.0]net 123.0.0.0 0.0.0.255
[AR1-ospf-1-area-0.0.0.0]inte s4/0/0
[AR1-Serial4/0/0]ospf network-type p2mp		#修改ospf端口网络类型
```

单个路由器端口修改网络类型后，OSPF仍能保持full状态，这是因为即便只有单边端口修改了网络类型，它仍满足OSPF建立邻居的条件

**网络类型相关命令**

| 命令 | 备注 |
| :-- | :-- |
| ospf network-type<br />- broadcast<br />- nbma<br />- p2mp<br />- p2p | 配置接口OSPF网络类型<br />环回口无论配置或声明多少位掩码，在OSPF路由表中最终都会以32位掩码路由展示，因为OSPF认为环回口只有一个地址，因此传递时自动修改为32为主机路由，通过修改环回口的网络类型为Broadcast可以进行还原 |
| peer x.x.x.x | 手动指定邻居 |
| ospf dr-priority 100 | 配置接口优先级，默认为1；只有Broadcast和NBMA接口会选举DR和BDR |

**虚链路**

