# OSPF路由汇总

当网络规模达到一定程度就需要关注网络的优化，对于OSPF而言精简LSA就是精简LSDB，精简LSDB就是精简路由表。将路由表中的多条明细路由汇总为一条路由，从而减少路由表条目，提供性能或扩展性。OSPF的汇总只能在ABR或ASBR配置，因为Router LSA和Network LSA就是为了让单区域内所有OSPF路由器学习到区域内的所有链路状态，因此单区域内的OSPF路由无法汇总，只有区域外路由或外部路由才能汇总，也就是说只有3类LSA、5类LSA才存在汇总的概念

3类LSA的汇总是哪个区域的路由需要汇总，就需要在ABR的对应区域内执行汇总命令。例如需要汇总Area 0的多条路由泛洪到Area 1，就需要ABR在Area 0执行路由汇总命令；5类LSA的汇总则不需要进入区域，因为其不属于任何一个区域，直接在ASBR的OSPF进程下执行汇总命令即可。将多条路由汇总之前，各个路由可能具备各自不同的开销，默认汇总后以单条路由中开销最大的为汇总路由的开销，如果在执行汇总命令时又手动指定了汇总路由的开销，则以指定的开销值为准

| 命令 | 说明 |
| :-- | :-- |
| abr-summary 100.1.0.0 255.255.252.0 <br /> - advertise: 发布汇聚后路由，默认参数 <br /> - not-advertise: 不发布汇聚路由 <br /> - cost: 配置开销 | ABR汇总区域间路由 |
| asbr-summary 100.1.0.0 255.255.252.0 | ASBR汇总外部路由 |

not-advertise参数设计比较巧妙，汇总命令本身是将多条路由汇聚为一条路由，而not-advertise参数不向外发送这条汇聚路由，这代表着路由器本身就将汇聚路由下的几条路由全部屏蔽了，不向外发送

**汇总规则**

- 3类LSA的汇总：只能把区域内的1类、2类LSA转换为3类LSA时做汇总，即将区域内路由转换为区域间路由时做汇总。不可以把原本就是区域间的路由做汇总，即不可以将区域内的原本就是3类的LSA进行汇总
- 5类LSA的汇总：5类LSA的汇总只能在产生该LSA的ASBR上配置，即对自己产生的5类路由汇总。对其他路由器产生的5类LSA，没有汇总能力

> **OSPF路由汇总的实验仍使用上一节的选路的拓扑和基本配置，此处不再重复**

## Network-Summary LSA汇总

由于拓扑问题需要通过Vlink实现整网路由泛洪，在AR2与AR4之间建立Vlink。在AR1上新增4个loopback端口，使用network宣告进OSPF进程。AR2通过Area 2的1类、2类LSA能够学习到AR1上的4条`100.1.0.0/22`路由，同时AR2作为ABR也会将其转换为3类LSA泛洪到Area1、Area0，此时在AR2上就能够对从Area 2转变的3类LSA进行汇总。在执行路由汇总前、后分别查看AR4的路由表即可观察到汇总执行的成效

```yaml
[Router_2]ospf 1
[Router_2-ospf-1]area 1
[Router_2-ospf-1-area-0.0.0.1]vlink-peer 4.4.4.4



[Router_4]ospf 1
[Router_4-ospf-1]area 1
[Router_4-ospf-1-area-0.0.0.1]vlink-peer 2.2.2.2
[Router_4-ospf-1-area-0.0.0.1]dis ospf 1 vlink

	 OSPF Process 1 with Router ID 4.4.4.4
		 Virtual Links 

 Virtual-link Neighbor-id  -> 2.2.2.2, Neighbor-State: Full

 Interface: 1.1.24.4 (Serial1/0/0)
 Cost: 48  State: P-2-P  Type: Virtual 
 Transit Area: 0.0.0.1 
 Timers: Hello 10 , Dead 40 , Retransmit 5 , Transmit Delay 1 
 GR State: Normal 



[Router_1]interface loopback 1
[Router_1-LoopBack1]ip address 100.1.0.1 255.255.255.0
[Router_1-LoopBack1]ospf network-type broadcast
[Router_1-LoopBack1]interface loopback 2
[Router_1-LoopBack2]ip address 100.1.1.1 255.255.255.0
[Router_1-LoopBack2]ospf network-type broadcast
[Router_1-LoopBack2]interface loopback 3
[Router_1-LoopBack3]ip address 100.1.2.1 255.255.255.0
[Router_1-LoopBack3]ospf network-type broadcast
[Router_1-LoopBack3]interface loopback 4
[Router_1-LoopBack4]ip address 100.1.3.1 255.255.255.0
[Router_1-LoopBack4]ospf network-type broadcast
[Router_1-LoopBack4]ospf 1
[Router_1-ospf-1]area 2
[Router_1-ospf-1-area-0.0.0.2]network 100.1.0.0 0.0.3.255



[Router_2]ospf 1
[Router_2-ospf-1]area 2    //需要将Area 2的路由汇总后转发到其他区域，因此在Area 2下执行汇总命令
[Router_2-ospf-1-area-0.0.0.2]abr-summary 100.1.0.0 255.255.252.0
```

根据3类LSA的汇总规则，可以进行汇总的3类LSA只有区域内1类、2类转换成的3类LSA，区域内原本的3类LSA无法进行汇总。将AR1上的4条`100.1.0.0/22`路由分别拆分到AR4、AR5上，再通过AR2进行汇总，查看AR1的路由表，AR4在Area 0区域宣告的1类、2类路由成功汇总、AR5在Area 5区域宣告的路由转为为3类LSA泛洪到Area 0无法汇总。通过AR2汇总是因为AR2存在Vlink，AR2是连接Area 2与Area 0的ABR

```yaml
[Router_1]undo interface loopback 1
[Router_1]undo interface loopback 2
[Router_1]undo interface loopback 3
[Router_1]undo interface loopback 4
[Router_1]ospf 1
[Router_1-ospf-1]area 2
[Router_1-ospf-1-area-0.0.0.2]undo network 100.1.0.0 0.0.3.255



[Router_2]ospf 1
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]undo abr-summary 100.1.0.0 255.255.252.0



[Router_4]interface loopback 1
[Router_4-LoopBack1]ip address 100.1.0.1 255.255.255.0
[Router_4-LoopBack1]ospf network-type broadcast
[Router_4-LoopBack1]interface loopback 2
[Router_4-LoopBack2]ip address 100.1.1.1 255.255.255.0
[Router_4-LoopBack2]ospf network-type broadcast
[Router_4-LoopBack2]ospf 1
[Router_4-ospf-1]area 0
[Router_4-ospf-1-area-0.0.0.0]network 100.1.0.0 0.0.3.255



[Router_5]interface loopback 1
[Router_5-LoopBack1]ip address 100.1.2.1 255.255.255.0
[Router_5-LoopBack1]ospf network-type broadcast
[Router_5-LoopBack1]interface loopback 2
[Router_5-LoopBack2]ip address 100.1.3.1 255.255.255.0
[Router_5-LoopBack2]ospf network-type broadcast
[Router_5-LoopBack2]ospf 1
[Router_5-ospf-1]area 5
[Router_5-ospf-1-area-0.0.0.5]network 100.1.0.0 0.0.3.255



[Router_2]display ip routing-table protocol ospf    //查看AR2的路由表，能够看到AR2学习到了AR4、AR5宣告的路由
[Router_2]ospf 1
[Router_2-ospf-1]area 0
[Router_2-ospf-1-area-0.0.0.0]abr-summary 100.1.0.0 255.255.252.0



[Router_1]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 10       Routes : 10       

OSPF routing table status : <Active>
         Destinations : 10       Routes : 10

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       1.1.24.0/24  OSPF    10   49          D   1.1.123.2       GigabitEthernet0/0/0
       1.1.34.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
       1.1.45.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.2.2/32  OSPF    10   1           D   1.1.123.2       GigabitEthernet0/0/0
      10.10.3.3/32  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.4.4/32  OSPF    10   49          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.5.5/32  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      100.1.0.0/22  OSPF    10   49          D   1.1.123.2       GigabitEthernet0/0/0
      100.1.2.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      100.1.3.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

执行路由汇总时应尽可能保证精确的汇总，模糊的路由汇总会导致其他网段的路由也被一起转交给汇总后的下一跳；路由汇总后传递给对端设备时，不会再向对端设备传递明细路由，如果对端设备只能从本端设备收到路由的话，那么对端设备的路由表中不会再产生明细路由

> **配置还原**
> 
> [Router_2]ospf 1 <br />
> [Router_2-ospf-1]area 0 <br />
> [Router_2-ospf-1-area-0.0.0.0]undo abr-summary 100.1.0.0 255.255.252.0 <br />
> 
> [Router_4]undo interface loopback 1 <br />
> [Router_4]undo interface loopback 2 <br />
> [Router_4]ospf 1 <br />
> [Router_4-ospf-1]area 0 <br />
> [Router_4-ospf-1-area-0.0.0.0]undo network 100.1.0.0 0.0.3.255 <br />
> 
> [Router_5]ospf 1 <br />
> [Router_5-ospf-1]area 5 <br />
> [Router_5-ospf-1-area-0.0.0.5]undo network 100.1.0.0 0.0.3.255 <br />
> [Router_5-ospf-1]undo area 5

## AS-External LSA汇总

在AR5上引入4条外部路由`100.1.0.0/22`，并在AR5上配置5类LSA汇总。外部路由只能在引入该路由的ASBR上配置汇总，在其他任意路由器上配置5类LSA的路由汇总都是不生效的

```yaml
[Router_5]interface loopback 3
[Router_5-LoopBack3]ip address 100.1.0.1 255.255.255.0
[Router_5-LoopBack3]ospf network-type broadcast
[Router_5-LoopBack3]interface loopback 4
[Router_5-LoopBack4]ip address 100.1.1.1 255.255.255.0
[Router_5-LoopBack4]ospf network-type broadcast
[Router_5-LoopBack4]route-policy policy_D permit node 10
[Router_5-route-policy]if-match interface loopback 1 loopback 2 loopback 3 loopback 4
[Router_5-route-policy]ospf 1
[Router_5-ospf-1]import-route direct route-policy policy_D




[Router_1]display ospf 1 lsdb 

		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  100.1.2.0       5.5.5.5             64  36    80000001       1
 External  100.1.3.0       5.5.5.5             64  36    80000001       1
 External  100.1.0.0       5.5.5.5             64  36    80000001       1
 External  100.1.1.0       5.5.5.5             64  36    80000001       1



[Router_5]ospf 1
[Router_5-ospf-1]asbr-summary 100.1.0.0 255.255.252.0



[Router_1]display ospf 1 lsdb

		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  100.1.0.0       5.5.5.5            487  36    80000002       2

[Router_1]display ip routing-table protocol ospf 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 8        Routes : 8        

OSPF routing table status : <Active>
         Destinations : 8        Routes : 8

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       1.1.24.0/24  OSPF    10   49          D   1.1.123.2       GigabitEthernet0/0/0
       1.1.34.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
       1.1.45.0/24  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.2.2/32  OSPF    10   1           D   1.1.123.2       GigabitEthernet0/0/0
      10.10.3.3/32  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.4.4/32  OSPF    10   49          D   1.1.123.2       GigabitEthernet0/0/0
      10.10.5.5/32  OSPF    10   97          D   1.1.123.2       GigabitEthernet0/0/0
      100.1.0.0/22  O_ASE   150  2           D   1.1.123.2       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

> **配置还原**
> 
> [Router_5]ospf 1 <br />
> [Router_5-ospf-1]undo asbr-summary 100.1.0.0 255.255.252.0 <br />
> [Router_5-ospf-1]undo import-route direct <br />
> [Router_5-ospf-1]quit <br />
> [Router_5]undo route-policy policy_D <br />
> [Router_5]undo interface loopback 1 <br />
> [Router_5]undo interface loopback 2 <br />
> [Router_5]undo interface loopback 3 <br />
> [Router_5]undo interface loopback 4

## OSPF的默认路由

假设AR5作为OSPF的边界路由器，一般情况下会在AR5上写一条默认路由通往互联网，对于OSPF网络内其他设备，可以在AR5上通告一条`0.0.0.0`的默认路由，用于处理OSPF网络内其他设备的上网问题

```yaml
[Router_5]ip route-static 0.0.0.0 0.0.0.0 10.10.5.254    //下一跳地址可修改，但需要注意，如果下一跳地址不可达，则路由不会写入路由表，也就不会泛洪到OSPF网络；10.10.5.254被判断为可达是因为AR5的loopback_0端口处理10.10.5.0/24网段
[Router_5]ospf 1
[Router_5-ospf-1]default-route-advertise                    //以5类LSA的方式向OSPF区域注入一条默认路由；使用此命令的前提是路由器本身路由表中必须存在一条默认路由

[Router_5-ospf-1]default-route-advertise always         //无条件以5类LSA的方式向OSPF区域注入一条默认路由；不要求路由器本身存在默认路由
```

一般情况下建议以有条件的方式在OSPF区域注入默认路由，无条件产生默认路由的方式，即便数据包到达了本路由器，也有可能会因为本路由器没有路由，而导致丢包

> **配置还原**
> 
> [Router_5]ospf 1 <br />
> [Router_5-ospf-1]undo default-route-advertise

# OSPF的特殊区域

OSPF的特殊区域是为了应对企业网的应用场景，企业网的特点之一是设备性能参差不齐，组网时将性能低的设备统一放置在一个区域中，对此区域进行“特殊的保护”，这就是特殊区域。特殊区域用于优化区域内的LSA泛洪，减少LSA数量，从而减少路由器上LSDB的规模和对内存的需求。路由汇总和特殊区域其实都是对OSPF网络的优化技术，只不过两者理念不同，路由汇总将多条路由汇聚为一条精简路由，特殊区域则是直接屏蔽路由

在OSPF常见的5类LSA中，Router-LSA和Network-LSA是无法避免的，但3类、4类、5类都是可以精简的，所以特殊区域的理念就是精简3类、4类、5类LSA。特殊区域针对于处于网络边界的OSPF区域，这些边界区域的路由器的下层已经没有其他节点了，那么这些边界区域的路由器自然就不那么需要完全学习所有路由，仅需一条缺省路由指向上层节点即可实现通信

| 特殊区域 | 说明 |
| :-: | :-- |
| Stub | 末节（末梢）区域，屏蔽 LSA 4/5 <br /> 区域内不能有ASBR，不能是区域0，不能有虚链路 <br /> 由ABR向该区域发送一条LSA 3的缺省路由 |
| Totally Stub | 完全末节（末梢）区域，屏蔽 LSA 3/4/5 <br /> 区域内不能有ASBR，不能是区域0，不能有虚链路 <br /> 只有ABR会向该区域发送一条LSA 3的缺省路由 |
| NSSA（Not-So-Stubby-Area） | 非完全的末节（末梢）区域，屏蔽 LSA4/5 <br /> 区域内允许有ASBR（打破了末节规则），因此为了传递外部路由，该区域内使用LSA 7代替LSA 5，到其他常规区域再转换成LSA5 <br /> 该区域ABR会发送一条LSA 7的缺省路由 |
| Totally NSSA | 完全的非完全的末节（末梢）区域，屏蔽 LSA3/4/5 <br /> 区域内允许有ASBR（打破了末节规则），因此为了传递外部路由，该区域内使用LSA 7代替LSA 5，到其他正常区域再转换成LSA5 <br /> 该区域ABR会发送一条LSA 3和LSA 7的缺省路由 |

以选路的拓扑为例，假设Area 2作为旧设备区域，在AR5上引入大量的外部路由时，5类LSA会整网泛洪，同时大量的5类LSA往往伴随着大量的4类LSA，此时需要将Area 2设置为特殊区域，以减少Area 2区域设备的负载

## Stub区域

在AR5上引入外部路由，在AR1上查看LSDB检验信息，正常情况下AR5引入的外部路由会在OSPF整网泛洪，因此AR1的LSDB也存在外部路由。将Area 2设置为Stub区域后，AR2和AR3就会自动阻止4类、5类LSA通告到自身连接在Area 2区域的端口，再查看AR1的LSDB就不会再产生4类、5类LSA

特殊区域是针对OSPF的区域的，而不仅是针对某个边界路由器节点，因此在配置特殊区域的时候，需要在所有连接到该区域的路由器的接口上配置特殊区域命令。以选路拓扑为例，如果要将Area 2设置为Stub区域，那就需要在AR1、AR2、AR3各自的Area 2区域配置为stub；根据OSPF建立邻居的条件，如果区域内的设备的区域类型不一致，则无法建立邻居关系。例如，如果AR3不在Area 2中配置为stub，则AR3无法与AR1、AR2建立OSPF邻居关系

```yaml
[Router_5]interface loopback 55
[Router_5-LoopBack55]ip address 55.5.5.5 255.255.255.0
[Router_5-LoopBack55]route-policy policy_E permit node 10
[Router_5-route-policy]if-match interface loopback 55
[Router_5-route-policy]ospf 1
[Router_5-ospf-1]import-route direct route-policy policy_E



[Router_1]dis ospf 1 lsdb

		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  55.5.5.0        5.5.5.5             44  36    80000001       1

[Router_1]ospf 1 
[Router_1-ospf-1]area 2
[Router_1-ospf-1-area-0.0.0.2]stub



[Router_2]ospf 1 
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]stub
```

如果设备上端口只连接到Stub区域，即Stub区域的IR，该设备自身无法再向OSPF进程中引入外部路由，例如AR1，引入命令是可执行的，但在LSDB中不会产生5类LSA；如果设备上不同端口连接多个区域，该设备自身能够产生5类LSA，只不过自身产生的5类LSA也不会向Stub区域通告，例如AR2

```yaml
[Router_1]interface loopback 11
[Router_1-LoopBack11]ip address 11.1.1.1 255.255.255.0
[Router_1-LoopBack11]route-policy policy_E permit node 10
[Router_1-route-policy]if-match interface loopback 11
[Router_1-route-policy]ospf 1
[Router_1-ospf-1]import-route direct route-policy policy_E
[Router_1-ospf-1]display ospf 1 lsdb
```

> **配置回退**
>
> [Router_1]ospf 1 <br />
> [Router_1-ospf-1]undo import-route direct <br />
> [Router_1-ospf-1]quit <br />
> [Router_1]undo route-policy policy_E

## Totally Stub区域

将Area 2配置为Stub区域后，在Stub区域中不再泛洪4类、5类LSA，但仍存在大量3类LSA，根据3类LSA的传递规则第4条，所有非Area 0区域的3类LSA都应该是从Area 0转换而来，即由ABR从Area 0宣告到非Area 0。连接Stub区域的ABR会向Stub区域发送一条3类的缺省路由，此时所有的3类LSA下一跳都是ABR，大量的明细3类LSA就显得多此一举，如果想将明细的3类LSA也一并屏蔽，这就是Totally Stub区域（T-Stub）

```yaml
[Router_2]ospf 1 
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]stub no-summary



<Router_1>dis ospf 1 lsdb 

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2             87  36    80000009       1
 Router    1.1.1.1         1.1.1.1             90  48    8000000C       0
 Router    3.3.3.3         3.3.3.3             87  36    80000009       1
 Network   1.1.123.1       1.1.1.1             90  36    80000004       0
 Sum-Net   0.0.0.0         2.2.2.2            525  28    80000001       1
```

Totally Stub区域与Stub区域的区域类型是一致的，因此T-Stub与Stub路由器能够正常建立邻居，两者唯一的区别就在于T-Stub区域会阻止泛洪3类明细LSA。T-Stub区域是为了阻止OSPF路由器向区域内泛洪3类明细LSA，根据3类LSA的传递规则，只有ABR才会向不同区域泛洪3类LSA，因此T-Stub区域的配置只需要在ABR上配置即可。T-Stub区域与Stub区域在配置上的区别就在于，Stub区域需要连接到该区域的所有路由器端口都配置stub，T-Stub区域则只需要基于Stub区域的配置，在ABR上追加配置no-summary即可

以Area 2为例，T-Stub区域的配置只需要在AR2上配置`stub no-summary`即可，因为只有AR2与AR4建立了Vlink，也就只有AR2是ABR，AR3本身就不是ABR，因此无需配置；如果在AR4与AR3之间也建立一条Vlink，AR3接入Area 0变更为ABR，由于AR3未配置T-Stub，则AR3会向AR1宣告明细的3类LSA

```yaml
[Router_4]ospf 1
[Router_4-ospf-1]area 1
[Router_4-ospf-1-area-0.0.0.1]vlink-peer 3.3.3.3



[Router_3]ospf 1 
[Router_3-ospf-1]area 1
[Router_3-ospf-1-area-0.0.0.1]vlink-peer 4.4.4.4



[Router_1]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 8        Routes : 9        

OSPF routing table status : <Active>
         Destinations : 8        Routes : 9

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   OSPF    10   2           D   1.1.123.2       GigabitEthernet0/0/0
                    OSPF    10   2           D   1.1.123.3       GigabitEthernet0/0/0
       1.1.24.0/24  OSPF    10   97          D   1.1.123.3       GigabitEthernet0/0/0
       1.1.34.0/24  OSPF    10   49          D   1.1.123.3       GigabitEthernet0/0/0
       1.1.45.0/24  OSPF    10   97          D   1.1.123.3       GigabitEthernet0/0/0
      10.10.2.2/32  OSPF    10   97          D   1.1.123.3       GigabitEthernet0/0/0
      10.10.3.3/32  OSPF    10   1           D   1.1.123.3       GigabitEthernet0/0/0
      10.10.4.4/32  OSPF    10   49          D   1.1.123.3       GigabitEthernet0/0/0
      10.10.5.5/32  OSPF    10   97          D   1.1.123.3       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

此时要实现T-Stub区域就需要在AR3上也配置`stub no-summary`，AR3也过滤明细的3类LSA后，查看AR1的LSDB和路由表就只存在2条由不同ABR宣告的默认3类LSA，并且该默认路由还是等价路由。一般情况下并不建议路由表中的默认路由是等价路由，更加建议是将默认路由的等价路由设置为浮动路由，一个下一跳不可达时自动跳转到另一个下一跳，浮动路由可以通过修改Preference、Cost值的方式手动设置

```yaml
[Router_3]ospf 1 
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]stub no-summary



[Router_1]display ospf 1 lsdb

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2             50  36    8000000E       1
 Router    1.1.1.1         1.1.1.1             48  48    80000012       0
 Router    3.3.3.3         3.3.3.3             49  36    8000000C       1
 Network   1.1.123.1       1.1.1.1             48  36    8000000A       0
 Sum-Net   0.0.0.0         2.2.2.2           1452  28    80000002       1
 Sum-Net   0.0.0.0         3.3.3.3            324  28    80000001       1
 
[Router_1]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 1        Routes : 2        

OSPF routing table status : <Active>
         Destinations : 1        Routes : 2

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   OSPF    10   2           D   1.1.123.2       GigabitEthernet0/0/0
                    OSPF    10   2           D   1.1.123.3       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0



[Router_3]ospf 1
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]default-cost 30    //修改Area 2的缺省路由的cost值



[Router_1]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 1        Routes : 1        

OSPF routing table status : <Active>
         Destinations : 1        Routes : 1

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   OSPF    10   2           D   1.1.123.2       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

> **配置回退**
>
> [Router_3] ospf 1 <br />
> [Router_3-ospf-1]area 1 <br />
> [Router_3-ospf-1-area-0.0.0.1]undo vlink-peer 4.4.4.4 <br />
> [Router_3-ospf-1-area-0.0.0.1]area 2 <br />
> [Router_3-ospf-1-area-0.0.0.2]undo stub
> 
> [Router_4]ospf 1 <br />
> [Router_4-ospf-1]area 1 <br />
> [Router_4-ospf-1-area-0.0.0.1]undo vlink-peer 3.3.3.3
> 
> [Router_1]ospf 1 <br />
> [Router_1-ospf-1]area 2 <br />
> [Router_1-ospf-1-area-0.0.0.2]undo stub
> 
> [Router_2]ospf 1 <br />
> [Router_2-ospf-1]area 2 <br />
> [Router_2-ospf-1-area-0.0.0.2]undo stub

## NSSA（Not So Stubby Area）区域

但由于一些不可抗力的因素，需要在特殊区域引入外部路由时，通过Stub、T-Stub无法实现需求，因此引入了NSSA区域。NSSA区域自身仍会阻止4类、5类LSA的泛洪，为了满足引入、传递外部路由的需求而产生了7类LSA，在NSSA区域内使用7类LSA代替5类LSA传播，经过ABR再将7类LSA转换为5类LSA在区域间传播。查看OSPF的LSDB时，7类LSA是有区域归属的，只有5类LSA是全区域传播，没有区域归属

```yaml
[Router_2]ospf 1
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]stub



[Router_3]ospf 1
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]nssa
```

将AR1设置为常规区域、AR2设置为Stub区域、AR3设置为NSSA区域，三者由于区域类型不一致导致无法建立邻居关系。观察抓包文件中的OSPF协议字段，AR1发起的OSPF Hello报文中支持外部路由（E=1）、不支持NSSA（N=0），三者各自的Hello报文中的Options字段的置位值标识了自身属于什么类型的区域，抓包文件中三者各自的Hello报文的Options字段中的值协商未达成一致，即三者区域类型不一致，无法建立邻居关系

![OSPF外部路由抓包解析](file:///${DB}/image/HCIP/OSPF%E5%A4%96%E9%83%A8%E8%B7%AF%E7%94%B1%E6%8A%93%E5%8C%85%E8%A7%A3%E6%9E%90.png)

| 区域 | 是否支持外部路由 | 是否支持NSSA |
| :-: | :-: | :-: |
| 常规区域（AR1） | 支持（E=1） | 不支持（N=0） |
| Stub区域（AR2） | 不支持（E=0） | 不支持（N=0） |
| NSSA区域（AR3） | 不支持（E=0） | 支持（N=1） |

将AR1、AR2设置为NSSA区域后成功建立邻居关系，查看AR1的路由表，NSSA区域会阻止4类、5类LSA的转发，ABR会产生一条默认的7类LSA泛洪到NSSA区域；在AR1上引入一条外部路由`11.1.1.0/24`，查看AR1的LSDB可以看到7类LSA的简要信息和详细信息，在AR2上查看路由表和LSDB可以看到5类、7类LSA的信息和路由，AR2作为ABR会将7类LSA转换为5类LSA后泛洪其他常规区域，查看AR4的LSDB就只能看到4类、5类LSA，没有7类LSA

```yaml
[Router_2]ospf 1 
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]undo stub
[Router_2-ospf-1-area-0.0.0.2]nssa



[Router_1]ospf 1 
[Router_1-ospf-1]area 2
[Router_1-ospf-1-area-0.0.0.2]nssa
[Router_1-ospf-1-area-0.0.0.2]dis ospf 1 lsdb 

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2            346  36    80000009       1
 Router    1.1.1.1         1.1.1.1            341  48    8000000C       0
 Router    3.3.3.3         3.3.3.3            341  36    8000000E       1
 Network   1.1.123.3       3.3.3.3            342  36    80000008       0
 Sum-Net   1.1.45.0        2.2.2.2            404  28    80000001      96
 Sum-Net   10.10.3.3       2.2.2.2            404  28    80000001      96
 Sum-Net   10.10.2.2       2.2.2.2            404  28    80000001       0
 Sum-Net   1.1.34.0        2.2.2.2            404  28    80000001      96
 Sum-Net   1.1.24.0        2.2.2.2            404  28    80000001      48
 Sum-Net   10.10.5.5       2.2.2.2            404  28    80000001      96
 Sum-Net   10.10.4.4       2.2.2.2            404  28    80000001      48
 NSSA      0.0.0.0         2.2.2.2            404  36    80000001       1

[Router_1-ospf-1-area-0.0.0.2]interface loopback 1
[Router_1-LoopBack1]ip address 11.1.1.1 255.255.255.0 
[Router_1-LoopBack1]route-policy policy_F permit node 1
[Router_1-route-policy]if-match interface loopback 1
[Router_1-route-policy]ospf 1
[Router_1-ospf-1]import-route direct route-policy policy_F
[Router_1-ospf-1]display ospf 1 lsdb 

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2           1530  36    80000009       1
 Router    1.1.1.1         1.1.1.1             60  48    8000000D       0
 Router    3.3.3.3         3.3.3.3           1525  36    8000000E       1
 Network   1.1.123.3       3.3.3.3           1526  36    80000008       0
 Sum-Net   1.1.45.0        2.2.2.2           1588  28    80000001      96
 Sum-Net   10.10.3.3       2.2.2.2           1588  28    80000001      96
 Sum-Net   10.10.2.2       2.2.2.2           1588  28    80000001       0
 Sum-Net   1.1.34.0        2.2.2.2           1588  28    80000001      96
 Sum-Net   1.1.24.0        2.2.2.2           1588  28    80000001      48
 Sum-Net   10.10.5.5       2.2.2.2           1588  28    80000001      96
 Sum-Net   10.10.4.4       2.2.2.2           1588  28    80000001      48
 NSSA      11.1.1.0        1.1.1.1             60  36    80000001       1
 NSSA      0.0.0.0         2.2.2.2           1588  36    80000001       1

[Router_1-ospf-1]display ospf 1 lsdb nssa 11.1.1.0    //在AR1上查看7类LSA的详细信息

	 OSPF Process 1 with Router ID 1.1.1.1
		         Area: 0.0.0.2
		 Link State Database 

  Type      : NSSA
  Ls id     : 11.1.1.0
  Adv rtr   : 1.1.1.1  
  Ls age    : 151 
  Len       : 36 
  Options   :  NP  
  seq#      : 80000001 
  chksum    : 0xc5db
  Net mask  : 255.255.255.0 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 10.10.1.1 
  Tag       : 1 
  Priority  : Low



[Router_2]display ospf 1 lsdb

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2           1793  36    80000009       1
 Router    1.1.1.1         1.1.1.1            327  48    8000000D       0
 Router    3.3.3.3         3.3.3.3           1791  36    8000000E       1
 Network   1.1.123.3       3.3.3.3           1792  36    80000008       0
 Sum-Net   1.1.45.0        2.2.2.2             54  28    80000002      96
 Sum-Net   10.10.3.3       2.2.2.2             54  28    80000002      96
 Sum-Net   10.10.2.2       2.2.2.2             54  28    80000002       0
 Sum-Net   1.1.34.0        2.2.2.2             54  28    80000002      96
 Sum-Net   1.1.24.0        2.2.2.2             54  28    80000002      48
 Sum-Net   10.10.5.5       2.2.2.2             54  28    80000002      96
 Sum-Net   10.10.4.4       2.2.2.2             54  28    80000002      48
 NSSA      0.0.0.0         2.2.2.2             54  36    80000002       1
 NSSA      11.1.1.0        1.1.1.1            327  36    80000001       1

		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  11.1.1.0        2.2.2.2            326  36    80000001       1
 External  55.5.5.0        5.5.5.5             64  36    80000007       1

[Router_2]display ip routing-table protocol ospf 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 8        Routes : 8        

OSPF routing table status : <Active>
         Destinations : 8        Routes : 8

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       1.1.34.0/24  OSPF    10   96          D   1.1.24.4        Serial1/0/0
       1.1.45.0/24  OSPF    10   96          D   1.1.24.4        Serial1/0/0
      10.10.1.1/32  OSPF    10   1           D   1.1.123.1       GigabitEthernet0/0/0
      10.10.3.3/32  OSPF    10   96          D   1.1.24.4        Serial1/0/0
      10.10.4.4/32  OSPF    10   48          D   1.1.24.4        Serial1/0/0
      10.10.5.5/32  OSPF    10   96          D   1.1.24.4        Serial1/0/0
       11.1.1.0/24  O_NSSA  150  1           D   1.1.123.1       GigabitEthernet0/0/0
       55.5.5.0/24  O_ASE   150  1           D   1.1.24.4        Serial1/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

## Totally NSSA区域

类似于Stub区域和T-Stub区域的关系，NSSA与Totally NSSA的区别就在于是否屏蔽明细的3类LSA，同样需要在ABR上配置T-NSSA，NSSA与T-NSSA属于相同的区域类型。查看AR1的LSDB，ABR会向T-NSSA区域宣告2条默认路由，一条3类LSA、一条7类LSA，根据OSPF选路原则，在AR1的路由表中只会显示3类LSA的默认路由

```yaml
[Router_2]ospf 1
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]nssa no-summary



[Router_1]display ospf 1 lsdb 

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2             26  36    8000000C       1
 Router    1.1.1.1         1.1.1.1             31  48    80000011       0
 Router    3.3.3.3         3.3.3.3             28  36    80000013       1
 Network   1.1.123.3       3.3.3.3             28  36    8000000D       0
 Sum-Net   0.0.0.0         2.2.2.2             36  28    80000001       1
 NSSA      11.1.1.0        1.1.1.1           1477  36    80000001       1
 NSSA      0.0.0.0         2.2.2.2             32  36    80000003       1

[Router_1]display ip routing-table pro ospf 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 1        Routes : 1        

OSPF routing table status : <Active>
         Destinations : 1        Routes : 1

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   OSPF    10   2           D   1.1.123.2       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

与T-Stub区域相似，T-NSSA区域的配置同样只需要在AR2上配置`stub no-summary`，只有AR2建立了Vlink，AR3不是ABR无需配置`stub no-summary`。如果AR4与AR3建立一条Vlink，那么同样需要在AR3上配置`stub no-summary`，否则3类明细LSA仍会通过AR3泛洪到Area 2

```yaml
[Router_4]ospf 1
[Router_4-ospf-1]area 1
[Router_4-ospf-1-area-0.0.0.1]vlink-peer 3.3.3.3



[Router_3]ospf 
[Router_3-ospf-1]area 1
[Router_3-ospf-1-area-0.0.0.1]vlink-peer 4.4.4.4



[Router_1]display ospf 1 lsdb
[Router_1]display ip routing-table protocol ospf



[Router_3]ospf
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]nssa no-summary



[Router_1]display ospf 1 lsdb
[Router_1]display ip routing-table protocol ospf
```

此时在ABR上引入外部路由，ABR会将外部路由以5类LSA泛洪到整个OSPF网络，Area 1、Area 0都能通过5类LSA学习到AR2的外部路由，Area 2作为T-NSSA区域，ABR在泛洪5类LSA时，会将5类LSA转换为7类LSA后泛洪到T-NSSA区域；但在某些场景下，既然已经将某个区域设计为特殊区域，管理员可能更多的是希望减轻该特殊区域内的设备的负载压力，或优化该特殊区域的LSA，因此并不希望从OSPF其他区域再学习到其他的7类LSA，这种场景可以在ABR上追加配置`nssa no-summary no-import-route`

“ABR在泛洪5类LSA时，会将5类LSA转换为7类LSA后泛洪到T-NSSA区域”。这个概念暂时存在问题，配合之前的配置和下面配置观察，Area 2早已配置为T-NSSA区域，而AR5的注入的外部路由一直没有取消，按照这个概念，那么AR1上应该存在由ABR将5类LSA转换后的7类LSA，也就是`55.5.5.0/24`的路由，但实际上AR1上并不存在该路由，且即便再通过R4注入外部路由，仍不会在AR1上看到由ABR转换后的7类LSA的路由，只有在ABR上注入的外部路由才会被ABR转换为7类LSA泛洪到Area 2，也就是只有AR2注入的外部路由才会被转换7类LSA，并泛洪在Area 2。根据实验结果初步得出一个判断，“只有ABR自身引入的外部路由，才会从5类LSA转换为7类LSA并泛洪到NSSA区域”；基于这个判断，在ABR上追加配置`nssa no-summary no-import-route`时，实际上只需要在AR2上追加配置即可，AR3虽然也是ABR，但AR3自身并未引入外部路由，因此AR3即便存在5类LSA也不会将其转换为7类LSA泛洪到Area 2中

```yaml
[Router_2]interface loopback 1 
[Router_2-LoopBack1]ip address 22.2.2.2 255.255.255.0
[Router_2-LoopBack1]route-policy policy_F permit node 10
[Router_2-route-policy]if-match interface loopback 1
[Router_2-route-policy]ospf 1
[Router_2-ospf-1]import-route direct route-policy policy_F
[Router_2-ospf-1]display ospf 1 lsdb

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2            917  36    80000012       1
 Router    1.1.1.1         1.1.1.1            917  48    80000017       0
 Router    3.3.3.3         3.3.3.3            914  36    80000017       1
 Network   1.1.123.1       1.1.1.1            917  36    80000004       0
 Sum-Net   0.0.0.0         2.2.2.2           1353  28    80000002       1
 Sum-Net   0.0.0.0         3.3.3.3            923  28    80000001       1
 NSSA      0.0.0.0         2.2.2.2           1350  36    80000004       1
 NSSA      22.2.2.0        2.2.2.2             66  36    80000001       1
 NSSA      0.0.0.0         3.3.3.3           1046  36    80000001       1
 NSSA      11.1.1.0        1.1.1.1            996  36    80000003       1
 
		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  22.2.2.0        2.2.2.2             67  36    80000001       1
 External  11.1.1.0        3.3.3.3            918  36    80000001       1
 External  55.5.5.0        5.5.5.5            735  36    80000009       1



[Router_1]display ospf 1 lsdb

	 OSPF Process 1 with Router ID 1.1.1.1
		 Link State Database 

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2           1291  36    80000012       1
 Router    1.1.1.1         1.1.1.1           1289  48    80000017       0
 Router    3.3.3.3         3.3.3.3           1287  36    80000017       1
 Network   1.1.123.1       1.1.1.1           1289  36    80000004       0
 Sum-Net   0.0.0.0         2.2.2.2           1727  28    80000002       1
 Sum-Net   0.0.0.0         3.3.3.3           1296  28    80000001       1
 NSSA      11.1.1.0        1.1.1.1           1368  36    80000003       1
 NSSA      0.0.0.0         2.2.2.2           1724  36    80000004       1
 NSSA      0.0.0.0         3.3.3.3           1419  36    80000001       1
 NSSA      22.2.2.0        2.2.2.2            440  36    80000001       1
 
[Router_1]display ip routing-table protocol ospf 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 2        Routes : 3        

OSPF routing table status : <Active>
         Destinations : 2        Routes : 3

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   OSPF    10   2           D   1.1.123.2       GigabitEthernet0/0/0
                    OSPF    10   2           D   1.1.123.3       GigabitEthernet0/0/0
       22.2.2.0/24  O_NSSA  150  1           D   1.1.123.2       GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0



[Router_3]ospf 1
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]nssa no-summary no-import-route



[Router_2]ospf 1
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]nssa no-summary no-import-route
[Router_2-ospf-1-area-0.0.0.2]display ospf 1 lsdb

		         Area: 0.0.0.2
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 Router    2.2.2.2         2.2.2.2             75  36    8000001A       1
 Router    1.1.1.1         1.1.1.1             72  48    80000022       0
 Router    3.3.3.3         3.3.3.3             67  36    8000001E       1
 Network   1.1.123.1       1.1.1.1             72  36    8000000F       0
 Sum-Net   0.0.0.0         2.2.2.2            133  28    80000004       1
 Sum-Net   0.0.0.0         3.3.3.3             76  28    80000003       1
 NSSA      0.0.0.0         2.2.2.2            138  36    80000006       1
 NSSA      0.0.0.0         3.3.3.3             76  36    80000003       1
 NSSA      11.1.1.0        1.1.1.1            268  36    80000004       1
 
		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  22.2.2.0        2.2.2.2           1137  36    80000001       1
 External  11.1.1.0        3.3.3.3             73  36    80000001       1
 External  55.5.5.0        5.5.5.5              6  36    8000000A       1
```

`no-import-route`参数的作用是不会向NSSA区域引入外部路由，原本ABR上的外部路由`22.2.2.0/24`会产生5类、7类LSA，在ABR上追加`no-import-route`配置后只会产生5类LSA；从这个拓扑的角度来看，ABR上追加`no-import-route`配置后，实现了NSSA区域只泛洪区域内自己产生的7类LSA，也就是AR1产生的7类LSA，不从OSPF其他区域学习其他的7类LSA，仅通过ABR通告的默认的3类LSA实现通信

> **配置回退**
>
> [Router_2]ospf 1 <br />
> [Router_2-ospf-1]undo import-route direct <br />
> [Router_2-ospf-1]quit <br />
> [Router_2]undo route-policy policy_F <br />
> [Router_2]undo interface loopback 1

### Forward Address功能解析

`Forward Address`的设计是为了解决次优路径的问题，`Forward Address`地址的定义存在几种场景

- 在NSSA或Totally NSSA区域，把直连路由引入（import）进OSPF进程，`Forward Address`：
  1. 使用OSPF最先创建的环回端口IP
  2. 没有环回口的情况下，使用OSPF最新激活的物理端口IP

- 在NSSA或Totally NSSA区域，把外部路由引入（import）进OSPF进程，`Forward Address`：
  1. 连接外部路由的端口没有运行OSPF时，则`Forward Address`同上
  2. 连接外部路由的端口运行了OSPF时，使用外部路由的下一跳地址

- 在非NSSA区域，引入外部路由，MA网络，`Forward Address`：
  1. 连接外部路由的端口没有运行OSPF时，`Forward Address`为`0.0.0.0`
  2. 连接外部路由的端口运行了OSPF时，使用外部路由的下一跳地址

AR1在NSSA区域引入外部路由`11.1.1.0/24`，该外部路由以7类LSA在NSSA区域泛洪，AR2、AR3两者作为ABR都能够收到该7类LSA，但NSSA区域中只有一个ABR能够将7类LSA转换为5类LSA并泛洪到其他区域，Router ID越大越优先。从此前路由器的LSDB中也能看到，`11.1.1.0/24`的路由泛洪到其他区域后，宣告路由器是AR3

如果手动修改AR2的Router ID，需要重启OSPF进程才能生效，且Vlink的配置也需要同步修改，因为Vlink的建立依赖Router ID

```yaml
[Router_2]ospf 1 router-id 22.2.2.2
[Router_2-ospf-1]return
<Router_2>reset ospf process



[Router_4]ospf 1
[Router_4-ospf-1]area 1
[Router_4-ospf-1-area-0.0.0.1]undo vlink-peer 2.2.2.2
[Router_4-ospf-1-area-0.0.0.1]vlink-peer 22.2.2.2
[Router_4-ospf-1-area-0.0.0.1]display ospf 1 lsdb

		 AS External Database
 Type      LinkState ID    AdvRouter          Age  Len   Sequence   Metric
 External  11.1.1.0        22.2.2.2            47  36    80000001       1
 External  55.5.5.0        5.5.5.5           1450  36    8000000A       1

<Router_4>display ospf 1 lsdb ase 11.1.1.0

	 OSPF Process 1 with Router ID 4.4.4.4
		 Link State Database

  Type      : External
  Ls id     : 11.1.1.0
  Adv rtr   : 22.2.2.2  
  Ls age    : 214 
  Len       : 36 
  Options   :  E  
  seq#      : 80000001 
  chksum    : 0x6928
  Net mask  : 255.255.255.0 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 10.10.1.1 
  Tag       : 1 
  Priority  : Low
 
<Router_4>display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 7        Routes : 10       

OSPF routing table status : <Active>
         Destinations : 7        Routes : 10

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      1.1.123.0/24  OSPF    10   49          D   1.1.34.3        Serial1/0/1
                    OSPF    10   49          D   1.1.24.2        Serial1/0/0
      10.10.1.1/32  OSPF    10   49          D   1.1.34.3        Serial1/0/1
                    OSPF    10   49          D   1.1.24.2        Serial1/0/0
      10.10.2.2/32  OSPF    10   48          D   1.1.24.2        Serial1/0/0
      10.10.3.3/32  OSPF    10   48          D   1.1.34.3        Serial1/0/1
      10.10.5.5/32  OSPF    10   48          D   1.1.45.5        Serial2/0/0
       11.1.1.0/24  O_ASE   150  1           D   1.1.34.3        Serial1/0/1
                    O_ASE   150  1           D   1.1.24.2        Serial1/0/0
       55.5.5.0/24  O_ASE   150  1           D   1.1.45.5        Serial2/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0



<Router_1>display ospf 1 lsdb nssa 11.1.1.0

	 OSPF Process 1 with Router ID 1.1.1.1
		         Area: 0.0.0.2
		 Link State Database 

  Type      : NSSA
  Ls id     : 11.1.1.0
  Adv rtr   : 1.1.1.1  
  Ls age    : 1203 
  Len       : 36 
  Options   :  NP  
  seq#      : 80000006 
  chksum    : 0xbbe0
  Net mask  : 255.255.255.0 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 10.10.1.1 
  Tag       : 1 
  Priority  : Low
```

从AR4的LSDB的简要信息中可以判断出，`11.1.1.0/24`的路由现在已经由AR2进行5类LSA泛洪了。查看AR4的路由表，`11.1.1.0/24`的路由的下一跳被等价路由到了AR2、AR3，等价路由就与`11.1.1.0/24`路由的详细5类LSA信息相关。在AR4上查看`11.1.1.0/24`的5类LSA详细信息，`Forward Address`是`10.10.1.1`

对于未与ASBR处于同一区域的其他路由器，当收到一条5类LSA时，如果该5类LSA的`Forward Address`值不是`0.0.0.0`，则需要查看自身路由表是否存在到达`Forward Address`的路由。以AR4为例，AR4收到`11.1.1.0/24`的5类LSA，其`Forward Address`是`10.10.1.1`，那么AR4首先会查询自身路由表是否存在到达`10.10.1.1`的路由。AR4的路由表中到达`10.10.1.1`的是2条等价路由，因此其5类LSA的路由下一跳也是2条等价路由

在AR1上查看7类LSA详细信息可以判断，在ABR将7类LSA转换为5类LSA的过程中，缺省情况下不会变更`Forward Address`的值

在AR1上取消loopback_0端口，查看AR1的5类LSA详细信息，根据NSSA区域引入直连路由规则，`Forward Address`变更为物理端口IP

```yaml
[Router_1]undo interface loopback 0
[Router_1]display ospf 1 lsdb nssa 11.1.1.0 

	 OSPF Process 1 with Router ID 1.1.1.1
		         Area: 0.0.0.2
		 Link State Database 

  Type      : NSSA
  Ls id     : 11.1.1.0
  Adv rtr   : 1.1.1.1  
  Ls age    : 21 
  Len       : 36 
  Options   :  NP  
  seq#      : 80000009 
  chksum    : 0x1e13
  Net mask  : 255.255.255.0 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 1.1.123.1 
  Tag       : 1 
  Priority  : Low
```

**拓扑变更**

![OSPF的FA选址实验](file:///${DB}/image/LAB/OSPF/OSPF%E7%9A%84FA%E9%80%89%E5%9D%80%E5%AE%9E%E9%AA%8C.png)

新增AR6运行RIP路由协议

```yaml
-------------------------AR1-------------------------
[Router_1]interface g0/0/2
[Router_1-GigabitEthernet0/0/2]ip address 1.1.156.1 255.255.255.0
[Router_1-GigabitEthernet0/0/2]rip 1
[Router_1-rip-1]version 2
[Router_1-rip-1]network 1.0.0.0

-------------------------AR5-------------------------
[Router_5]interface g0/0/2
[Router_5-GigabitEthernet0/0/2]ip address 1.1.156.5 255.255.255.0

-------------------------AR6-------------------------
<Huawei>system-view
[Huawei]sysname Router_6
[Router_6]interface g0/0/2
[Router_6-GigabitEthernet0/0/2]ip address 1.1.156.6 255.255.255.0
[Router_6-GigabitEthernet0/0/2]interface loopback 0
[Router_6-LoopBack0]ip address 6.6.6.6 255.255.255.255
[Router_6-LoopBack0]rip 1
[Router_6-rip-1]version 2
[Router_6-rip-1]network 1.0.0.0
[Router_6-rip-1]network 6.0.0.0
```

在AR1的OSPF进程引入RIP路由，根据NSSA区域引入外部路由规则，当连接外部路由的端口没有运行OSPF时，`Forward Address`取ASBR上最先创建的环回端口IP；当连接外部路由的端口运行了OSPF时，使用外部路由的下一跳地址

```yaml
[Router_1]acl 2000
[Router_1-acl-basic-2000]rule 5 permit source 6.6.6.6 0.0.0.0
[Router_1-acl-basic-2000]route-policy policy_G permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]ospf 1
[Router_1-ospf-1]import-route rip route-policy policy_G
[Router_1-LoopBack0]display ospf 1 lsdb nssa 6.6.6.6

	 OSPF Process 1 with Router ID 1.1.1.1
		         Area: 0.0.0.2
		 Link State Database 

  Type      : NSSA
  Ls id     : 6.6.6.6
  Adv rtr   : 1.1.1.1  
  Ls age    : 16 
  Len       : 36 
  Options   :  NP  
  seq#      : 80000002 
  chksum    : 0x5540
  Net mask  : 255.255.255.255 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 10.10.1.1    //取ASBR上最先创建的环回端口IP
  Tag       : 1 
  Priority  : Low
[Router_1-ospf-1-area-0.0.0.2]network 1.1.156.1 0.0.0.0    //连接外部路由的端口运行OSPF
[Router_1-ospf-1-area-0.0.0.2]display ospf 1 lsdb nssa 6.6.6.6

	 OSPF Process 1 with Router ID 1.1.1.1
		         Area: 0.0.0.2
		 Link State Database 

  Type      : NSSA
  Ls id     : 6.6.6.6
  Adv rtr   : 1.1.1.1  
  Ls age    : 10 
  Len       : 36 
  Options   :  NP  
  seq#      : 80000003 
  chksum    : 0xb055
  Net mask  : 255.255.255.255 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 1.1.156.6    //外部路由的下一跳地址
  Tag       : 1 
  Priority  : Low
```

在AR1上连接外部路由的端口运行OSPF后，AR1会通过1类、2类LSA将`1.1.156.0/24`宣告在Area 2中，通过ABR转换成3类LSA后泛洪到Area 0，由此AR4的路由表能够学习到去往`1.1.156.0/24`的路由；同时AR1会将外部路由`6.6.6.6/32`转换为7类LSA泛洪在NSSA区域，通过ABR将7类LSA转换为5类LSA后泛洪到OSPF的其他区域，此时AR4同样能够学习到该5类LSA。ABR将7类LSA转换为5类LSA的过程并不会变更`Forward Address`，因此AR4到`6.6.6.6/32`的路由下一跳地址应该指向`1.1.156.6`，再在自身路由表中查找`1.1.156.6`路由的下一跳是AR2、AR3等价路由

再查看AR5的LSDB和路由表，AR5同样能收到AR2泛洪的5类LSA，且AR5自身就存在`1.1.156.0/24`的直连路由，但AR5的路由表中`6.6.6.6/32`路由的下一跳却指向了AR4，这明显是一条次优路由

```yaml
[Router_5]display ospf 1 lsdb ase 6.6.6.6

	 OSPF Process 1 with Router ID 5.5.5.5
		 Link State Database

  Type      : External
  Ls id     : 6.6.6.6
  Adv rtr   : 22.2.2.2  
  Ls age    : 41 
  Len       : 36 
  Options   :  E  
  seq#      : 80000001 
  chksum    : 0x589f
  Net mask  : 255.255.255.255 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 1.1.156.6 
  Tag       : 1 
  Priority  : Medium

[Router_5]display ip routing-table 1.1.156.6 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      1.1.156.0/24  Direct  0    0           D   1.1.156.5       GigabitEthernet0/0/2

[Router_5]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.45.4        Serial1/0/0
```

通过将AR5连接外部路由的端口运行OSPF协议或RIP协议都可以解决这条次优路由的问题，但使用不同的协议会影响到网络的选路。在AR5的外部路由端口运行RIP协议时，AR5能够通过RIP协议学习到`6.6.6.6/32`的路由，RIP协议的Preference值低于OSPF外部路由，因此AR5会优选RIP协议学习到的路由，但也因为优选RIP协议学习到的路由，AR5无法影响到OSPF网络内的选路

```yaml
[Router_5]rip 1
[Router_5-rip-1]version 2
[Router_5-rip-1]net 1.0.0.0
[Router_5-rip-1]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  RIP     100  1           D   1.1.156.6       GigabitEthernet0/0/2



[Router_4]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 2
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.34.3        Serial1/0/1
                    O_ASE   150  1           D   1.1.24.2        Serial1/0/0
```

在AR5的外部路由端口运行OSPF协议时，OSPF协议识别到了AR5具备`1.1.156.0/24`的直连路由，因此AR5的`6.6.6.6/32`路由下一跳会直接指向AR6，而不再指向AR4。同时由于AR5的外部路由端口运行OSPF协议，该端口也会参与OSPF的选路，原本AR4的`6.6.6.6/32`路由下一跳指向AR2、AR3，当AR5的外部路由端口也运行OSPF协议后，AR1的外部路由端口和AR5的外部路由端口就会进行比较，根据外部路由选路规则第4条，AR4上学习到两者的路由默认情况下Preference、Cost值都相等，最终比较`Forward Metric`，明显AR5的`Forward Metric`更小、更优先

```yaml
[Router_5]undo rip 1
[Router_5]ospf 1
[Router_5-ospf-1]area 0
[Router_5-ospf-1-area-0.0.0.0]net 1.1.156.5 0.0.0.0
[Router_5-ospf-1-area-0.0.0.0]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.156.6       GigabitEthernet0/0/2



[Router_4]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.45.5        Serial2/0/0
```

缺省情况下ABR将7类LSA转换为5类LSA的过程不会变更`Forward Address`，但通过参数仍可以实现ABR在将7类LSA转换为5类LSA时，把`Forward Address`重新置位为`0.0.0.0`；使用nssa命令配置区域参数时需要一条命令上声明所有需要的参数，否则后面重新执行的命令会覆盖原有的参数

```yaml
[Router_2]ospf 1
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]nssa no-import-route no-summary suppress-forwarding-address



[Router_4]display ospf 1 lsdb ase 11.1.1.0

	 OSPF Process 1 with Router ID 4.4.4.4
		 Link State Database

  Type      : External
  Ls id     : 11.1.1.0
  Adv rtr   : 22.2.2.2  
  Ls age    : 602 
  Len       : 36 
  Options   :  E  
  seq#      : 8000000d 
  chksum    : 0x4f4c
  Net mask  : 255.255.255.0 
  TOS 0  Metric: 1 
  E type    : 2
  Forwarding Address : 0.0.0.0 
  Tag       : 1 
  Priority  : Low

[Router_4]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.24.2        Serial1/0/0



[Router_5]display ip routing-table 6.6.6.6
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        6.6.6.6/32  O_ASE   150  1           D   1.1.45.4        Serial1/0/0
```

`Forward Address`置位为`0.0.0.0`时，路由器去往外部路由的下一跳地址就指向`Advertising Router`，以AR4为例下一跳指向AR2；同时，AR2置位`Forward Address`后，AR5就无法根据`Forward Address`的值判断自身是否存在直连端口，下一跳变更为指向AR4，产生次优路由

> 注意区分`Forward Address`和`Forward Metric`的区别：`Forward Address`是OSPF的LSA下的一个字段，用于解决OSPF次优路由问题；`Forward Metric`只是一个字面描述，用于描述OSPF路由器之间的链路开销值的和
> 
> network命令广义上存在2个作用：使能接口、使能路由。每个接口的IP与宣告的网段进行匹配，被匹配的接口能够收发协议报文，此为使能接口；每个接口的IP与宣告的网段进行匹配，被匹配的接口所产生的直连路由能够传递给邻居，此为使能路由。抑制接口的一个典型应用就是配置在业务网段接口上，抑制接口实际上可以看作是network命令仅使能路由，不再使能接口，在业务网段接口下避免发送多余的广播包，节省设备资源