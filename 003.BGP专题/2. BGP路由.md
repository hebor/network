# BGP路由

![BGP路由实验](file:///${DB}/image/LAB/BGP/BGP%E8%B7%AF%E7%94%B1%E5%AE%9E%E9%AA%8C.png)

EBGP邻居间使用直连链路建立邻居关系，AS 234内通过OSPF传递路由，并在R2与R4之间建立IBGP邻居关系

**基本配置**

```yaml
-------------------------AR1-------------------------
<Huawei>system-view
[Huawei]sysname Router_1
[Router_1]interface loopback 0
[Router_1-LoopBack0]ip address 10.10.1.1 255.255.255.0
[Router_1-LoopBack0]interface g0/0/0
[Router_1-GigabitEthernet0/0/0]ip address 192.168.12.1 255.255.255.0
[Router_1-GigabitEthernet0/0/0]bgp 100
[Router_1-bgp]router-id 1.1.1.1
[Router_1-bgp]peer 192.168.12.2 as-number 234
[Router_1-bgp]return

-------------------------AR2-------------------------
<Huawei>system-view
[Huawei]sysname Router_2
[Router_2]interface loopback 0 
[Router_2-LoopBack0]ip address 10.10.2.2 255.255.255.0
[Router_2-LoopBack0]interface g0/0/0
[Router_2-GigabitEthernet0/0/0]ip address 192.168.12.2 255.255.255.0
[Router_2-GigabitEthernet0/0/0]interface g0/0/1
[Router_2-GigabitEthernet0/0/1]ip address 1.1.23.2 255.255.255.0
[Router_2-GigabitEthernet0/0/1]ospf 1 router-id 2.2.2.2
[Router_2-ospf-1]area 0
[Router_2-ospf-1-area-0.0.0.0]network 10.10.2.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]network 1.1.23.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]bgp 234
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]peer 192.168.12.1 as-number 100
[Router_2-bgp]peer 10.10.4.4 as-number 234
[Router_2-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_2-bgp]return

-------------------------AR3-------------------------
<Huawei>system-view
[Huawei]sysname Router_3
[Router_3]interface loopback 0
[Router_3-LoopBack0]ip address 10.10.3.3 255.255.255.0
[Router_3-LoopBack0]interface g0/0/1
[Router_3-GigabitEthernet0/0/1]ip address 1.1.23.3 255.255.255.0
[Router_3-GigabitEthernet0/0/1]interface g0/0/2
[Router_3-GigabitEthernet0/0/2]ip address 1.1.34.3 255.255.255.0
[Router_3-GigabitEthernet0/0/2]ospf 1 router-id 3.3.3.3
[Router_3-ospf-1]area 0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.23.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.34.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]return

-------------------------AR4-------------------------
<Huawei>system-view
[Huawei]sysname Router_4
[Router_4]interface loopback 0
[Router_4-LoopBack0]ip address 10.10.4.4 255.255.255.0
[Router_4-LoopBack0]interface g0/0/0
[Router_4-GigabitEthernet0/0/0]ip address 192.168.45.4 255.255.255.0
[Router_4-GigabitEthernet0/0/0]interface g0/0/2
[Router_4-GigabitEthernet0/0/2]ip address 1.1.34.4 255.255.255.0
[Router_4-GigabitEthernet0/0/2]ospf 1 router-id 4.4.4.4
[Router_4-ospf-1]area 0
[Router_4-ospf-1-area-0.0.0.0]network 1.1.34.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]network 10.10.4.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]bgp 234
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]peer 10.10.2.2 as-number 234
[Router_4-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_4-bgp]peer 192.168.45.5 as-number 500
[Router_4-bgp]return

-------------------------AR5-------------------------
<Huawei>system-view
[Huawei]sysname Router_5
[Router_5]interface loopback 0
[Router_5-LoopBack0]ip address 10.10.5.5 255.255.255.0
[Router_5-LoopBack0]interface g0/0/0
[Router_5-GigabitEthernet0/0/0]ip address 192.168.45.5 255.255.255.0
[Router_5-GigabitEthernet0/0/0]bgp 500
[Router_5-bgp]router-id 5.5.5.5
[Router_5-bgp]peer 192.168.45.4 as-number 234
[Router_5-bgp]return
```

## BGP路由的发布与传递

**缺省情况下，BGP不发布任何本地路由**。BGP路由宣告规则如下

1. 只有 *明确宣告* 的网络才会发送给邻居；必须手动执行命令宣告路由
2. 宣告的网络必须能 *精确地* 在路由表中找到；宣告的路由必须在路由表中能够找到，这是前提，且宣告路由时IP前缀、掩码等信息都必须与路由表中的路由信息完全一致
3. 多条路径时，只选 *最优* 路由给自身使用
4. 只把自身使用的 *最优* 路由宣告给邻居
5. 从EBGP学习到的路由会宣告给所有邻居
6. 从IBGP学习到的路由不会宣告给IBGP ；IBGP内的路由器路由宣告只传1跳（防环）
7. 从IBGP学习到的路由会宣告给EBGP

| 命令 | 说明 |
| :-- | :-- |
| display peer brief | 查看BGP邻居表 |
| display bgp routing-table | 查看BGP表 |
| network 1.1.1.0 24 | 本地宣告，精确匹配且存在路由表中，网络地址属于默认掩码时可以省略掩码 |
| summary automatic | 启用BGP自动聚合，缺省关闭 |
| import-route ospf/rip/static/direct | 引入宣告，通常结合路由策略一起使用 |
| peer 10.10.4.4 next-hop-local | 修改下一跳为自身的更新源 |
| default-route imported | 引入缺省路由，缺省情况下不允许引入缺省路由 |
| peer 10.10.4.4 default-route-advertise | 向邻居宣告一条缺省路由，下一跳是自身IP，不论本地是否存在缺省路由，类似出口设备。这条路由宣告属于本地宣告 |

BGP路由宣告的方式分两种：*本地宣告、引入宣告*，引入缺省路由和向邻居宣告一条缺省路由各自实现的效果不同，引入缺省路由被认为是引入宣告，标注为`?`号，且执行引入缺省路由操作的路由器上必须具备缺省路由。在未执行引入缺省路由的命令之前，即便BGP路由器上存在缺省路由，也不会向邻居宣告缺省路由；向邻居宣告一条缺省路由，并不需要自身路由器具备缺省路由，它被认为是本地宣告，标注为`i`号。向邻居宣告缺省路由的方式更像是让邻居路由器以自身路由器作为出口网关设备，在自身路由器上的BGP路由表中没有新增路由，只能在邻居路由器的BGP路由表中查看到新增的缺省路由

通过BGP的邻居表可以确认BGP路由器之间的邻居关系是否建立完成，基本配置中未明确宣告网络，因此BGP表中暂时没有任何路由。在R1和R5上分别新增回环口loopback\_1，并将loopback\_1的路由在BGP宣告

```yaml
[Router_1]interface loopback 1
[Router_1-LoopBack1]ip address 1.1.1.1 255.255.255.0
[Router_1-LoopBack1]bgp 100
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]network 1.1.1.0 255.255.255.0    //本地宣告



[Router_2]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         192.168.12.1    0                     0      100i
[Router_2]display ip routing-table protocol bgp
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : BGP
         Destinations : 1        Routes : 1        

BGP routing table status : <Active>
         Destinations : 1        Routes : 1

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        1.1.1.0/24  EBGP    255  0           D   192.168.12.1    GigabitEthernet0/0/0

BGP routing table status : <Inactive>
         Destinations : 0        Routes : 0



[Router_4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

   i  1.1.1.0/24         192.168.12.1    0          100        0      100i
```

在R1上通过BGP宣告loopback_1的路由后，R2通过EBGP邻居关系即可学习到该路由，并将该路由写入R2的BGP表，同时该路由在R2的BGP表中也会被选中为最优路由。根据BGP路由宣告原则3、原则4，BGP选中最优路由后会执行2个动作：*提交路由表、传递给BGP邻居*，因此在R2的路由表中能够看到`1.1.1.0/24`路由下一跳指向R1，R4的BGP表中也学习到了该路由，但R4学习到的`1.1.1.0/24`路由未被选中为最优路由，因为下一跳不可达

### BGP下一跳

观察R4的BGP表，虽然R4学习到了`1.1.1.0/24`的路由，但该路由下一跳直接指向R1，R4自身不具备去往R1的路由，因此该路由处于不可用状态，`*`号表示路由是否可用。这个问题的本质还是在于 *邻居关系* 上，*由IBGP发送给EBGP的路由信息的下一跳有做修改，反之从EBGP发送给IBGP的宣告路由的下一跳未做修改*。这里也是IGP与EGP协议的明显对比，在IGP协议下，A路由器将路由宣告给邻居B路由器时，无论该路由是否由A路由器自己产生，A路由器将路由宣告给邻居时都会将该路由的下一跳指向自己。因此，在IBGP邻居之间传递路由时需要调整路由信息中的下一跳指向自身，也就是在IBGP的出站路由器节点上执行next-hop-local命令，即可实现将EBGP传递过来的宣告路由的下一跳修改为自身的更新源

**BGP下一跳规则**

- 在EBGP间传递路由时会修改下一跳为自身的更新源
- 在IBGP间传递路由时不会修改下一跳为自己的更新源

在上例中，如果需要实现R4的`1.1.1.0/24`路由可用，仅需要在R2上补充修改`1.1.1.0/24`路由的下一跳更新源指向自身即可。需要注意，此命令是针对邻居的，如果所有邻居都需要该路由，则需要对所有邻居都执行此命令。再次查看R4的BGP表时，`1.1.1.0/24`路由的下一跳更新源指向R2，该路由被选中为最优路由。根据BGP下一跳规则，EBGP间传递路由时会修改更新源，因此R5的BGP表中`1.1.1.0/24`路由的下一跳自动指向R4。next-hop-local命令不是必选命令，但仍建议在IBGP各个节点都执行此命令，可以避免一些细节上的路由问题

```yaml
[Router_2]bgp 234
[Router_2-bgp]peer 10.10.4.4 next-hop-local    //修改下一跳为自身的更新源



[Router_4]display bgp routing-table

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  1.1.1.0/24         10.10.2.2       0          100        0      100i



[Router_5]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         192.168.45.4                          0      234 100i
```

再将R5的loopback_1宣告进BGP

```yaml
[Router_5]interface loopback 1
[Router_5-LoopBack1]ip address 5.5.5.5 24
[Router_5-LoopBack1]bgp 500
[Router_5-bgp]network 5.5.5.0 255.255.255.0



[Router_4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  1.1.1.0/24         10.10.2.2       0          100        0      100i
 *>   5.5.5.0/24         192.168.45.5    0                     0      500i



[Router_2-bgp]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         192.168.12.1    0                     0      100i
   i  5.5.5.0/24         192.168.45.5    0          100        0      500i



[Router_1-bgp]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         0.0.0.0         0                     0      i

---------------------------------------------------------------------------------------------------

[Router_4]bgp 234
[Router_4-bgp]peer 10.10.2.2 next-hop-local



[Router_1-bgp]dis bgp routing-table

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         0.0.0.0         0                     0      i
 *>   5.5.5.0/24         192.168.12.2                          0      234 500i

```

R4未修改下一跳为自身更新源时，R2学习到的`5.5.5.0/24`路由不可用，根据BGP路由宣告原则第4条，BGP只会将最优路由宣告给邻居，因此R2未将`5.5.5.0/24`的路由宣告给R1。此时虽然各个BGP路由器都已经学习到了BGP路由，但从数据转发层面观察，R3会成为数据黑洞，因为R3上没有运行BGP协议，也就没有BGP路由。BGP邻居的链路本质上只是一条逻辑链路，数据转发还是需要依赖物理链路转发。R2与R4之间传递BGP路由信息时，BGP路由信息也是作为数据来传输的，此时数据包底层封装的源目IP是`10.10.1.1、10.10.4.4`，此两者IP所处的网络在AS 234内通过OSPF协议宣告，R3同样能够学习到这两个网络，因此能够正常实现数据转发，从而实现了R2与R4之间的BGP路由学习。但直接通过BGP路由转发数据时，数据包底层封装的源目IP是`1.1.1.1、5.5.5.5`，R3上不存在去往此两者网络的路由，因此数据到达R3后会被丢弃

## BGP防环机制

无论是路由黑洞或BGP的IBGP防环机制引起的问题，本质上都是IBGP邻居关系的问题。在路由黑洞小节有提起4种不推荐的处理IBGP邻居关系的解决方式，在此小节中会对几种解决方式举例说明

**AS内防环（IBGP）**

水平分割，从IBGP收到的更新不会再发布给其他的IBGP邻居，IBGP更新只传一跳；水平分割功能是为了解决BGP的环路问题，但同时造成了多个不互联IBGP邻居之间接收不到路由的问题，这个问题主要有几种解决办法：

- IBGP邻居全互联 ；配置、维护开销太大
- 路由反射器（Route-Reflector）
- 联盟（Confederation）

**AS间防环（EBGP）**

AS\_Path，BGP更新内的重要属性，代表该路由所经过的AS号，如果接收路由器发现AS\_Path内已存在本地的AS号，则丢弃该路由信息，AS\_Path内的AS号从右往左代表着从远到近。在查看BGP路由表时可能会看到AS\_Path内会存在多个相同的AS号，这是因为AS_Path的长度会作为一个选路规则

### 双向引入路由

在AS 234内将BGP路由引入OSPF进程，R3通过OSPF能够学习到BGP路由，以此解决路由黑洞问题。在R2上将BGP路由引入OSPF进程后，查看R4的BGP表`1.1.1.0/24`仍被选中为最优路由，但查看R4的路由表时`1.1.1.0/24`路由是通过OSPF外部路由学习到的。路由选路的过程中先比较路由优先级选举最优路由，OSPF外部路由（O_ASE）优先级高于IBGP，因此R4优选通过OSPF协议学习到的路由。此时R2与R4之间仍建立有IBGP邻居关系，因此仅需要在R2、R4上将BGP路由引入进OSPF即可，如果R2与R4之间未建立IBGP邻居关系，就需要在R2、R4上执行双向引入操作，双向引入路由会导致AS 234内部路由也宣告到R1、R5

**双向引入路由还会导致原本的BGP路由属性会丢失，可能会引起环路**

```yaml
[Router_2]ospf 1
[Router_2-ospf-1]import-route bgp



[Router_4]ospf 1
[Router_4-ospf-1]import-route bgp
[Router_4-ospf-1]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  1.1.1.0/24         10.10.2.2       0          100        0      100i
 *>   5.5.5.0/24         192.168.45.5    0                     0      500i
[Router_4-ospf-1]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 4        Routes : 4        

OSPF routing table status : <Active>
         Destinations : 4        Routes : 4

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        1.1.1.0/24  O_ASE   150  1           D   1.1.34.3        GigabitEthernet0/0/2
       1.1.23.0/24  OSPF    10   2           D   1.1.34.3        GigabitEthernet0/0/2
      10.10.2.2/32  OSPF    10   2           D   1.1.34.3        GigabitEthernet0/0/2
      10.10.3.3/32  OSPF    10   1           D   1.1.34.3        GigabitEthernet0/0/2

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0



[Router_3]display ip routing-table protocol ospf 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 4        Routes : 4        

OSPF routing table status : <Active>
         Destinations : 4        Routes : 4

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        1.1.1.0/24  O_ASE   150  1           D   1.1.23.2        GigabitEthernet0/0/1
        5.5.5.0/24  O_ASE   150  1           D   1.1.34.4        GigabitEthernet0/0/2
      10.10.2.2/32  OSPF    10   1           D   1.1.23.2        GigabitEthernet0/0/1
      10.10.4.4/32  OSPF    10   1           D   1.1.34.4        GigabitEthernet0/0/2

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

> **配置回退**
>
> [Router_2]ospf 1<br />
> [Router_2-ospf-1]undo import-route bgp<br />
> [Router_2-ospf-1]bgp 234<br />
> [Router_2-bgp]undo peer 10.10.4.4
>
> [Router_4]ospf 1<br />
> [Router_4-ospf-1]undo import-route bgp<br />
> [Router_4-ospf-1]bgp 234<br />
> [Router_4-bgp]undo peer 10.10.2.2

### IBGP全互联（Full-Mesh）

*IBGP全互联，指的是IBGP路由器两两之间互相建立邻居关系（IBGP逻辑链路）*

按照IGP协议的思路（例如OSPF），R2与R3建立IBGP邻居关系、R3与R4建立IBGP邻居关系，那么从R1宣告的BGP路由自然能够逐个传递到每个路由器。但实际上根据IBGP的水平分割防环机制，IBGP更新只传一跳，R3从R2收到去往`1.1.1.0/24`的路由后不会再转发给R4，`5.5.5.0/24`的路由同理，这意味着此时只有R3上同时具备2条EBGP路由

```yaml
[Router_2]bgp  234
[Router_2-bgp]peer 10.10.3.3 as-number 234
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local



[Router_3]bgp 234
[Router_3-bgp]peer 10.10.2.2 as-number 234
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 as-number 234
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0



[Router_4]bgp 234
[Router_4-bgp]peer 10.10.3.3 as-number 234
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 next-hop-local
```

在BGP的路由宣告中排查问题时存在一个决定性因素，究竟是对端没有发送宣告路由，还是本端没有接收宣告路由，搞清楚这个问题就能排查到究竟是对端路由器的问题还是自身路由器的问题。在此示例中通过查看该路由的明细信息，可以看到R2向R3宣告了BGP路由，而R2没有向任何邻居宣告路由

```yaml
[Router_2-bgp]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         192.168.12.1    0                     0      100i
[Router_2-bgp]display bgp routing-table 1.1.1.0

 BGP local router ID : 2.2.2.2
 Local AS number : 234
 Paths:   1 available, 1 best, 1 select
 BGP routing table entry information of 1.1.1.0/24:
 From: 192.168.12.1 (1.1.1.1)
 Route Duration: 02h22m49s  
 Direct Out-interface: GigabitEthernet0/0/0
 Original nexthop: 192.168.12.1
 Qos information : 0x0
 AS-path 100, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
 Advertised to such 1 peers:    //宣告给了1个邻居
    10.10.3.3



[Router_3-bgp]dis bgp routing-table 

 BGP Local router ID is 10.10.3.3 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  1.1.1.0/24         10.10.2.2       0          100        0      100i
 *>i  5.5.5.0/24         10.10.4.4       0          100        0      500i
[Router_3-bgp]display bgp routing-table 1.1.1.0

 BGP local router ID : 10.10.3.3
 Local AS number : 234
 Paths:   1 available, 1 best, 1 select
 BGP routing table entry information of 1.1.1.0/24:
 From: 10.10.2.2 (2.2.2.2)
 Route Duration: 01h17m20s  
 Relay IP Nexthop: 1.1.23.2
 Relay IP Out-Interface: GigabitEthernet0/0/1
 Original nexthop: 10.10.2.2
 Qos information : 0x0
 AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost 1
 Not advertised to any peer yet    //没有向任何邻居宣告BGP路由



[Router_4-bgp]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   5.5.5.0/24         192.168.45.5    0                     0      500i
[Router_4-bgp]display bgp routing-table 5.5.5.0

 BGP local router ID : 4.4.4.4
 Local AS number : 234
 Paths:   1 available, 1 best, 1 select
 BGP routing table entry information of 5.5.5.0/24:
 From: 192.168.45.5 (5.5.5.5)
 Route Duration: 02h27m34s  
 Direct Out-interface: GigabitEthernet0/0/0
 Original nexthop: 192.168.45.5
 Qos information : 0x0
 AS-path 500, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
 Advertised to such 1 peers:
    10.10.3.3
```

R2未将BGP路由宣告给任何IBGP邻居是基于IGBP水印分割机制实现的正常现象，R4没有收到`1.1.1.0/24`的路由，那么R5更不会收到此路由。通过IBGP
全互联的方式可以实现所有IBGP邻居之间逻辑上都只需要一跳，由此实现BGP路由的转发

```yaml
[Router_2]bgp 234
[Router_2-bgp]peer 10.10.4.4 as-number 234
[Router_2-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_2-bgp]peer 10.10.4.4 next-hop-local



[Router_4]bgp 234 
[Router_4-bgp]peer 10.10.2.2 as-number 234
[Router_4-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_4-bgp]peer 10.10.2.2 next-hop-local
```

#### 对等体组

对等体组可以用于简化BGP配置，同时减小设备运行BGP协议带来的性能损耗，独立配置邻居关系时，每个邻居关系都会独立占用设备资源，对等体组能够实现多个邻居关系共享一份设备资源。以上述配置为例，通过对等体组简化配置

```yaml
[Router_2]bgp 234
[Router_2-bgp]group AS234 internal    //创建内部对等体组
[Router_2-bgp]peer AS234 connect-interface loopback 0    //为对等体组配置属性
[Router_2-bgp]peer AS234 next-hop-local 
[Router_2-bgp]peer 10.10.3.3 group AS234    //配置邻居关系时调用对等体组
[Router_2-bgp]peer 10.10.4.4 group AS234



[Router_3]bgp 234
[Router_3-bgp]group AS234 internal
[Router_3-bgp]peer AS234 connect-interface loopback 0
[Router_3-bgp]peer 10.10.2.2 group AS234
[Router_3-bgp]peer 10.10.4.4 group AS234



[Router_4]bgp 234
[Router_4-bgp]group AS234 internal
[Router_4-bgp]peer AS234 connect-interface loopback 0
[Router_4-bgp]peer AS234 next-hop-local
[Router_4-bgp]peer 10.10.2.2 group AS234
[Router_4-bgp]peer 10.10.3.3 group AS234
```

> **配置回退**
>
> [Router_2]undo bgp 234
>
> [Router_3]undo bgp 234
> 
> [Router_4]undo bgp 234

### 联盟/联邦（Confederation）

将一个AS划分为若干个成员AS，成员AS之间建立EBGP邻居关系。联盟的配置需要设备支持，且由于联盟的设计理念，在配置BGP时需要先配置联盟再指定BGP邻居关系，如果基于一个已有的BGP配置去追加联盟配置，会需要先抹除原有的BGP配置。因此如果需要使用联盟技术的话，一般都是先规划好网络再配置

**联盟的几个概念**

- 联盟AS：在正常的AS内部署了联盟技术，被称为联盟AS（又称大AS）。以实验拓扑为例，AS 234就是联盟AS
- 成员AS：在联盟AS内划分的子AS（又称小AS）。例如在AS 234内划分多个子AS号，R2、R3属于子AS 64512，R4属于子AS 64513
- 联盟EBGP邻居：正常的EBGP邻居关系。例如AS 100与AS 234的邻居关系
- 成员EBGP邻居：成员AS之间建立的EBGP邻居关系。例如AS 64512与AS 64513的邻居关系

**BGP联盟对路由属性的影响**

- Next-Hop：在成员EBGP邻居之间传递路由时不发生改变
- Local-Preference：在联盟成员AS之间传递路由时，Local-Preference属性不发生改变
- AS\_Path：使用联盟专用的AS\_Path类型用于防环。联盟成员AS号仅出现在联盟内传递的路由信息的AS\_Path属性中，当路由信息传递出联盟AS时，联盟成员AS号被移除
- MED：路由信息在联盟成员AS之间传递时，MED值不发生改变；路由信息传递出联邦AS时，不携带MED值

与EBGP的下一跳规则不同，成员EBGP邻居之间传递路由时不会将下一跳修改为自身更新源，因此配置成员EBGP邻居时建议在各个BGP节点都执行`next-hop-local`命令以避免一些细节上的路由问题；Local-Preference只会在AS内产生，也就是在IBGP邻居之间传递，成员EBGP邻居关系不是真正的EBGP，因此成员EBGP邻居之间传递的路由信息也会携带有Local-Preference属性，在没有路由策略的前提下Local-Preference属性不发生改变；MED属性仅在相邻的EBGP邻居之间传递，如果从AS 100传递到AS 234的路由信息中存在MED属性，该路由信息在成员EBGP邻居之间传递时MED值不发生改变

联盟的配置仅在AS内有效，正常的AS之间对联盟是无感知的，也不需要追加多余的配置。联盟内的成员AS号一般使用私有AS号

**联盟配置命令**

| 命令 | 说明 |
| :-: | :-- |
| confederation id 234 | 指定联盟所属的大AS号 |
| confederation peer-as 64513 | 联盟的成员EBGP之间互相指定邻居 |

```yaml
[Router_2]bgp 64512
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]confederation id 234
[Router_2-bgp]peer 192.168.12.1 as-number 100
[Router_2-bgp]peer 10.10.3.3 as-number 64512
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local



[Router_3]bgp 64512
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]confederation id 234
[Router_3-bgp]confederation peer-as 64513
[Router_3-bgp]peer 10.10.2.2 as-number 64512
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.2.2 next-hop-local
[Router_3-bgp]peer 10.10.4.4 as-number 64513
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 ebgp-max-hop



[Router_4]bgp 64513
[Router_4-bgp]confederation id 234
[Router_4-bgp]confederation peer-as 64512
[Router_4-bgp]peer 10.10.3.3 as-number 64512
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 ebgp-max-hop
[Router_4-bgp]peer 10.10.3.3 next-hop-local
[Router_4-bgp]peer 192.168.45.5 as-number 500
```

> **配置回退**
>
> [Router_2]undo bgp 64512
>
> [Router_3]undo bgp 64512
> 
> [Router_4]undo bgp 64513

### 路由反射器（Route-Reflector）

在一个AS内的多个BGP路由器中，选中一个合适的节点作为路由反射器RR（Route Reflector），其他节点作为客户机（Client），路由反射器和它的客户机组成一个集群（Cluster）。路由反射器会在客户机之间反射路由信息，客户机之间不需要再建立IBGP连接

无论是联盟或路由反射器，都能够在避免建立复杂的IBGP全互联关系的前提下，实现AS内的BGP路由传递。仅针对在AS内传递BGP路由这一目的而言，使用联盟配置的前提条件比路由反射器要求更高

**RR的反射规则**

1. 从非客户机IBGP邻居学习到的路由，只会反射给EBGP邻居和client
2. 从客户机IBGP邻居学习到的路由，会反射给所有EBGP邻居、client、non-client（非客户机），除了始发者
3. 从EBGP邻居学习到的路由，会反射给其他的EBGP邻居、所有client和non-client（非客户机）

RR反射规则第2条在实际设备上可能存在争议，使用eNSP模拟器配置路由反射器时会触发BGP的路由更新，通过抓包可以看到RR会将从始发者收到的路由又通过路由更新反射回始发者，稍作等待后RR又会向始发者发送一个撤销该路由的路由更新报文。且RR反射规则第2条可以通过命令手动打破此规则

路由反射器只有用在AS内（IBGP之间）才有意义，基于这个前提条件再看RR反射规则第3条，即便没有路由反射器，从EBGP邻居学习到的路由也会正常转发给IBGP邻居。此处涉及路由反射器的一个特性，与联盟类似，路由反射器也是在一个AS内实现传递BGP路由，所以*反射的路由* 会对BGP路由的属性进行保留，而*正常转发的路由* 会对BGP路由属性进行更新，因此需要对*反射的路由* 和*正常转发的路由* 进行区分，*正常转发的路由* 优先于*反射的路由*

**RR的防环机制**

- Originator_ID：在AS内的始发者Router ID
- Cluster_List：集群列表。路由反射簇ID，缺省情况下记录所有转发了路由信息的RR的Router ID

一个BGP节点收到一条路由信息后会检查该路由信息中的`Originator_ID`和`Cluster_List`，若该路由中`Originator_ID`属性值与自身BGP Router ID相同，说明自身是该路由的始发者，忽略该路由更新；若该路由中`Cluster_List`属性值内存在自身BGP Router ID，说明自身作为RR反射过该路由，同样忽略该路由更新

| 术语 | 说明 |
| :-: | :-- |
| Originator\_ID | 用于防止集群内的环路<br /> 当一条路由*第一次* 被RR反射时，RR会将始发者的Router ID写入该路由的Originator\_ID属性，用于标识该路由的始发路由器<br /> 当其他BGP邻居收到该路由时，比较该路由的Originator\_ID属性值与本地Router ID，如果相同则忽略路由更新 |
| Cluster\_ID | 用于标识一个集群，通常用loopback地址作为Cluster\_ID<br /> 一个Cluster里可以包括一个或多个RR<br /> 一个Client可以同时属于多个Cluster |
| Cluster\_List | 用于防止集群间的环路<br /> 由一系列的Cluster\_ID组成，描述了一条路由所经过的反射器路径，类似于AS\_Path<br /> 当RR反射路由时，RR会将自身Cluster\_ID添加到Cluster\_List的前面<br /> 当RR接受到一条路由时，RR会检查Cluster_List；<br />  - 若Cluster\_List中已存在本地Cluster\_ID，则丢弃该路由<br />  - 若Cluster\_List中不存在本地Cluster\_ID，则将本地Cluster\_ID追加到Cluster\_List，然后反射该路由 |

Cluster\_ID、Router ID、Loopback IP三者之间并没有强制的关联关系，在不手动指定Router ID的情况下，设备缺省会使用最大的Loopback IP作为Router ID，类似的，在不手动指定Cluster\_ID的情况下，设备缺省会使用Router ID作为Cluster\_ID。Cluster\_ID的值可以手动指定，路由Originator\_ID的属性值也可以通过修改始发者的Router ID来进行修改

**路由反射器配置命令**

| 命令 | 说明 |
| :-: | :-- |
| peer 4.4.4.4 reflect-client | 以自身作为RR，指定Client的Router ID |
| undo reflect between-client | 手动取消路由在Client之间的反射。根据RR反射规则第2条，RR从Client收到的路由会反射给除始发者以外的所有Client和non-Client，该命令会阻止RR从Client收到的路由再反射给其他Client |
| reflector cluster-id | 手动配置节点的Cluster\_ID |

手动配置节点的Cluster\_ID一般应用于冗余设计的场景，互为冗余的RR之间一般对外或相互之间都会互相反射路由，且由于双方Cluster\_ID不同，两者也会互相学习对方的路由，两者配置为相同的Cluster\_ID后能够一定程度上减少在链路上传播的路由更新信息。同时两者配置为同一个Cluster\_ID还能够避免一些选路问题，例如，互为冗余的两个RR节点在同一个集群内，两者可能都会从其他节点收到BGP路由，同时两者互为RR也肯定会将该路由互相反射给对方，那么此时RR既从始发路由器收到了路由，又从对端RR收到了同样的路由，这就存在选路问题。并且，在BGP的选路原则里，Cluster\_List也被作为选路的比较条件之一

在配置路由反射器之前，未建立IBGP全互联邻居关系的情况下，基于IBGP水印分割的防环机制，R1宣告的BGP路由只会通过R2传递到R3，R3不会再转发给R4，R5同理。查看三个节点的BGP表只有R3的BGP表存在两条BGP路由

 ```yaml
[Router_2]bgp 234
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]peer 192.168.12.1 as-number 100
[Router_2-bgp]peer 10.10.3.3 as-number 234
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local
[Router_2-bgp]display bgp routing-table



[Router_3]bgp 234
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]peer 10.10.2.2 as-number 234
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 as-number 234
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_3-bgp]display bgp routing-table



[Router_4]bgp 234
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]peer 192.168.45.5 as-number 500
[Router_4-bgp]peer 10.10.3.3 as-number 234
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 next-hop-local
[Router_4]display bgp routing-table
```

将R3配置为RR、R2作为Client，基于RR的反射规则第1条，从R4（non-client）收到的BGP路由会转发R2（client）；基于RR反射规则第2条，从R2（client）收到的BGP路由会转发给除始发者以外的所有节点。在配置路由反射器之前先对R3-R2、R3-R4的两条链路进行抓包并过滤BGP报文，配置R2作为R3的Client后观察R3-R2链路上的抓包报文

RR通过邻居Router ID指定client，对于client来说它对RR是无感知的，路由反射器的配置也只需要在RR上指定client地址即可，client上无需任何操作。配置RR后再查看其他节点的BGP表，所有节点都已经能够学习到BGP路由

```yaml
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]peer 10.10.2.2 reflect-client
```

在R3上配置路由反射器时会触发BGP的路由更新，通过抓包文件的内容可以明显观察到R3向R2发送了一个路由更新，该报文中存在`ORIGINATOR_ID`和`CLUSTER_LIST`字段，说明该报文经过了RR路由反射，再根据`ORIGINATOR_ID`和`CLUSTER_LIST`的属性值和目标网络信息可以判断出，该路由是由始发者R2宣告给R3后，R3又通过路由反射将该路由宣告回了R2。稍等片刻后R3会向R2重新发送撤销路由信息的路由更新报文，且再对R3的路由反射器重新配置时也不会再产生这种现象，即便如此，首次配置路由反射器的这个现象仍然打破了路由反射规则第2条

![路由反射器反射规则-1](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8%E5%8F%8D%E5%B0%84%E8%A7%84%E5%88%99-1.png)

![路由反射器反射规则-2](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8%E5%8F%8D%E5%B0%84%E8%A7%84%E5%88%99-2.png)

RR的防环机制基于路由信息中的`Originator`和`Cluster list`属性，此两者属性只有经过RR反射后才会产生，正常的BGP路由信息不会产生这两个属性。以R2为例，对比查看`1.1.1.0/24`和`5.5.5.0/24`的路由信息，`5.5.5.0/24`是通过R3反射学习到的BGP路由，因此只有`5.5.5.0/24`路由信息中产生了`Originator`和`Cluster list`属性。

```yaml
[Router_2-bgp]display bgp routing-table 1.1.1.0

 BGP local router ID : 2.2.2.2
 Local AS number : 234
 Paths:   1 available, 1 best, 1 select
 BGP routing table entry information of 1.1.1.0/24:
 From: 192.168.12.1 (1.1.1.1)
 Route Duration: 00h16m23s  
 Direct Out-interface: GigabitEthernet0/0/0
 Original nexthop: 192.168.12.1
 Qos information : 0x0
 AS-path 100, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
 Advertised to such 1 peers:
    10.10.3.3
[Router_2-bgp]display bgp routing-table 5.5.5.0

 BGP local router ID : 2.2.2.2
 Local AS number : 234
 Paths:   1 available, 1 best, 1 select
 BGP routing table entry information of 5.5.5.0/24:
 From: 10.10.3.3 (3.3.3.3)
 Route Duration: 00h04m34s  
 Relay IP Nexthop: 1.1.23.3
 Relay IP Out-Interface: GigabitEthernet0/0/1
 Original nexthop: 10.10.4.4
 Qos information : 0x0
 AS-path 500, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost 2
 Originator:  4.4.4.4
 Cluster list: 3.3.3.3
 Advertised to such 1 peers:
    192.168.12.1
```

`5.5.5.0/24`这条路由第一次被R3（RR）反射时，AS内的始发者是R4，因此`Originator`属性值为`4.4.4.4`；`5.5.5.0/24`这条路由从R4传递到R2，中间只经过了一个RR（R3），因此`Cluster list`属性值为`3.3.3.3`

此时通过路由反射器已经实现了AS 234内的BGP路由传递，为了观察一下RR冗余配置Cluster\_ID的场景，将R2与R4建立IBGP邻居关系并将R4配置为RR，R2同时作为R3和R4的Client。那么R2再传递BGP路由时会同时宣告给R3、R4，根据RR反射规则第2条，R3、R4收到R2的BGP路由后会互相转发给对方

```yaml
[Router_2]bgp 234
[Router_2-bgp]peer 10.10.4.4 as-number 234
[Router_2-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_2-bgp]peer 10.10.4.4 next-hop-local



[Router_4]bgp 234
[Router_4-bgp]peer 10.10.2.2 as-number 234
[Router_4-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_4-bgp]peer 10.10.2.2 next-hop-local
[Router_4-bgp]peer 10.10.2.2 reflect-client
```

此时通过R3与R4互联的链路抓包观察BGP报文，会发现在AS 234内部传递的BGP更新报文比较混乱，但只要根据`ORIGINATOR_ID`和`CLUSTER_LIST`两个字段就能判断出哪些是原始的BGP路由更新。以R3-R4的链路抓包文件为例，在抓包信息中可以看到R4转发给R2的BGP路由更新报文中存在`CLUSTER_LIST`属性值为`4.4.4.4 3.3.3.3`的报文。根据路由反射规则第1条，R4从non-client（R3）收到的BGP路由会反射给client（R2），只不过根据RR的防环机制，R2不会接收来自R4反射的路由。这条BGP路由的传递过程中经过了多个RR，`Cluster list`属性会记录下途径的所有RR的Router ID，这个特性与AS\_Path有异曲同工之妙。`Cluster list`属性值的记录顺序也与AS\_Path类似，先经过R3反射再经过R4反射，因此`Cluster list`属性值是`4.4.4.4 3.3.3.3`，从右往左代表着从远到近

![路由反射器反射规则-3](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8%E5%8F%8D%E5%B0%84%E8%A7%84%E5%88%99-3.png)

在上例中，手动配置节点的Cluster\_ID可以避免R3、R4之间互相宣告BGP路由，减小R3-R4链路上的性能损耗。手动配置Cluster\_ID后查看链路抓包文件，BGP报文的传递数量显著减少，也不会再出现上述那种经过多次反射的路由又传递回始发者的现象

```yaml
[Router_3]bgp 234
[Router_3-bgp]reflector cluster-id 234



[Router_4]bgp 234
[Router_4-bgp]reflector cluster-id 234
```

> **配置回退**
>
> [Router_2]undo bgp 234
>
> [Router_3]undo bgp 234
> 
> [Router_4]undo bgp 234

#### 路由反射器组网案例

**典型组网**

将支持路由反射器功能的节点组成一个集群，集群内的节点可以放置在AS的边缘和中心位置，为了传递从non-client学习到的路由，至少需要在中心位置存在一个RR。不支持路由反射器功能的路由器放在AS的边缘位置，通过RR的反射规则实现AS内的BGP路由传递

![路由反射器-典型组网](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8-%E5%85%B8%E5%9E%8B%E7%BB%84%E7%BD%91.png)

**层级设计**

一台路由反射器节点可以是client，同时也可以是其他节点的RR，两个角色互不冲突。RR对于client来说是无感知的，路由反射器的配置也只需要在RR上指定client地址即可，client上无需任何操作

![路由反射器-层级设计](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8-%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1.png)

**冗余设计**

所有RR之间建议采用IBGP全互联

![路由反射器-冗余设计](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8-%E5%86%97%E4%BD%99%E8%AE%BE%E8%AE%A1.png)

**层次化设计**

结合层级和冗余两者设计思路，在AS内以集群为单位传递BGP路由，一个集群的RR可以作为其他集群或RR节点的client

![路由反射器-层次化设计](file:///${DB}/image/HCIP/%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8-%E5%B1%82%E6%AC%A1%E5%8C%96%E8%AE%BE%E8%AE%A1.png)

## BGP路由聚合

路由聚合的实验拓扑仍以联盟的配置作为示例，R2-R3为成员IBGP邻居、R3-R4为成员EBGP邻居。在R1上新增多个环回口网段，并通过*引入宣告* 的方式将路由宣告到BGP协议中。在BGP表中，引入宣告的路由的Origin（起源类型）会被标注为`?`号，例如`100.1.0.1/24`；本地宣告的路由的Origin则被标注为`i`号，例如`1.1.1.0/24`

```yaml
[Router_1]interface loopback 100
[Router_1-LoopBack100]ip address 100.1.0.1 255.255.255.0
[Router_1-LoopBack100]interface loopback 101
[Router_1-LoopBack101]ip address 100.1.1.1 255.255.255.0
[Router_1-LoopBack101]interface loopback 102
[Router_1-LoopBack102]ip address 100.1.2.1 255.255.255.0
[Router_1-LoopBack102]interface loopback 103
[Router_1-LoopBack103]ip address 100.1.3.1 255.255.255.0
[Router_1-LoopBack103]route-policy policy_A permit node 10
[Router_1-route-policy]if-match interface loopback 100 loopback 101 loopback 102 loopback 103
[Router_1-route-policy]bgp 100
[Router_1-bgp]import-route direct route-policy policy_A



[Router_2]bgp 64512
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]confederation id 234
[Router_2-bgp]peer 192.168.12.1 as-number 100
[Router_2-bgp]peer 10.10.3.3 as-number 64512
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local



[Router_3]bgp 64512
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]confederation id 234
[Router_3-bgp]confederation peer-as 64513
[Router_3-bgp]peer 10.10.2.2 as-number 64512
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 as-number 64513
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 ebgp-max-hop



[Router_4]bgp 64513
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]confederation id 234
[Router_4-bgp]confederation peer-as 64512
[Router_4-bgp]peer 192.168.45.5 as-number 500
[Router_4-bgp]peer 10.10.3.3 as-number 64512
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 next-hop-local
[Router_4-bgp]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 5
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  1.1.1.0/24         10.10.2.2       0          100        0      (64512) 100i
 *>i  100.1.0.0/24       10.10.2.2       0          100        0      (64512) 100?
 *>i  100.1.1.0/24       10.10.2.2       0          100        0      (64512) 100?
 *>i  100.1.2.0/24       10.10.2.2       0          100        0      (64512) 100?
 *>i  100.1.3.0/24       10.10.2.2       0          100        0      (64512) 100?
```

针对R1的4条路由可以通过路由聚合精简BGP表，BGP路由聚合的方式有3种

1. BGP静态聚合

	先通过配置静态路由手动汇总明细路由后，再用network对汇总后的静态路由进行BGP路由宣告。基于BGP路由宣告规则，宣告的网络必须能精确地在路由表中找到，因此使用静态聚合时必须先手动生成一条汇总后的静态路由，再将该静态路由本地宣告到BGP路由。在指定静态路由时如果下一跳地址不存在，则该路由在路由表中状态是Unknown，也不会对外发布该静态路由，所以静态路由的下一跳使用黑洞接口NULL，数据包转发到NULL时会直接丢弃，黑洞接口NULL既可以保障路由的Active状态，同时也可以防止路由环路。同理，引入路由的前提是该外部路由一定要在路由表里，不在路由表里则意味着对与该设备而言，该外部路由都不是最优路由，引入将无意义

	```yaml
	[Router_1]ip route-static 100.1.0.0 255.255.252.0 null 0
	[Router_1]bgp 100
	[Router_1-bgp]ipv4-family unicast
	[Router_1-bgp-af-ipv4]network 100.1.0.0 255.255.252.0
	[Router_1-bgp-af-ipv4]undo import-route direct    //可选配置，取消引入宣告的直连明细路由
	```

	虽然这种方式被称为静态聚合并且也能实现路由汇总，但静态聚合与BGP的路由聚合不是同一个东西，静态聚合仅作为实现路由聚合的一种方式进行演示。静态聚合实现的汇总的静态路由和明细路由之间没有关联，即便明细路由在R1上都消失了也不会影响到汇总的静态路由

> **配置回退**
> [Router_1]bgp 100 <br />
> [Router_1-bgp]ipv4-family unicast <br />
> [Router_1-bgp-af-ipv4]undo network 100.1.0.0 255.255.252.0 <br />
> [Router_1-bgp-af-ipv4]quit <br />
> [Router_1-bgp]quit <br />
> [Router_1]undo ip route-static 100.1.0.0 255.255.252.0 null 0

2. BGP自动聚合

	对引入宣告的IGP路由进行*主类掩码* 聚合，将聚合后的路由宣告给BGP邻居，原引入的明细路由被抑制，不会被优选和发布给BGP邻居。需要特别注意的是，*自动聚合只对引入路由生效*，原引入的明细路由被抑制时Status codes会标记为s（suppressed）

	```yaml
	[Router_1]bgp 100
	[Router_1-bgp]summary automatic
	[Router_1-bgp]ipv4-family unicast
	[Router_1-bgp-af-ipv4]import-route direct route-policy policy_A
	[Router_1-bgp-af-ipv4]display bgp routing-table
	
	BGP Local router ID is 1.1.1.1 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 7
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>   1.1.1.0/24         0.0.0.0         0                     0      i
	*>   5.5.5.0/24         192.168.12.2                          0      234 500i
	*>   100.0.0.0          127.0.0.1                             0      ?
	s>   100.1.0.0/24       0.0.0.0         0                     0      ?
	s>   100.1.1.0/24       0.0.0.0         0                     0      ?
	s>   100.1.2.0/24       0.0.0.0         0                     0      ?
	s>   100.1.3.0/24       0.0.0.0         0                     0      ?



	[Router_2]display bgp routing-table 
	
	BGP Local router ID is 2.2.2.2 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 3
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>   1.1.1.0/24         192.168.12.1    0                     0      100i
	*>i  5.5.5.0/24         10.10.4.4       0          100        0      (64513) 500i
	*>   100.0.0.0          192.168.12.1                          0      100?
	```

	通过自动聚合的方式实现的路由汇总不够灵活，且主类掩码聚合的网络范围太大

> **配置回退**
> [Router_1]bgp 100 <br />
> [Router_1-bgp]ipv4-family unicast <br />
> [Router_1-bgp-af-ipv4]undo summary automatic

3. BGP手动聚合

	| 命令 | 说明 |
	| :-- | :-- |
	| aggregate 100.1.0.0 255.255.252.0 | 配置手动聚合，缺省情况下汇聚和明细一起发布 |
	| - detail-suppressed | 抑制发布明细路由 |
	| - as-set | 保留原有明细路由的AS_Path属性 | 
	| - suppress-policy POLICY_NAME | 通过路由策略过滤更多的明细路由不再宣告到BGP网络 |
	| - origin-policy POLICY_NAME | 只有路由策略中过滤的明细路由有效时，聚合路由才有效 |

	对引入和本地路由进行聚合，手动聚合优先级高于自动聚合，手动聚合缺省情况下不会抑制明细路由的发布。手动聚合相比较自动聚合更加灵活，且由于手动聚合能对引入、本地宣告的路由都进行聚合，因此手动聚合的配置也不用必须在引入外部路由的节点上配置。例如，在R1上引入宣告4条BGP路由，手动聚合既可以在R1上配置也可以在R3上进行手动汇总

	```yaml
	[Router_3]bgp 64512
	[Router_3-bgp]ipv4-family unicast
	[Router_3-bgp-af-ipv4]aggregate 100.1.0.0 255.255.252.0 detail-suppressed    //抑制宣告明细路由
	[Router_3-bgp-af-ipv4]display bgp routing-table
	
	BGP Local router ID is 3.3.3.3 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 7
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>i  1.1.1.0/24         10.10.2.2       0          100        0      100i
	*>i  5.5.5.0/24         10.10.4.4       0          100        0      (64513) 500i
	*>   100.1.0.0/22       127.0.0.1                             0      ?
	s>i  100.1.0.0/24       10.10.2.2       0          100        0      100?
	s>i  100.1.1.0/24       10.10.2.2       0          100        0      100?
	s>i  100.1.2.0/24       10.10.2.2       0          100        0      100?
	s>i  100.1.3.0/24       10.10.2.2       0          100        0      100?



	[Router_4]display bgp routing-table 
	
	BGP Local router ID is 4.4.4.4 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 3
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>i  1.1.1.0/24         10.10.2.2       0          100        0      (64512) 100i
	*>   5.5.5.0/24         192.168.45.5    0                     0      500i
	*>i  100.1.0.0/22       10.10.3.3                  100        0      (64512)?



	[Router_1]display bgp routing-table 
	
	BGP Local router ID is 1.1.1.1 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 7
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>   1.1.1.0/24         0.0.0.0         0                     0      i
	*>   5.5.5.0/24         192.168.12.2                          0      234 500i
	*>   100.1.0.0/22       192.168.12.2                          0      234?
	*>   100.1.0.0/24       0.0.0.0         0                     0      ?
	*>   100.1.1.0/24       0.0.0.0         0                     0      ?
	*>   100.1.2.0/24       0.0.0.0         0                     0      ?
	*>   100.1.3.0/24       0.0.0.0         0                     0      ?
	```

	在企业网络环境下，每个网络管理员只负责一定区域的网络，超出管理员负责范围外的路由器是否做手动聚合配置是不确定的，此时R1存在4条明细路由引入宣告到BGP网络，R3学习到R1宣告的路由后配置手动聚合，那么R3手动聚合后的BGP路由也会重新发送给R1、R2，且手动汇聚的路由缺省情况下重置了*AS\_Path属性*。原本R1向R3宣告的明细路由中，AS\_Path属性中记录了AS 100，经过R3手动聚合后，聚合路由的AS\_Path属性被重置，R3将汇聚路由宣告给R1时，汇聚路由的AS\_Path中仅记录了AS 234，那么对于R1来说这条汇聚路由就是可用的，此时形成路由环路

	为了避免手动聚合后形成环路，在汇聚路由器上就需要保障聚合后的路由也需要保存原有明细路由的AS\_Path属性，此时就需要`as-set`参数。当明细路由和汇聚路由产生在不同路由器上时就需要考虑使用`as-set`参数

	```yaml
	[Router_3]bgp 64512
	[Router_3-bgp]ipv4-family unicast
	[Router_3-bgp-af-ipv4]aggregate 100.1.0.0 255.255.252.0 detail-suppressed as-set



	[Router_1]display bgp routing-table 
	
	BGP Local router ID is 1.1.1.1 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 6
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>   1.1.1.0/24         0.0.0.0         0                     0      i
	*>   5.5.5.0/24         192.168.12.2                          0      234 500i
	*>   100.1.0.0/24       0.0.0.0         0                     0      ?
	*>   100.1.1.0/24       0.0.0.0         0                     0      ?
	*>   100.1.2.0/24       0.0.0.0         0                     0      ?
	*>   100.1.3.0/24       0.0.0.0         0                     0      ?
	```

	**`suppress-policy`参数示例**：某些特殊情况下，即便存在聚合路由也需要放行已经被聚合的某一些明细路由，此时需要通过手动聚合的`suppress-policy`参数通过路由策略实现该需求。`suppress-policy`参数原本是用于过滤更多的明细路由不再宣告到BGP网络，但通过route policy的deny进行取反，即可实现该需求

	```yaml
	[Router_3]acl 2000
	[Router_3-acl-basic-2000]rule 5 permit source 100.1.2.0 0.0.0.0
	[Router_3-acl-basic-2000]route-policy policy_A deny node 10
	[Router_3-route-policy]if-match acl 2000
	[Router_3-route-policy]route-policy policy_A permit node 20
	[Router_3-route-policy]bgp 64512
	[Router_3-bgp]aggregate 100.1.0.0 255.255.252.0 detail-suppressed as-set suppress-policy policy_A
	```

	**`origin-policy`参数示例**：只有路由策略中过滤的明细路由有效时，聚合路由才有效。例如，汇聚路由是对R1上的4条环回口路由进行汇总，但路由策略中仅过滤`100.1.1.0/24、100.1.2.0/24`两条路由，这两条路由任意一条有效时，汇聚路由就有效，这两条路由全部失效时，汇聚路由也会失效。`detail-suppressed`参数也只会对路由策略中过滤的明细路由进行抑制

	```yaml
	[Router_3]acl 2000
	[Router_3-acl-basic-2000]rule 10 permit source 100.1.1.0 0.0.0.0
	[Router_3-acl-basic-2000]route-policy policy_B permit node 10
	[Router_3-route-policy]if-match acl 2000
	[Router_3-route-policy]bgp 64512
	[Router_3-bgp]aggregate 100.1.0.0 255.255.252.0 detail-suppressed as-set origin-policy policy_B
	[Router_3-route-policy]display bgp routing-table 
	
	BGP Local router ID is 3.3.3.3 
	Status codes: * - valid, > - best, d - damped,
				h - history,  i - internal, s - suppressed, S - Stale
				Origin : i - IGP, e - EGP, ? - incomplete
	
	
	Total Number of Routes: 7
		Network            NextHop        MED        LocPrf    PrefVal Path/Ogn
	
	*>i  1.1.1.0/24         10.10.2.2       0          100        0      100i
	*>i  5.5.5.0/24         10.10.4.4       0          100        0      (64513) 500i
	*>   100.1.0.0/22       127.0.0.1                             0      100?
	*>i  100.1.0.0/24       10.10.2.2       0          100        0      100?
	s>i  100.1.1.0/24       10.10.2.2       0          100        0      100?
	s>i  100.1.2.0/24       10.10.2.2       0          100        0      100?
	*>i  100.1.3.0/24       10.10.2.2       0          100        0      100?
	```

**BGP聚合的特点**

1、被聚合的明细路由中只要还有一条明细路由存在，那么聚合路由就是有效路由；如果明细路由全部失效，聚合路由也会失效

2、自动聚合默认抑制明细路由；手动聚合默认放行明细路由

3、配置了BGP路由聚合的路由器会在自身路由表中自动生成一条下一跳为NULL 0的汇总路由用于防环

## BGP的第三方下一跳

基于BGP下一跳的2条规则，BGP的第三方下一跳实际上是对EBGP邻居的下一跳规则做出优化，与OSPF的Forward Address机制类似，BGP的第三方下一跳也被用于处理BGP的次优路由问题。BGP的第三方下一跳是在EBGP发送者上进行优化的，*一个节点从IBGP邻居收到一条BGP路由后，将该路由转发给EBGP邻居之前，会先对比该路由信息的下一跳地址，与建立EBGP对等体邻居时通过peer指定的EBGP邻居的地址，如果两个地址处于同一网段，则通过EBGP传递路由时保持下一跳地址不变*，否则按照正常的EBGP邻居下一跳规则传递路由，正常规则传递路由时会修改下一跳为自身更新源

![BGP第三方下一跳](file:///${DB}/image/LAB/BGP/BGP%E7%AC%AC%E4%B8%89%E6%96%B9%E4%B8%8B%E4%B8%80%E8%B7%B3.png)

此拓扑中，MA网络中三个路由器节点都通过OSPF学习直连路由和环回口路由，通过建立不同场景的4种BGP邻居关系检测BGP第三方下一跳的定义。实际上，在此拓扑中没有触发BGP第三方下一跳的路由都是次优路由，在笔录中未将4种配置全部贴出

| 邻居关系 | 下一跳 |
| :-- | :-: |
| R2与R3之间直连建立IBGP邻居，R2与R1之间直连建立EBGP邻居； | BGP第三方下一跳 |
| R2与R3之间loopback口建立IBGP邻居，R2与R1之间直连建立EBGP邻居； | 正常EBGP邻居下一跳 |
| R2与R3之间直连建立IBGP邻居，R2与R1之间loopback口建立EBGP邻居； | 正常EBGP邻居下一跳 |
| R2与R3之间loopback口建立IBGP邻居，R2与R1之间loopback口建立EBGP邻居； | 正常EBGP邻居下一跳 |

**R2与R3之间直连建立IBGP邻居，R2与R1之间直连建立EBGP邻居；**

```yaml
-------------------------AR1-------------------------
<Huawei>system-view
[Huawei]sysname Router_1
[Router_1]interface loopback 0
[Router_1-LoopBack0]ip address 1.1.1.1 255.255.255.255
[Router_1-LoopBack0]interface g0/0/0
[Router_1-GigabitEthernet0/0/0]ip address 192.168.123.1 255.255.255.0
[Router_1-GigabitEthernet0/0/0]ospf 1 router-id 1.1.1.1
[Router_1-ospf-1]area 0
[Router_1-ospf-1-area-0.0.0.0]network 192.168.123.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.0]network 1.1.1.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.0]bgp 100
[Router_1-bgp]router-id 1.1.1.1
[Router_1-bgp]peer 192.168.123.2 as-number 23

-------------------------AR2-------------------------
<Huawei>system-view
[Huawei]sysname Router_2
[Router_2]interface loopback 0
[Router_2-LoopBack0]ip address 2.2.2.2 255.255.255.255
[Router_2-LoopBack0]interface g0/0/0
[Router_2-GigabitEthernet0/0/0]ip address 192.168.123.2 255.255.255.0
[Router_2-GigabitEthernet0/0/0]ospf 1 router-id 2.2.2.2
[Router_2-ospf-1]area 0
[Router_2-ospf-1-area-0.0.0.0]network 192.168.123.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]network 2.2.2.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]bgp 23
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]peer 192.168.123.3 as-number 23
[Router_2-bgp]peer 192.168.123.1 as-number 100

-------------------------AR3-------------------------
<Huawei>system-view
[Huawei]sysname Router_3
[Router_3]interface loopback 0
[Router_3-LoopBack0]ip address 3.3.3.3 255.255.255.255
[Router_3-LoopBack0]interface g0/0/0
[Router_3-GigabitEthernet0/0/0]ip address 192.168.123.3 255.255.255.0
[Router_3-GigabitEthernet0/0/0]ospf 1 router-id 3.3.3.3
[Router_3-ospf-1]area 0
[Router_3-ospf-1-area-0.0.0.0]network 192.168.123.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 3.3.3.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]bgp 23
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]peer 192.168.123.2 as-number 23
[Router_3-bgp]interface loopback 1
[Router_3-LoopBack1]ip address 33.3.3.3 255.255.255.0
[Router_3-LoopBack1]bgp 23
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]network 33.3.3.3 255.255.255.0
```

等待OSPF、BGP邻居建立完成后，在R3上始发路由`33.3.3.3/24`，R3会将该路由传给它的IBGP邻居，因此在R2上能够学习到`33.3.3.3/24`的BGP路由。根据BGP路由宣告规则，R2会将从IBGP邻居处学习到的路由传递给自身的EBGP邻居，因此在R1上能够学习到`33.3.3.3/24`的BGP路由。根据BGP下一跳规则，IBGP邻居传递路由时不会修改下一跳，因此R2收到的`33.3.3.3/24`路由下一跳指向R3；EBGP邻居间传递路由时会修改下一跳，因此R1收到的`33.3.3.3/24`路由下一跳应该指向R2

验证R1、R2的BGP表时，R2的BGP表按照IBGP下一跳规则正常传递路由，R1的BGP表原本应该按照EBGP下一跳规则修改BGP路由的下一跳指向R2，但触发了BGP第三方下一跳规则，R2给EBGP邻居传递路由时进行了下一跳优化，避免R1学习到的下一跳成为次优路由														

```yaml
[Router_2]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  33.3.3.0/24        192.168.123.3   0          100        0      i



[Router_1]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   33.3.3.0/24        192.168.123.3                         0      23i
```

> **配置回退**
>
>
> [Router_2]bgp 23
> [Router_2-bgp]undo peer 192.168.123.3
> 
> [Router_3]bgp 23
> [Router_3-bgp]undo peer 192.168.123.2

**R2与R3之间loopback口建立IBGP邻居，R2与R1之间直连建立EBGP邻居；**

```yaml
[Router_2]bgp 23
[Router_2-bgp]peer 3.3.3.3 as-number 23
[Router_2-bgp]peer 3.3.3.3 connect-interface loopback 0



[Router_3]bgp 23
[Router_3-bgp]peer 2.2.2.2 as-number 23
[Router_3-bgp]peer 2.2.2.2 connect-interface loopback 0
```

等待OSPF、BGP邻居建立完成后查看R1、R2的BGP表，由于R2与R3之间通过loopback口建立IBGP邻居，所以R2学习到的路由下一跳指向R1的loopback口IP，路由信息的下一跳地址与通过peer指定的EBGP邻居的地址不同，因此未触发BGP第三方下一跳，R1从EBGP邻居学习到的路由下一跳仍指向R2

```yaml
[Router_2-bgp]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  33.3.3.0/24        3.3.3.3         0          100        0      i



[Router_1-bgp]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   33.3.3.0/24        192.168.123.2                         0      23i
```

### BGP会话复位

BGP有很多policy，一般情况下配置BGP和policy直接宣告使其生效即可，但BGP策略也会经常性的调整，将一个policy应用于BGP时，由于BGP自身特性没有周期性更新，仅支持增量式、触发式更新，因此policy可能不会立马生效，此时可以通过会话复位触发策略的立即更新。复位又分为*硬复位* 和*软复位*，硬复位会清除BGP邻居之间的会话，需要重新建立对等体之间的邻居关系；软复位通过向对等体发送刷新报文，收到该刷新报文的邻居路由器再回复全量更新的BGP报文，以此实现policy生效。软复位不会断开BGP对等体邻居关系

| 命令 | 说明 |
| :-- | :-- |
| reset bgp all | 硬复位，清除所有BGP会话，重新建立对等体之间的邻居关系 |
| reset bgp 2.2.2.2 | 清除与邻居2.2.2.2的BGP会话 |
| refresh bgp all export | 出方向的路由信息软复位，将自身所有路由信息向邻居发送一次全量更新 |
| refresh bgp all import | 入方向的路由信息软复位，向对等体发送路由刷新，收到该消息的邻居路由器会再发送全量更新 |

BGP协议一般承载数以万计的路由条目，重新与所有对等体建立邻居、获取路由信息是一个庞大、复杂、耗费时间的工作，工作中不可使用此命令。如果在一些特殊情况下不得不使用硬复位，也不建议复位所有对等体邻居关系，复位单个邻居关系更佳。执行refresh命令时，如果由自身向外发送路由更新，也就是export出站，BGP会立刻向外发送Update包；如果由自身向邻居申请路由更新，也就是import入站，BGP会立刻向邻居发送Route-refresh包。import入站路由需谨慎，该命令可能会导致数以万计的路由引入自身设备，如果设备性能不足以支撑庞大的路由数量，可能会导致设备宕机

正常情况下，常见的BGP报文类型只有Open包和Keepalive包，没有路由更新的情况下不会产生Update包、没有重置BGP配置的情况下不会产生Notification包、没有请求路由更新的情况下不会产生Route-refresh包

在R3上新增宣告一条BGP路由`133.3.3.0/24`，确保R1、R2能够正常收到2条BGP路由后，在R3上通过路由策略过滤掉`33.3.3.0/24`的路由，检查R2的BGP表会发现路由`33.3.3.0/24`不一定会马上消失，也就是说即便在R3上调用了路由策略，在R2上也不是马上生效的

```yaml
[Router_3]interface loopback 2
[Router_3-LoopBack2]ip address 133.3.3.3 255.255.255.0
[Router_3-LoopBack2]bgp 23
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]network 133.3.3.0 255.255.255.0
[Router_3-bgp-af-ipv4]acl 2000
[Router_3-acl-basic-2000]rule 5 deny source 33.3.3.0 0.0.0.0
[Router_3-acl-basic-2000]rule 10 permit source any
[Router_3-acl-basic-2000]bgp 23
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]peer 2.2.2.2 filter-policy 2000 export
[Router_3-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 3.3.3.3 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   33.3.3.0/24        0.0.0.0         0                     0      i
 *>   133.3.3.0/24       0.0.0.0         0                     0      i



[Router_2]display bgp routing-table 

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  33.3.3.0/24        3.3.3.3         0          100        0      i
 *>i  133.3.3.0/24       3.3.3.3         0          100        0      i
[Router_2]return
<Router_2>refresh bgp 3.3.3.3 import
```

如果R2上的`33.3.3.0/24`路由马上被过滤掉了，说明R3的路由策略生效了；如果R2上的`33.3.3.0/24`路由仍然存在，稍作等待后该路由同样会被过滤掉。BGP会话复位的作用就是加快这个过程，对BGP策略进行更新后需要立马生效时，都需要通过复位的方式处理