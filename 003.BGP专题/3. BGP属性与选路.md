# BGP属性

路由属性是一组描述BGP路由特性的参数，在配置路由策略时被广泛使用，通过BGP丰富的路由属性可以解决诸如：如何过滤某些BGP路由、如何影响BGP选路等问题

## 团体属性-Community

团体属性标识具有相同特征的BGP路由，使路由策略的应用更加灵活，降低维护管理难度

- 公认团体属性：

	| 团体属性名称 | 说明 |
	| :-: | :-: |
	| Internet <br />抓包信息： 0（0x00000000） | 向任何BGP邻居宣告 |
	| No_Advertise <br />抓包信息： 4294967042（0xFFFFFF02） | 不向任何BGP邻居宣告 |
	| No_Export <br /> 抓包信息：4294967041（0xFFFFFF01） | 不向EBGP邻居宣告 <br /> 但可以向联盟内的EBGP邻居宣告 |
	| No_Export_Subconfed <br />抓包信息： 4294967043（0xFFFFFF03） | 不向任何EBGP邻居宣告 <br /> 包括联盟内的EBGP邻居 |

- 私有团体属性：自定义规则和应用方法，格式：AS(2B):Number(2B)

	| 命令 | 说明 |
	| :-: | :-: |
	| peer x.x.x.x advertise-community | 配置允许发送团体属性给邻居 |
	| ip community-filter 1 permit | 创建团体属性过滤器 |
	| display bgp routing-table community | 查看带有团体属性的路由 |

默认情况下即便通过route-policy工具配置在路由中添加团体属性，团体属性也是不发送给邻居的，必须追加配置允许发送团体属性给邻居

![BGP路由实验](file:///${DB}/image/LAB/BGP/BGP%E8%B7%AF%E7%94%B1%E5%AE%9E%E9%AA%8C.png)

**基本配置**

```yaml
-------------------------AR1-------------------------
<Huawei>system-view
[Huawei]sysname Router_1
[Router_1]interface g0/0/0
[Router_1-GigabitEthernet0/0/0]ip address 192.168.12.1 255.255.255.0
[Router_1-GigabitEthernet0/0/0]interface loopback 0
[Router_1-LoopBack0]ip address 10.10.1.1 255.255.255.0
[Router_1-LoopBack0]interface loopback 1
[Router_1-LoopBack1]ip address 1.1.1.1 255.255.255.0
[Router_1-LoopBack1]interface loopback 100
[Router_1-LoopBack100]ip address 100.1.0.1 255.255.255.0
[Router_1-LoopBack100]interface loopback 101
[Router_1-LoopBack101]ip address 100.1.1.1 255.255.255.0
[Router_1-LoopBack101]interface loopback 102
[Router_1-LoopBack102]ip address 100.1.2.1 255.255.255.0
[Router_1-LoopBack102]interface loopback 103
[Router_1-LoopBack103]ip address 100.1.3.1 255.255.255.0
[Router_1-LoopBack103]route-policy policy_A permit node 10
[Router_1-route-policy]if-match interface loopback 100 loopback 101 loopback 102 loopback 103
[Router_1-route-policy]bgp 100
[Router_1-bgp]router-id 1.1.1.1
[Router_1-bgp]peer 192.168.12.2 as-number 234
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]network 1.1.1.0 255.255.255.0
[Router_1-bgp-af-ipv4]import-route direct route-policy policy_A

-------------------------AR2-------------------------
<Huawei>system-view
[Huawei]sysname Router_2
[Router_2]interface g0/0/0
[Router_2-GigabitEthernet0/0/0]ip address 192.168.12.2 255.255.255.0
[Router_2-GigabitEthernet0/0/0]interface g0/0/1
[Router_2-GigabitEthernet0/0/1]ip address 1.1.23.2 255.255.255.0
[Router_2-GigabitEthernet0/0/1]interface loopback 0
[Router_2-LoopBack0]ip address 10.10.2.2 255.255.255.0
[Router_2-LoopBack0]ospf 1 router-id 2.2.2.2
[Router_2-ospf-1]area 0
[Router_2-ospf-1-area-0.0.0.0]network 10.10.2.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]network 1.1.23.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]bgp 64512
[Router_2-bgp]confederation id 234
[Router_2-bgp]peer 192.168.12.1 as-number 100
[Router_2-bgp]peer 10.10.3.3 as-number 64512
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local

-------------------------AR3-------------------------
<Huawei>system-view
[Huawei]sysname Router_3
[Router_3]interface g0/0/1
[Router_3-GigabitEthernet0/0/1]ip address 1.1.23.3 255.255.255.0
[Router_3-GigabitEthernet0/0/1]interface g0/0/2
[Router_3-GigabitEthernet0/0/2]ip address 1.1.34.3 255.255.255.0
[Router_3-GigabitEthernet0/0/2]ip address 1.1.34.3 255.255.255.0
[Router_3-GigabitEthernet0/0/2]interface loopback 0
[Router_3-LoopBack0]ip address 10.10.3.3 255.255.255.0
[Router_3-LoopBack0]ospf 1 router-id 3.3.3.3
[Router_3-ospf-1]area 0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.23.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.34.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 10.10.3.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]bgp 64512
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]confederation id 234
[Router_3-bgp]confederation peer-as 64513
[Router_3-bgp]peer 10.10.2.2 as-number 64512
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.2.2 next-hop-local
[Router_3-bgp]peer 10.10.4.4 as-number 64513
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 next-hop-local
[Router_3-bgp]peer 10.10.4.4 ebgp-max-hop

-------------------------AR4-------------------------
<Huawei>system-view
[Huawei]sysname Router_4
[Router_4]interface g0/0/2
[Router_4-GigabitEthernet0/0/2]ip address 1.1.34.4 255.255.255.0
[Router_4-GigabitEthernet0/0/2]interface g0/0/0
[Router_4-GigabitEthernet0/0/0]ip address 192.168.45.4 255.255.255.0
[Router_4-GigabitEthernet0/0/0]interface loopback 0
[Router_4-LoopBack0]ip address 10.10.4.4 255.255.255.0
[Router_4-LoopBack0]ospf 1 router-id 4.4.4.4
[Router_4-ospf-1]area 0
[Router_4-ospf-1-area-0.0.0.0]network 10.10.4.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]network 1.1.34.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]bgp 64513
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]confederation id 234
[Router_4-bgp]confederation peer-as 64512
[Router_4-bgp]peer 10.10.3.3 as-number 64512
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 next-hop-local
[Router_4-bgp]peer 10.10.3.3 ebgp-max-hop
[Router_4-bgp]peer 192.168.45.5 as-number 500

-------------------------AR5-------------------------
<Huawei>system-view
[Huawei]sysname Router_5
[Router_5]interface g0/0/0
[Router_5-GigabitEthernet0/0/0]ip address 192.168.45.5 255.255.255.0
[Router_5-GigabitEthernet0/0/0]interface loopback 0
[Router_5-LoopBack0]ip address 10.10.5.5 255.255.255.0
[Router_5-LoopBack0]interface loopback 1
[Router_5-LoopBack1]ip address 5.5.5.5 255.255.255.0
[Router_5-LoopBack1]bgp 500
[Router_5-bgp]router-id 5.5.5.5
[Router_5-bgp]peer 192.168.45.4 as-number 234
[Router_5-bgp]ipv4-family unicast
[Router_5-bgp-af-ipv4]network 5.5.5.0 255.255.255.0
```

**公认团体属性示例**

通过BGP的4个公认团体属性实现从R1宣告的4条路由传递到R5的过程中逐渐递减，最终R5只能收到1条BGP路由。在R1上分别为4条路由打上不同的团体属性即可实现该需求，首先需要实现的就是对R1上的4条路由逐条进行独立捕获，再注意对每条路由标记团体属性，通过IP-Prefix（前缀列表）或ACL都能够实现过滤路由，此处使用ACL捕获独立路由，ACL既可以对数据流量做过滤，也可以对路由做过滤

在调用路由策略修改BGP路由的团体属性时需要注意路由策略的方向，如果在路由引入的时调用路由策略，那么4条路由在R1上就已经存在团体属性了，R2就只能收到一条路由。此处需求是需要在R1将4条路由转发出去时添加团体属性，实现在R2上收到的4条路由都有各自的团体属性

```yaml
//通过ACL独立过滤4条路由
[Router_1]acl 2000
[Router_1-acl-basic-2000]rule 5 permit source 100.1.0.0 0.0.0.0
[Router_1-acl-basic-2000]acl 2001
[Router_1-acl-basic-2001]rule 5 permit source 100.1.1.0 0.0.0.0
[Router_1-acl-basic-2001]acl 2002
[Router_1-acl-basic-2002]rule 5 permit source 100.1.2.0 0.0.0.0
[Router_1-acl-basic-2002]acl 2003
[Router_1-acl-basic-2003]rule 5 permit source 100.1.3.0 0.0.0.0
//通过路由策略逐一为每条路由标记不同的团体属性
[Router_1-acl-basic-2003]route-policy policy_B permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply community no-advertise
[Router_1-route-policy]route-policy policy_B permit node 20
[Router_1-route-policy]if-match acl 2001
[Router_1-route-policy]apply community no-export-subconfed
[Router_1-route-policy]route-policy policy_B permit node 30
[Router_1-route-policy]if-match acl 2002
[Router_1-route-policy]apply community no-export
[Router_1-route-policy]route-policy policy_B permit node 40
[Router_1-route-policy]if-match acl 2003
[Router_1-route-policy]apply community internet
[Router_1-route-policy]route-policy policy_B permit node 50    //最后一条空路由策略表示放行所有
//通过BGP建立对等体关系时向出方向更新路由信息
[Router_1-route-policy]bgp 100
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 192.168.12.2 route-policy policy_B export
[Router_1-bgp-af-ipv4]peer 192.168.12.2 advertise-community    //缺省情况下BGP路由不传递团体属性
[Router_1-bgp-af-ipv4]return
<Router_1>refresh bgp all export    //手动立刻发起BGP路由更新

[Router_2]bgp 64512
[Router_2-bgp]ipv4-family unicast
[Router_2-bgp-af-ipv4]peer 10.10.3.3 advertise-community
[Router_2-bgp-af-ipv4]display bgp routing-table community

 BGP Local router ID is 2.2.2.2 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Community

 *>   100.1.0.0/24       192.168.12.1    0                     0      no-advertise
 *>   100.1.1.0/24       192.168.12.1    0                     0      no-export-subconfed
 *>   100.1.2.0/24       192.168.12.1    0                     0      no-export
 *>   100.1.3.0/24       192.168.12.1    0                     0      internet

[Router_3]bgp 64512
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]peer 10.10.4.4 advertise-community
[Router_3-bgp-af-ipv4]display bgp routing-table community

 BGP Local router ID is 3.3.3.3 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 3
      Network            NextHop        MED        LocPrf    PrefVal Community

 *>i  100.1.1.0/24       10.10.2.2       0          100        0      no-export-subconfed
 *>i  100.1.2.0/24       10.10.2.2       0          100        0      no-export
 *>i  100.1.3.0/24       10.10.2.2       0          100        0      internet

[Router_4]bgp 64513
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 192.168.45.5 advertise-community
[Router_4-bgp-af-ipv4]display bgp routing-table community

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Community

 *>i  100.1.2.0/24       10.10.2.2       0          100        0      no-export
 *>i  100.1.3.0/24       10.10.2.2       0          100        0      internet
```

**私有团体属性示例**

在`10.1.3.0/24`路由的公认团体属性的基础上添加私有团体属性，通过BGP的团体属性过滤工具结合路由策略工具，可以实现路由在基于公认团体属性传递的前提下，再对私有团体属性标签进行过滤

```yaml
[Router_1]route-policy policy_B permit node 40
[Router_1-route-policy]apply community internet 1000:3000
[Router_1-route-policy]return
<Router_1>refresh bgp all export

[Router_4]display bgp routing-table community

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Community

 *>i  100.1.2.0/24       10.10.2.2       0          100        0      no-export
 *>i  100.1.3.0/24       10.10.2.2       0          100        0      internet, <1000:3000>
[Router_4]ip community-filter 1 permit 1000:3000
[Router_4]route-policy policy_B deny node 10
[Router_4-route-policy]if-match community-filter 1
[Router_4-route-policy]route-policy policy_B permit node 20
[Router_4-route-policy]bgp 64513
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 192.168.45.5 route-policy policy_B export
[Router_4-bgp-af-ipv4]return
<Router_4>refresh bgp all export

[Router_5]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   1.1.1.0/24         192.168.45.4                          0      234 100i
 *>   5.5.5.0/24         0.0.0.0         0                     0      i
[Router_5]display bgp routing-table community

 Total Number of Routes: 0
```

BGP的团体属性过滤器`community-filter`如果匹配条件中含有多个私有团体属性标签，那么多个私有团体属性标签之间是逻辑与的关系，路由的团体属性必须包含匹配条件中的所有私有团体属性标签才能被匹配。此示例中，如果想要实现`100.1.2.0/24、100.1.3.0/24`两条路由都能够传递到R5，仅需将R4的团体属性过滤条件修改为仅匹配`1000:3000`即可

```yaml
[Router_1]route-policy policy_B permit node 30
[Router_1-route-policy]apply community internet 1000:3000 2000:3000

[Router_4]undo ip community-filter 1
[Router_4]undo route-policy policy_B
[Router_4]ip community-filter 1 permit 1000:3000 2000:3000
[Router_4]route-policy policy_B permit node 10
[Router_4-route-policy]if-match community-filter 1
[Router_4-route-policy]return
<Router_4>refresh bgp all export

[Router_5]display bgp routing-table community

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Community

 *>   100.1.3.0/24       192.168.45.4                          0      internet, <1000:3000>, <2000:3000>
```

## AS-Path

AS\_Path属性用于EBGP邻居之间的防环，一般情况下BGP路由的AS\_Path属性值只有经过EBGP邻居之间的传递后才会发生变更

| 命令 | 说明 |
| :-- | :-- |
| apply as-path 800 900 overwrite | 覆写原有的AS\_Path属性值 |
| apply as-path none overwrite | 将AS\_Path列表置空 |
| peer 1.1.12.2 allow-as-loop 3 | 配置允许BGP路由中包含自身AS编号的重复次数 |
| as-path-limit XXX | 对于AS\_Path中的AS号的最大数量予以限制 |

![BGP属性实验](file:///${DB}/image/LAB/BGP/BGP%E5%B1%9E%E6%80%A7%E5%AE%9E%E9%AA%8C.png)

**基本配置**

```yaml
-------------------------AR1-------------------------
<Huawei>system-view
[Huawei]sysname Router_1
[Router_1]interface loopback 0
[Router_1-LoopBack0]ip address 10.10.1.1 255.255.255.0
[Router_1-LoopBack0]interface g0/0/1
[Router_1-GigabitEthernet0/0/1]ip address 1.1.12.1 255.255.255.0
[Router_1-GigabitEthernet0/0/1]interface g0/0/0
[Router_1-GigabitEthernet0/0/0]ip address 1.1.145.1 255.255.255.0
[Router_1-GigabitEthernet0/0/0]ospf 1 router-id 1.1.1.1
[Router_1-ospf-1]area 0
[Router_1-ospf-1-area-0.0.0.0]network 10.10.1.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.0]network 1.1.145.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.0]bgp 145
[Router_1-bgp]router-id 1.1.1.1
[Router_1-bgp]peer 10.10.4.4 as-number 145
[Router_1-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_1-bgp]peer 10.10.4.4 next-hop-local
[Router_1-bgp]peer 10.10.5.5 as-number 145
[Router_1-bgp]peer 10.10.5.5 connect-interface loopback 0
[Router_1-bgp]peer 10.10.5.5 next-hop-local
[Router_1-bgp]peer 1.1.12.2 as-number 23

-------------------------AR2-------------------------
<Huawei>system-view
[Huawei]sysname Router_2
[Router_2]interface loopback 0
[Router_2-LoopBack0]ip address 10.10.2.2 255.255.255.0
[Router_2-LoopBack0]interface g0/0/0
[Router_2-GigabitEthernet0/0/0]ip address 1.1.23.2 255.255.255.0
[Router_2-GigabitEthernet0/0/0]interface g0/0/1
[Router_2-GigabitEthernet0/0/1]ip address 1.1.12.2 255.255.255.0
[Router_2-GigabitEthernet0/0/1]interface g0/0/2
[Router_2-GigabitEthernet0/0/2]ip address 1.1.26.2 255.255.255.0
[Router_2-GigabitEthernet0/0/2]ospf 1 router-id 2.2.2.2
[Router_2-ospf-1]area 0
[Router_2-ospf-1-area-0.0.0.0]network 1.1.23.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]network 10.10.2.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]bgp 23
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]peer 1.1.12.1 as-number 145
[Router_2-bgp]peer 10.10.3.3 as-number 23
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local
[Router_2-bgp]peer 1.1.26.6 as-number 600

-------------------------AR3-------------------------
<Huawei>system-view
[Huawei]sysname Router_3
[Router_3]interface loopback 0
[Router_3-LoopBack0]ip address 10.10.3.3 255.255.255.0
[Router_3-LoopBack0]interface g0/0/0
[Router_3-GigabitEthernet0/0/0]ip address 1.1.23.3 255.255.255.0
[Router_3-GigabitEthernet0/0/0]interface g0/0/1
[Router_3-GigabitEthernet0/0/1]ip address 1.1.34.3 255.255.255.0
[Router_3-GigabitEthernet0/0/1]ospf 1 router-id 3.3.3.3
[Router_3-ospf-1]area 0
[Router_3-ospf-1-area-0.0.0.0]network 10.10.3.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.23.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]bgp 23
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]peer 1.1.34.4 as-number 145
[Router_3-bgp]peer 10.10.2.2 as-number 23
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.2.2 next-hop-local

-------------------------AR4-------------------------
<Huawei>system-view
[Huawei]sysname Router_4
[Router_4]interface loopback 0
[Router_4-LoopBack0]ip address 10.10.4.4 255.255.255.0
[Router_4-LoopBack0]interface g0/0/0
[Router_4-GigabitEthernet0/0/0]ip address 1.1.145.4 255.255.255.0
[Router_4-GigabitEthernet0/0/0]interface g0/0/1
[Router_4-GigabitEthernet0/0/1]ip address 1.1.34.4 255.255.255.0
[Router_4-GigabitEthernet0/0/1]ospf 1 router-id 4.4.4.4
[Router_4-ospf-1]area 0
[Router_4-ospf-1-area-0.0.0.0]network 1.1.145.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]network 10.10.4.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]bgp 145
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]peer 1.1.34.3 as-number 23
[Router_4-bgp]peer 10.10.1.1 as-number 145
[Router_4-bgp]peer 10.10.1.1 connect-interface loopback 0
[Router_4-bgp]peer 10.10.1.1 next-hop-local
[Router_4-bgp]peer 10.10.5.5 as-number 145
[Router_4-bgp]peer 10.10.5.5 connect-interface loopback 0
[Router_4-bgp]peer 10.10.5.5 next-hop-local

-------------------------AR5-------------------------
<Huawei>system-view
[Huawei]sysname Router_5
[Router_5]interface loopback 0
[Router_5-LoopBack0]ip address 10.10.5.5 255.255.255.0
[Router_5-LoopBack0]interface g0/0/0
[Router_5-GigabitEthernet0/0/0]ip address 1.1.145.5 255.255.255.0
[Router_5-GigabitEthernet0/0/0]ospf 1 router-id 5.5.5.5
[Router_5-ospf-1]area 0
[Router_5-ospf-1-area-0.0.0.0]network 10.10.5.5 0.0.0.0
[Router_5-ospf-1-area-0.0.0.0]network 1.1.145.5 0.0.0.0
[Router_5-ospf-1-area-0.0.0.0]bgp 145
[Router_5-bgp]router-id 5.5.5.5
[Router_5-bgp]peer 10.10.1.1 as-number 145
[Router_5-bgp]peer 10.10.1.1 connect-interface loopback 0
[Router_5-bgp]peer 10.10.4.4 as-number 145
[Router_5-bgp]peer 10.10.4.4 connect-interface loopback 0

-------------------------AR6-------------------------
<Huawei>system-view
[Huawei]sysname Router_6
[Router_6]interface loopback 0
[Router_6-LoopBack0]ip address 10.10.6.6 255.255.255.0
[Router_6-LoopBack0]interface g0/0/2
[Router_6-GigabitEthernet0/0/2]ip address 1.1.26.6 255.255.255.0
```

在R2上新增宣告一条BGP路由`22.2.2.0/24`，这条路由会通过EBGP邻居关系传递给R1、通过IBGP邻居关系传递给R3，根据BGP路由宣告规则，R2这条新增的BGP路由会在R4-R1之间互相传递、互相学习。对比R1、R2、R3的BGP表，`22.2.2.0/24`路由自R2始发，所以R2的BGP表中AS\_Path属性为空、R3与R2同属于一个AS内，BGP路由传递给R3时AS\_Path属性不发生变更、R1与R2属于不同的AS，因此R1的BGP表AS\_Path属性则添加了AS号23

```yaml
[Router_2]interface loopback 1
[Router_2-LoopBack1]ip address 22.2.2.2 255.255.255.0
[Router_2-LoopBack1]bgp 23
[Router_2-bgp]ipv4-family unicast
[Router_2-bgp-af-ipv4]network 22.2.2.0 255.255.255.0



[Router_1]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   22.2.2.0/24        1.1.12.2        0                     0      23i
 * i                     10.10.4.4                  100        0      23i
```

一般情况下AS\_Path属性值只有跨AS传递后才会发生变更，但通过路由策略可以实现修改手动修改AS\_Path的属性值。通过route-policy修改AS\_Path属性的操作中，使用route-policy可以直接**清除、覆盖**掉原有的AS\_Path属性，例如通过几个本地不存在的AS覆写掉原有的AS_Path属性，这些都属于高危操作，正常情况下不做此操作

AS\_Path属性值长短会影响到设备对于该路由的选路，与AS\_Path属性值的大小没有关系，BGP优选AS\_Path最短的路由。在R1的入站方向修改`22.2.2.0/24`路由的AS\_Path属性值后，`22.2.2.0/24`路由的下一跳发生变更

```yaml
[Router_1]acl 2000
[Router_1-acl-basic-2000]rule 5 permit source 22.2.2.0 0.0.0.0
[Router_1-acl-basic-2000]route-policy policy_A permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply as-path 500 600 additive
[Router_1-route-policy]route-policy policy_A permit node 20
[Router_1-route-policy]bgp 145
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 1.1.12.2 route-policy policy_A import
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  100        0      23i
 *                       1.1.12.2        0                     0      500 600 23i
```

AS\_Path属性既能在R1的入方向修改，也能在始发路由器的出方向修改，但两者修改后的AS\_Path属性值的含义不同。AS\_Path属性本质上是路由经过的AS的序列，即表示从路由在传递过程中经过了哪些AS，AS\_Path属性值的排序从右往左代表着AS的从远到近。入站方向修改AS\_Path属性会将AS序列号追加在左边，出站方向修改AS\_Path属性会将AS序列号追加在右边

```yaml
[Router_2]acl 2000
[Router_2-acl-basic-2000]rule 5 permit source 22.2.2.0 0.0.0.0
[Router_2-acl-basic-2000]route-policy policy_A permit node 10
[Router_2-route-policy]if-match acl 2000
[Router_2-route-policy]apply as-path 700 800 900 additive
[Router_2-route-policy]route-policy policy_A permit node 20
[Router_2-route-policy]bgp 23
[Router_2-bgp]ipv4-family unicast
[Router_2-bgp-af-ipv4]peer 1.1.12.1 route-policy policy_A export



[Router_1]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  100        0      23i
 *                       1.1.12.2        0                     0      500 600 23 700 800 900i
```

> **配置回退**
>
> [Router_1]bgp 145<br />
> [Router_1-bgp]ipv4-family unicast<br />
> [Router_1-bgp-af-ipv4]undo peer 1.1.12.2 route-policy policy_A import<br />
> [Router_1-bgp-af-ipv4]quit<br />
> [Router_1-bgp]quit<br />
> [Router_1]undo route-policy policy_A

修改AS\_Path属性值可以影响到BGP的选路，但追加的AS的序列号不可以如此随意，例如拓扑规划中本就存在一个AS 600，在该路由的AS\_Path属性中随意追加AS 600后，基于EBGP的防环机制，此路由真正传递到R6时是会被拒绝接收的。为了防止出现这种情况的同时又需要修改AS\_Path属性，可以多次追加设备自身所处AS的序列号

```yaml
[Router_2]route-policy policy_A permit node 10
[Router_2-route-policy]apply as-path 23 23 23 additive



[Router_1]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  100        0      23i
 *                       1.1.12.2        0                     0      23 23 23 23i
```

大多数情况下，网络管理员只负责自身的片区网络，那么当对方网管因配置失误导致AS\_Path属性多次追加为本端AS号时，基于EBGP的防环机制，本端路由器会拒绝接收含有自身AS号的路由。这种情况下存在两种处理方式，需要协调对方人员检查配置，或己方设备允许接收带有自身AS号的路由信息，一般情况下协调对方人员属于更不可控的选择。基于以上场景BGP提供了特有命令可用于修改BGP路由的部分属性，允许设备接收带有自身AS号的路由信息

```yaml
[Router_2]route-policy policy_A permit node 10
[Router_2-route-policy]apply as-path 145 145 145 additive



[Router_1]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  100        0      23i
[Router_1]bgp 145
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 1.1.12.2 allow-as-loop 3
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  100        0      23i
 *                       1.1.12.2        0                     0      23 145 145 145i
```

### 双向引入导致的路由环路问题

如果将R2-R3、R1-R5、R1-R4的IBGP邻居关系都关闭，在AS 145内R1与R4之间通过OSPF传递路由信息，在R1与R4上分别配置路由引入用于传递BGP路由信息。R2通过EBGP邻居关系将路由传递到R1，R1将BGP路由引入进OSPF并传递给R4，此时引入的BGP路由属性丢失，R4上又将OSPF路由引入进BGP并通过EBGP邻居关系传递给R3，并且由于查看R3的BGP表时，该路由是R4始发。一个AS之间的环路产生了，原本路由`22.2.2.0/24`由AS 23内的R2始发，经过AS 145后又传递回AS 23并正常被R3接收

```yaml
[Router_2]bgp 23
[Router_2-bgp]peer 10.10.3.3 ignore    //管理性关闭与对等体的邻居关系，并不是真正抹除与对等体的邻居关系



[Router_1]bgp 145
[Router_1-bgp]peer 10.10.4.4 ignore
[Router_1-bgp]peer 10.10.5.5 ignore
[Router_1-bgp]route-policy policy_A permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]ospf 1
[Router_1-ospf-1]import-route bgp route-policy policy_A    //此时R4通过OSPF的5类LSA能够学习到路由22.2.2.0/24



[Router_4]acl 2000
[Router_4-acl-basic-2000]rule 5 permit source 22.2.2.0 0.0.0.0
[Router_4-acl-basic-2000]route-policy policy_A permit node 10
[Router_4-route-policy]if-match acl 2000
[Router_4-route-policy]bgp 145
[Router_4-bgp]ipv4-family unicast                     
[Router_4-bgp-af-ipv4]import-route ospf 1 route-policy policy_A
[Router_4-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   22.2.2.0/24        0.0.0.0         1                     0      ?

```

这个由于引入路由导致的BGP路由环路问题，通过route-policy手动修改AS\_Path属性即可解决，例如在R4将OSPF路由引入进BGP的路由策略中追加AS\_Path属性，再次查看R3的BGP表就拒绝接收该路由了

```yaml
[Router_4]route-policy policy_A permit node 10
[Router_4-route-policy]apply as-path 23 additive
[Router_4-route-policy]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   22.2.2.0/24        0.0.0.0         1                     0      23?
```

> **配置回退**
>
> [Router_1]bgp 145<br />
> [Router_1-bgp]undo peer 10.10.4.4 ignore<br />
> [Router_1-bgp]undo peer 10.10.5.5 ignore<br />
> [Router_1-bgp]ospf 1<br />
> [Router_1-ospf-1]undo import bgp<br />
> [Router_1-ospf-1]quit<br />
> [Router\_1]undo route-policy policy\_A<br />
> [Router_1]undo acl 2000
>
>[Router_2]undo acl 2000<br />
>[Router_2]undo route-policy policy_A<br />
>[Router_2]bgp 23<br />
>[Router_2-bgp]undo peer 10.10.3.3 ignore<br />
>[Router_2-bgp]ipv4-family unicast<br />
>[Router_2-bgp-af-ipv4]undo peer 1.1.12.1 route-policy policy_A export
>
> [Router_4]undo acl 2000<br />
> [Router\_4]undo route-policy policy\_A<br />
> [Router_4]bgp 145<br />
> [Router_4-bgp]ipv4-family unicast<br />
> [Router_4-bgp-af-ipv4]undo import-route ospf 1

## Local Preference

Local-Preference用于在AS内优选到达某一目的的路由，反映了BGP Speaker对每条BGP路由的偏好程度，例如在R5上能够学习到2条去往`22.2.2.0/24`的路由下一跳，通过Local-Preference属性可以手动控制R5优选其中一个下一跳

查看R5的BGP表会发现一个问题，原本R5能收到两条去往的`22.2.2.0/24`的路由，R4修改Local-Preference后R5就只能收到一条`22.2.2.0/24`的路由了。这是因为R1也能从R4处收到`22.2.2.0/24`的路由，并通过比较Local-Preference后优选下一跳为R4，此时基于AS内的防环机制，IBGP邻居之间的水平分割，R1不会再将自身最优路由传递给R5，因此R5的`22.2.2.0/24`路由只有一个下一跳了

```yaml
[Router_4]bgp 145
[Router_4-bgp]default local-preference 101    //针对自身始发的路由和从EBGP邻居处收到的路由，将local-preference属性值修改为101



[Router_5]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 1
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.4.4                  101        0      23i
```

> **配置回退**
>
> [Router_4]bgp 145<br />
> [Router_4-bgp]ipv4-family unicast<br />
> [Router_4-bgp-af-ipv4]undo default local-preference

IBGP邻居之间传递路由时会携带Local-Preference，EBGP邻居之间传递路由时不携带Local-Preference，因此在修改Local-Preference属性时，可以在IBGP的入向、出向、EBGP邻居的入向修改Local-Preference属性，通过路由策略可以为EBGP路由入站时修改Local-Preference，但无法为EBGP邻居的出站路由修改Local-Preference属性。例如，在AS 145内，去往`33.3.3.0/24`下一跳指向R4、去往`22.2.2.0/24`下一跳指向R1

```yaml
[Router_3]interface loopback 1
[Router_3-LoopBack1]ip address 33.3.3.3 255.255.255.0
[Router_3-LoopBack1]bgp 23
[Router_3-bgp]ipv4-family unicast
[Router_3-bgp-af-ipv4]network 33.3.3.0 255.255.255.0



[Router_4]acl 2000
[Router_4-acl-basic-2000]rule 5 permit source 33.3.3.0 0.0.0.0
[Router_4-acl-basic-2000]route-policy policy_A permit node 10
[Router_4-route-policy]if-match acl 2000
[Router_4-route-policy]apply local-preference 101
[Router_4-route-policy]route-policy policy_A permit node 20
[Router_4-route-policy]bgp 145
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 1.1.34.3 route-policy policy_A import



[Router_1]acl 2000
[Router_1-acl-basic-2000]rule 5 permit source 22.2.2.0 0.0.0.0
[Router_1-acl-basic-2000]route-policy policy_A permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply local-preference 101
[Router_1-route-policy]route-policy policy_A permit node 20
[Router_1-route-policy]bgp 145
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 1.1.12.2 route-policy policy_A import



[Router_5]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 2
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  22.2.2.0/24        10.10.1.1       0          101        0      23i
 *>i  33.3.3.0/24        10.10.4.4       0          101        0      23i
```

## BGP路由属性

![BGP路由表解析](file:///${DB}/image/HCIP/BGP%E8%B7%AF%E7%94%B1%E8%A1%A8%E8%A7%A3%E6%9E%90.png)

![BGP的丰富属性](file:///${DB}/image/HCIP/BGP%E7%9A%84%E4%B8%B0%E5%AF%8C%E5%B1%9E%E6%80%A7.png)

| 属性分类 | 说明 |
| :-- | :-- |
| 公认必遵 <br /> well-known mandatory | 所有BGP路由器都可以识别 <br /> 且必须存在Update消息中 |
| 公认任意 <br /> well-known discretionary | 所有BGP路由器都可以识别 <br /> 但不要求必须存在于Update消息中 |
| 可选过渡 <br /> optional transitive | 不能被所有BGP路由器识别 <br /> 如果无法识别，可以传递给邻居 |
| 可选非过渡 <br /> optional non-transitive | 不能被所有BGP路由器识别 <br /> 如果无法识别，则丢弃该属性 |

| 属性 | 简述 | 说明 | 对比方式 |
| :-- | :-- | :-- | :-- |
| PrefVal | 协议首选值，华为与华三的私有属性，思科的私有属性是Weight | - 定义本地路由的优先级，本地有效，不传播给邻居 <br /> - 除非存在特殊需求，否则一般不会修改私有属性，而是尽可能通过修改公认属性调整选路 <br /> - 与Local-Preference不同的是PrefVal仅在路由器本地生效，不会传递给邻居，而Local-Preference能够影响到AS内的邻居路由器 <br /> - PrefVal只能在入向修改 | 缺省值是0，越大越优先 |
| Local-Preference | 本地优先级属性 | - 用于在AS内优选到达某一目的的路由，常用于控制流量怎样流出AS（出站路由） <br /> - 反映了BGP Speaker对每条BGP路由的偏好程度，本地优先级属性只在AS内传递，也就是只传播给IBGP邻居（本地） <br /> - 可以在IBGP的入向、出向、EBGP的入向修改 | 缺省值是100，越大越优先 |
| AS\_Path | AS路径属性 | - EBGP传递时更新（加入自己的AS号），BGP路由在传输的路径中所经过的AS号都会被记录到AS\_Path列表， <br /> - 路由器会丢弃AS\_Path属性中包含自身AS Number的路由，用于防止AS间路由环路，也可以用于路由的过滤和选择 <br /> - 联盟内的成员AS号仅在联盟范围内生效，路由传递出联盟后，小AS号不计入AS\_Path长度 <br /> - 使用AS-Set保留原有明细路由的AS\_Path属性时，无视路由原本的AS\_Path长度，将AS-Set后的路由AS\_Path长度时视作1。例如聚合，明细路由仍保持自身的AS\_Path属性，但聚合路由的AS\_Path长度被视作1 <br /> - 从右往左代表着AS的从远到近 | AS数量越少越优先 |
| Origin | 起源属性 | - 定义路由信息的来源，标记一条路由是怎么成为BGP路由的 <br /> - i=IGP；通过network宣告的路由 <br /> - e=EGP；通过EGP（已淘汰）学习到的路由 <br /> - ?=incomplete；通过import引入学习到的路由 | i（IGP）>e（EGP）>?（incomplete） |
| MED | Multi-Exit-DISC，相当于IGP的度量值 | - 缺省情况下，一条路由的多个下一跳的临近的AS号相同时会比较MED，临近的AS号不同时跳过MED比较 <br /> - MED用于区别达到同一邻居AS的多条入口链路。当某个AS有多个入口时，可以用MED属性来帮助某外部的AS选择一个较好的入口路径 <br /> - 仅在相邻的两个AS之间传递，收到此属性的AS不会再通告给任何其他第三方AS <br /> - 常用于控制流量怎样进入本AS（入站路由）；MED用于EBGP之间控制流量，在IBGP内部路由器即便配置了MED，传递给IBGP邻居时也会被丢弃  | 缺省值是0，越小越优先 |
| Community | 团体属性 | 标识了一组具有相同特征的路由信息，与它所在的AS无关。类似OSPF的Tag |  |
| Next Hop | 下一跳属性 | 下一跳=更新源 |  |

# BGP选路原则

BGP不像IGP，本身并没有路由算法，而是结合丰富的属性进行选路。BGP路由选择存在3种情况

- 该路由是到达目的地的唯一路由，直接优选
- 对到达同一目的地的多条路由，优选协议首选值（PrefVal，又称优先级）最高的路由
- 对到达同一目的地且具有相同协议首选值的多条路由，通过BGP路由优选的13条规则进行比较

**BGP路由优选的14条规则**

1. 丢弃下一跳不可达的路由
2. 优选 Preference_Value 最高的路由
3. 优选 Local_Preference 最高的路由；虽然EBGP邻居间传递路由时不携带Local-Preference，但该属性缺省值为100，也可以间接看作EBGP邻居间传递路由的Local-Preference属性值为100；Local-Preference能在IBGP邻居的入向、出向、EBGP邻居的入向进行修改
4. 路由的生成方式，Aggregate（手动聚合）> Summary Automatic（自动聚合）> Network > Import Route > 从对等体学到的路由；（A>S>N>I>L）
5. 优选 AS\_Path 最短的路由
6. 起源类型 IGP>EGP>Incomplete
7. 对于来自同一AS的路由，优选MED最小的
8. 优选从EBGP学来的路由（EBGP>IBGP），此处比较的是BGP路由状态代码而不是Origin属性，状态代码i（internal）代表内部学习到的路由，也就是IBGP路由，没有标记i则代表EBGP路由。联盟的IBGP与EBGP没有区别，都看作是IBGP邻居传递的路由
9. 优选AS内部IGP协议的Metric最小的路由，prefer the route with the lowest IGP cost to BGP next-hop。此规则比较的是AS内部运行的IGP协议的链路的开销值，例如RIP、OSPF的开销值
10. 负载；前9条匹配条件完全相同，且路由存在多个下一跳的情况下会比较成为等价路由的条件，缺省情况下BGP路由未开启等价路由配置，需要手动开启配置
11. 优选 Cluster_List 最短的路由（Cluster_List中的Cluster_ID个数最少）
12. 优选 Orginator_ID 最小的路由
13. 优选 Router_ID 最小的路由器发布的路由
14. 优选Peer地址最小的对等体邻居传递过来的路由（从IP地址最小的邻居学到的路由）。这条规则一般会应用在两个BGP邻居之间，既建立了物理端口邻居又建立了回环口邻居的场景，物理端口的Router_ID与回环口Router_ID一致

| 命令 | 说明 |
| :-- | :-- |
| peer 10.10.5.5 preferred-value 1 | 针对BGP邻居修改PrefVal，该邻居传递过来的所有路由PrefVal都会被修改 |
| default local-preference 101 | 针对本地始发的路由、从EBGP邻居收到的路由修改Local-Preference |
| bestroute as-path-ignore | 自动跳过选路原则AS\_Path的比较 |
| compare-different-as-med | 无论临近的AS号是否相同，均比较不同AS邻居的MED值 |
| deterministic-med | 先分组，临近AS号相同的是一组，先小组赛，再淘汰赛 |
| default med 100 | 配置缺省的MED值 |
| maximum load-balancing [ ebgp | ibgp ] number | 设置形成负载分担的等价路由的最大条数，缺省值为1，即不进行负载分担 |
| load-balancing as-path-relax | 形成BGP等价路由时不比较路由的AS\_Path属性中包含的联邦属性 |
| load-balancing as-path-ignore | 形成BGP等价路由时不比较路由的AS\_Path属性 |
| load-balancing igp-metric-ignore | 形成负载分担时不比较路由的igp-meric属性 |

缺省情况下，不允许比较来自不同AS邻居的路由信息的MED值，除非能够确认不同的AS采用了同样的IGP和路由选择方式，则可以使用命令进行调整

![BGP选路原则](file:///${DB}/image/LAB/BGP/BGP%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99.png)

**基本配置**

```yaml
-------------------------AR1-------------------------
<Huawei>system-view
[Huawei]sysname Router_1
[Router_1]interface loopback 0
[Router_1-LoopBack0]ip address 10.10.1.1 255.255.255.0
[Router_1-LoopBack0]interface g0/0/0
[Router_1-GigabitEthernet0/0/0]ip address 1.1.123.1 255.255.255.224
[Router_1-GigabitEthernet0/0/0]ospf 1 router-id 1.1.1.1
[Router_1-ospf-1]area 2
[Router_1-ospf-1-area-0.0.0.2]network 1.1.123.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.2]network 10.10.1.1 0.0.0.0
[Router_1-ospf-1-area-0.0.0.2]bgp 1
[Router_1-bgp]router-id 1.1.1.1
[Router_1-bgp]peer 10.10.2.2 as-number 234
[Router_1-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_1-bgp]peer 10.10.2.2 ebgp-max-hop
[Router_1-bgp]peer 10.10.3.3 as-number 234
[Router_1-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_1-bgp]peer 10.10.3.3 ebgp-max-hop
[Router_1-bgp]peer 10.10.5.5 as-number 5
[Router_1-bgp]peer 10.10.5.5 connect-interface loopback 0
[Router_1-bgp]peer 10.10.5.5 ebgp-max-hop

-------------------------AR2-------------------------
<Huawei>system-view
[Huawei]sysname Router_2
[Router_2]interface loopback 0
[Router_2-LoopBack0]ip address 10.10.2.2 255.255.255.0
[Router_2-LoopBack0]interface g0/0/0
[Router_2-GigabitEthernet0/0/0]ip address 1.1.123.2 255.255.255.224
[Router_2-GigabitEthernet0/0/0]interface s1/0/0
[Router_2-Serial1/0/0]ip address 1.1.24.2 255.255.255.0
[Router_2-Serial1/0/0]ospf 1 router-id 2.2.2.2
[Router_2-ospf-1]area 2
[Router_2-ospf-1-area-0.0.0.2]network 1.1.123.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.2]area 0
[Router_2-ospf-1-area-0.0.0.0]network 10.10.2.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]network 1.1.24.2 0.0.0.0
[Router_2-ospf-1-area-0.0.0.0]bgp 234
[Router_2-bgp]router-id 2.2.2.2
[Router_2-bgp]peer 10.10.1.1 as-number 1
[Router_2-bgp]peer 10.10.1.1 connect-interface loopback 0
[Router_2-bgp]peer 10.10.1.1 ebgp-max-hop
[Router_2-bgp]peer 10.10.3.3 as-number 234
[Router_2-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_2-bgp]peer 10.10.3.3 next-hop-local
[Router_2-bgp]peer 10.10.4.4 as-number 234
[Router_2-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_2-bgp]peer 10.10.4.4 next-hop-local

-------------------------AR3-------------------------
<Huawei>system-view
[Huawei]sysname Router_3
[Router_3]interface loopback 0
[Router_3-LoopBack0]ip address 10.10.3.3 255.255.255.0
[Router_3-LoopBack0]interface g0/0/0
[Router_3-GigabitEthernet0/0/0]ip address 1.1.123.3 255.255.255.224
[Router_3-GigabitEthernet0/0/0]interface s1/0/0
[Router_3-Serial1/0/0]ip address 1.1.34.3 255.255.255.0
[Router_3-Serial1/0/0]ospf 1 router-id 3.3.3.3
[Router_3-ospf-1]area 2
[Router_3-ospf-1-area-0.0.0.2]network 1.1.123.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.2]area 0
[Router_3-ospf-1-area-0.0.0.0]network 10.10.3.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]network 1.1.34.3 0.0.0.0
[Router_3-ospf-1-area-0.0.0.0]bgp 234
[Router_3-bgp]router-id 3.3.3.3
[Router_3-bgp]peer 10.10.1.1 as-number 1
[Router_3-bgp]peer 10.10.1.1 connect-interface loopback 0
[Router_3-bgp]peer 10.10.1.1 ebgp-max-hop
[Router_3-bgp]peer 10.10.2.2 as-number 234
[Router_3-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_3-bgp]peer 10.10.2.2 next-hop-local
[Router_3-bgp]peer 10.10.4.4 as-number 234
[Router_3-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_3-bgp]peer 10.10.4.4 next-hop-local

-------------------------AR4-------------------------
<Huawei>system-view
[Huawei]sysname Router_4
[Router_4]interface loopback 0
[Router_4-LoopBack0]ip address 10.10.4.4 255.255.255.0
[Router_4-LoopBack0]interface s1/0/0
[Router_4-Serial1/0/0]ip address 1.1.24.4 255.255.255.0
[Router_4-Serial1/0/0]interface s1/0/1
[Router_4-Serial1/0/1]ip address 1.1.34.4 255.255.255.0
[Router_4-Serial1/0/1]interface s2/0/0
[Router_4-Serial2/0/0]ip address 1.1.45.4 255.255.255.0
[Router_4-Serial2/0/0]ospf 1 router-id 4.4.4.4
[Router_4-ospf-1]area 0
[Router_4-ospf-1-area-0.0.0.0]network 1.1.24.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]network 1.1.34.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]network 10.10.4.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.0]area 1
[Router_4-ospf-1-area-0.0.0.1]network 1.1.45.4 0.0.0.0
[Router_4-ospf-1-area-0.0.0.1]bgp 234
[Router_4-bgp]router-id 4.4.4.4
[Router_4-bgp]peer 10.10.2.2 as-number 234
[Router_4-bgp]peer 10.10.2.2 connect-interface loopback 0
[Router_4-bgp]peer 10.10.2.2 next-hop-local
[Router_4-bgp]peer 10.10.3.3 as-number 234
[Router_4-bgp]peer 10.10.3.3 connect-interface loopback 0
[Router_4-bgp]peer 10.10.3.3 next-hop-local
[Router_4-bgp]peer 10.10.5.5 as-number 5
[Router_4-bgp]peer 10.10.5.5 connect-interface loopback 0
[Router_4-bgp]peer 10.10.5.5 ebgp-max-hop

-------------------------AR5-------------------------
<Huawei>system-view
[Huawei]sysname Router_5
[Router_5]interface loopback 0
[Router_5-LoopBack0]ip address 10.10.5.5 255.255.255.0
[Router_5-LoopBack0]interface s2/0/0
[Router_5-Serial2/0/0]ip address 1.1.45.5 255.255.255.0
[Router_5-Serial2/0/0]ospf 1 router-id 5.5.5.5
[Router_5-ospf-1]area 1
[Router_5-ospf-1-area-0.0.0.1]network 10.10.5.5 0.0.0.0
[Router_5-ospf-1-area-0.0.0.1]network 1.1.45.5 0.0.0.0
[Router_5-ospf-1-area-0.0.0.1]bgp 5
[Router_5-bgp]router-id 5.5.5.5
[Router_5-bgp]peer 10.10.1.1 as-number 1
[Router_5-bgp]peer 10.10.1.1 connect-interface loopback 0
[Router_5-bgp]peer 10.10.1.1 ebgp-max-hop
[Router_5-bgp]peer 10.10.4.4 as-number 234
[Router_5-bgp]peer 10.10.4.4 connect-interface loopback 0
[Router_5-bgp]peer 10.10.4.4 ebgp-max-hop
```

## PrefVal

由于PrefVal仅本地生效，因此PrefVal的值都是人为主动设置的，代表本地用户的意愿，BGP在进行选路时会优先比较协议首选值。在R4上新增宣告一条BGP路由`104.1.1.0/24`，这条路由分别会通过R2、R4、R5宣告到R1，缺省情况下R1的`104.1.1.0/24`路由下一跳指向R2。通过修改协议首选值可以实现手动优选`104.1.1.0/24`的路由下一跳，PrefVal仅本地有效，因此需要在哪台节点上手动优选路由，就需要在哪台节点上修改协议首选值。例如需要在R1上手动优选路由，就需要直接在R1上修改协议首选值



```yaml
[Router_4]interface loopback 104
[Router_4-LoopBack104]ip address 104.1.1.4 255.255.255.0
[Router_4-LoopBack104]bgp 234
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]network 104.1.1.0 255.255.255.0



[Router_1]bgp 1
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 10.10.5.5 preferred-value 5
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 3
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   104.1.1.0/24       10.10.5.5                             5      5 234i
 *                       10.10.2.2                             0      234i
 *                       10.10.3.3                             0      234i



[Router_1-bgp-af-ipv4]acl 2000
[Router_1-acl-basic-2000]rule 5 permit source 104.1.1.0 0.0.0.0
[Router_1-acl-basic-2000]route-policy policy_A permit node 10    //通过路由策略修改PrefVal的方式更加精确
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply preferred-value 10 
[Router_1-route-policy]route-policy policy_A permit node 20
[Router_1-route-policy]bgp 1
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 10.10.3.3 route-policy policy_A import 
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 3
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   104.1.1.0/24       10.10.3.3                             10     234i
 *                       10.10.5.5                             5      5 234i
 *                       10.10.2.2                             0      234i
```

> **配置回退**
>
> [Router_1]bgp 1<br />
> [Router_1-bgp]ipv4-family unicast<br />
> [Router_1-bgp-af-ipv4]undo peer 10.10.5.5 preferred-value<br />
> [Router\_1-bgp-af-ipv4]undo peer 10.10.3.3 route-policy policy\_A import

## 路由生成方式

按照路由生成方式进行优先级排序，从高到低简写为 A>S>N>I>L，本地引入路由优先级高于从邻居学习到的路由。在R1上新增引入一条BGP路由，并同时使用手动聚合和自动聚合配置，查看路由详细信息，优先使用手动聚合路由

```yaml
[Router_1]interface loopback 11
[Router_1-LoopBack11]ip address 11.1.1.1 255.255.255.0
[Router_1-LoopBack11]route-policy policy_A permit node 10
[Router_1-route-policy]if-match interface loopback 11
[Router_1-route-policy]bgp 1
[Router_1-bgp]import-route direct route-policy policy_A
[Router_1-bgp]aggregate 11.0.0.0 255.0.0.0
[Router_1-bgp]summary automatic
[Router_1-bgp]display bgp routing-table 11.0.0.0

 BGP local router ID : 1.1.1.1
 Local AS number : 1
 Paths:   2 available, 1 best, 1 select
 BGP routing table entry information of 11.0.0.0/8:
 Aggregated route.    //BGP路由信息使用手动聚合
 Route Duration: 00h00m00s  
 Direct Out-interface: NULL0
 Original nexthop: 127.0.0.1
 Qos information : 0x0
 AS-path Nil, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
 Aggregator: AS 1, Aggregator ID 1.1.1.1
 Advertised to such 3 peers:
    10.10.2.2
    10.10.5.5
    10.10.3.3
 BGP routing table entry information of 11.0.0.0/8:
 Summary automatic route
 Route Duration: 00h00m00s  
 Direct Out-interface: NULL0
 Original nexthop: 127.0.0.1
 Qos information : 0x0
 AS-path Nil, origin incomplete, pref-val 0, valid, local, pre 255, not preferred for route type
 Aggregator: AS 1, Aggregator ID 1.1.1.1
 Not advertised to any peer yet
```

> **配置回退**
>
> [Router_1]bgp 1<br />
> [Router_1-bgp]undo import-route direct<br />
> [Router_1-bgp]undo aggregate 11.0.0.0 255.0.0.0<br />
> [Router_1-bgp]undo summary automatic

## AS\_Path

在AS\_Path列表中记录的AS号本身的大小不会影响路由选路，AS号的个数会影响路由选路。在R1上新增宣告一条`101.1.1.0/24`路由，该路由会通过R2、R3、R5传递到R4，通过R5传递到R4的路由AS\_Path属性会存在2个AS号，那么该路由选路比较到第5条时R5就不会作为路由最优的下一跳。在R4上忽略选路原则中比较AS\_Path属性，根据选路原则会比较到第8条，优选从EBGP邻居学习到的路由

```yaml
[Router_1]interface loopback 101
[Router_1-LoopBack101]ip address 101.1.1.1 255.255.255.0
[Router_1-LoopBack101]bgp 1
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]network 101.1.1.0 255.255.255.0



[Router_4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  101.1.1.0/24       10.10.2.2       0          100        0      1i
 * i                     10.10.3.3       0          100        0      1i
 *                       10.10.5.5                             0      5 1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i

[Router_4]bgp 234
[Router_4-bgp]bestroute as-path-ignore
[Router_4-bgp]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       10.10.5.5                             0      5 1i
 * i                     10.10.2.2       0          100        0      1i
 * i                     10.10.3.3       0          100        0      1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i

[Router_4-bgp]display bgp routing-table 101.1.1.0

 BGP local router ID : 4.4.4.4
 Local AS number : 234
 Paths:   3 available, 1 best, 1 select
 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.5.5 (5.5.5.5)
 Route Duration: 03h54m18s  
 Relay IP Nexthop: 1.1.45.5
 Relay IP Out-Interface: Serial2/0/0
 Original nexthop: 10.10.5.5
 Qos information : 0x0
 AS-path 5 1, origin igp, pref-val 0, valid, external, best, select, active, pre 255, IGP cost 48
 Advertised to such 2 peers:
    10.10.2.2
    10.10.3.3
 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.2.2 (2.2.2.2)
 Route Duration: 00h34m55s  
 Relay IP Nexthop: 1.1.24.2
 Relay IP Out-Interface: Serial1/0/0
 Original nexthop: 10.10.2.2
 Qos information : 0x0
 AS-path 1, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 48, not preferred for peer type    //路由没有被优选的理由，对等类型不首选
 Not advertised to any peer yet

...
```

> **配置回退**
>
> [Router_4]bgp 234<br />
> [Router_4-bgp]undo bestroute as-path-ignore

## Origin

Origin起源属性可以通过始发者或路由策略进行修改。始发者通过修改BGP路由的生成方式实现修改起源属性，例如R1的路由`101.1.1.0/24`，在R1上通过本地宣告或引入宣告会导致该路由起源属性的变更，在BGP路由的发布与传递小节中对BGP路由的宣告方式有过说明。通过路由策略可以实现在R4的BGP表中，写入同一目标网络但起源属性不同的3条路由。缺省情况下，R4优选R2作为`101.1.1.0/24`路由的下一跳，修改下一跳为R2的路由起源属性为`?`时R4优选下一跳为R3、修改下一跳为R3的路由起源属性为`e`时R4优选下一跳仍为R3，但取消掉R2的路由策略后R4优选下一跳为R2

```yaml
[Router_4]acl 2000
[Router_4-acl-basic-2000]rule 5 permit source 101.1.1.0 0.0.0.0
[Router_4-acl-basic-2000]route-policy policy_A permit node 10
[Router_4-route-policy]if-match acl 2000
[Router_4-route-policy]apply origin incomplete
[Router_4-route-policy]route-policy policy_A permit node 20
[Router_4-route-policy]bgp 234
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 10.10.2.2 route-policy policy_A import
[Router_4-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  101.1.1.0/24       10.10.3.3       0          100        0      1i
 * i                     10.10.2.2       0          100        0      1?
 *                       10.10.5.5                             0      5 1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i



[Router_4-bgp]route-policy policy_B permit node 10
[Router_4-route-policy]if-match acl 2000
[Router_4-route-policy]apply origin egp 234
[Router_4-route-policy]route-policy policy_B permit node 20
[Router_4-route-policy]bgp 234
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 10.10.3.3 route-policy policy_B import
[Router_4-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  101.1.1.0/24       10.10.3.3       0          100        0      1e
 * i                     10.10.2.2       0          100        0      1?
 *                       10.10.5.5                             0      5 1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i



[Router_4-bgp-af-ipv4]undo peer 10.10.2.2 route-policy policy_A import
[Router_4-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  101.1.1.0/24       10.10.2.2       0          100        0      1i
 * i                     10.10.3.3       0          100        0      1e
 *                       10.10.5.5                             0      5 1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i
```

> **配置回退**
>
> [Router_4]bgp 234<br />
> [Router_4-bgp]ipv4-family unicast<br />
> [Router\_4-bgp-af-ipv4]undo peer 10.10.3.3 route-policy policy\_B import

## MED

R4上的BGP路由`104.1.1.0/24`分别会通过R2、R4、R5宣告到R1，默认R1的`104.1.1.0/24`路由下一跳指向R2。在R1上将从R2学习到的路由MED值修改为200、从R3学习到的路由MED值修改为300、从R5学习到的路由MED值修改为100，并将从R2、R3学习到的路由添加一个相同的AS号在左侧。缺省情况下，一条路由的多个下一跳的临近的AS号相同时会比较MED，临近的AS号不同时跳过MED比较。例如MED配置修改后，虽然R5的MED值最低，但R5与R2、R3临近的AS 10并不相同，因此在比较MED的过程中R5被跳过，R2、R3的MED比较结果是R2胜出，然后再由R2与R5继续后续的BGP选路规则比较

```yaml
[Router_1]route-policy policy_A permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply cost 200
[Router_1-route-policy]apply as-path 10 additive
[Router_1-route-policy]route-policy policy_A permit node 20
[Router_1-route-policy]route-policy policy_B permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply cost 300
[Router_1-route-policy]apply as-path 10 additive
[Router_1-route-policy]route-policy policy_B permit node 20
[Router_1-route-policy]route-policy policy_C permit node 10
[Router_1-route-policy]if-match acl 2000
[Router_1-route-policy]apply cost 100
[Router_1-route-policy]route-policy policy_C permit node 20
[Router_1-route-policy]bgp 1
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 10.10.2.2 route-policy policy_A import
[Router_1-bgp-af-ipv4]peer 10.10.3.3 route-policy policy_B import
[Router_1-bgp-af-ipv4]peer 10.10.5.5 route-policy policy_C import
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       0.0.0.0         0                     0      i
 *>   104.1.1.0/24       10.10.2.2       200                   0      10 234i
 *                       10.10.3.3       300                   0      10 234i
 *                       10.10.5.5       100                   0      5 234i



[Router_1-bgp-af-ipv4]compare-different-as-med    //无论临近的AS号是否相同，均比较不同AS邻居的MED值
[Router_1-bgp-af-ipv4]display bgp routing-table 

 BGP Local router ID is 1.1.1.1 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       0.0.0.0         0                     0      i
 *>   104.1.1.0/24       10.10.5.5       100                   0      5 234i
 *                       10.10.2.2       200                   0      10 234i
 *                       10.10.3.3       300                   0      10 234i
```

在执行`compare-different-as-med`命令后不进行判断路由临近的AS号是否相同，均对MED进行比较，R5的MED值最小被优选

> **配置回退**
>
> [Router_1]bgp 1<br />
> [Router_1-bgp]undo compare-different-as-med<br />
> [Router\_1-bgp]undo peer 10.10.2.2 route-policy policy\_A import<br />
> [Router\_1-bgp]undo peer 10.10.3.3 route-policy policy\_B import<br />
> [Router\_1-bgp]undo peer 10.10.5.5 route-policy policy\_C import

## EBGP>IBGP

在R4上学习到的`101.1.1.0/24`路由没有优选R5是因为根据BGP选路原则第5条淘汰了R5，那么在跳过比较AS\_Path时再观察R4的BGP表。根据BGP路由优选13条规则，规则1~7都是相同的，根据第8条规则EBGP优先级高于IBGP优选R5作为下一跳

```yaml
[Router_4]bgp 234
[Router_4-bgp]bestroute as-path-ignore
[Router_4-bgp]display bgp routing-table 

 BGP Local router ID is 4.4.4.4 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       10.10.5.5                             0      5 1i
 * i                     10.10.2.2       0          100        0      1i
 * i                     10.10.3.3       0          100        0      1i
 *>   104.1.1.0/24       0.0.0.0         0                     0      i
```

> **配置回退**
>
> [Router_4]bgp 234<br />
> [Router_4-bgp]undo bestroute as-path-ignore

## 优选IGP开销最低的路由

根据BGP路由宣告规则，R4从IBGP邻居学习到的路由会传递给EBGP邻居R5，R5能够分别从R4、R1学到`101.1.1.0/24`的路由，但此时R5根据BGP选路规则第5条优选R1作为下一跳。在R5上跳过AS\_Path的比较后，根据BGP路由优选的13条规则，前8条规则全部匹配相同，直到匹配第9条规则优选IGP开销最低的路由，那么查看R5的IP路由表并对比`10.10.1.1/32`和`10.10.4.4/32`的开销值分别为48、97，因此优选R4。将R4的loopback\_0端口的OSPF cost值变更为更大值，此时R5的IP路由表开销值也会产生变化，再观察R5的BGP表，优选路由随之产生变化

```yaml
[Router_5]bgp 5
[Router_5-bgp]bestroute as-path-ignore
[Router_5-bgp]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       10.10.4.4                             0      234 1i
 *                       10.10.1.1       0                     0      1i
 *>   104.1.1.0/24       10.10.4.4       0                     0      234i
 *                       10.10.1.1                             0      1 234i
[Router_5-bgp]display ip routing-table 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 20       Routes : 20       

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       1.1.24.0/24  OSPF    10   96          D   1.1.45.4        Serial2/0/0
       1.1.34.0/24  OSPF    10   96          D   1.1.45.4        Serial2/0/0
       1.1.45.0/24  Direct  0    0           D   1.1.45.5        Serial2/0/0
       1.1.45.4/32  Direct  0    0           D   1.1.45.4        Serial2/0/0
       1.1.45.5/32  Direct  0    0           D   127.0.0.1       Serial2/0/0
     1.1.45.255/32  Direct  0    0           D   127.0.0.1       Serial2/0/0
      1.1.123.0/27  OSPF    10   97          D   1.1.45.4        Serial2/0/0
      10.10.1.1/32  OSPF    10   97          D   1.1.45.4        Serial2/0/0
      10.10.2.2/32  OSPF    10   96          D   1.1.45.4        Serial2/0/0
      10.10.3.3/32  OSPF    10   96          D   1.1.45.4        Serial2/0/0
      10.10.4.4/32  OSPF    10   48          D   1.1.45.4        Serial2/0/0
      10.10.5.0/24  Direct  0    0           D   10.10.5.5       LoopBack0
      10.10.5.5/32  Direct  0    0           D   127.0.0.1       LoopBack0
    10.10.5.255/32  Direct  0    0           D   127.0.0.1       LoopBack0
      101.1.1.0/24  EBGP    255  0          RD   10.10.4.4       Serial2/0/0
      104.1.1.0/24  EBGP    255  0          RD   10.10.4.4       Serial2/0/0
      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0



[Router_4]interface loopback 0
[Router_4-LoopBack0]ospf cost 400



[Router_5]display bgp routing-table 

 BGP Local router ID is 5.5.5.5 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>   101.1.1.0/24       10.10.1.1       0                     0      1i
 *                       10.10.4.4                             0      234 1i
 *>   104.1.1.0/24       10.10.1.1                             0      1 234i
 *                       10.10.4.4       0                     0      234i
```

> **配置回退**
>
> [Router_4]interface loopback 0<br />
> [Router_4-LoopBack0]undo ospf cost

## 负载

**负载的匹配条件**

1. 手动开启BGP等价路由配置
2. EBGP路由的AS\_Path属性不同时无法进行负载
3. 如果路由穿越了联邦，穿越不同的联邦的两条路由无法进行负载
4. 负载仅仅是路由表，BGP表回继续向下比较直到选出一条best路径

将R4与R5的EBGP邻居关系断开后，R4的BGP表中的路由`101.1.1.0/24`就只会从R2、R3学习到，根据BGP选路规则对比，两条路由的前9条匹配条件完全相同，此时路由的两个下一跳不同，接下来可以进行BGP等价路由的比较。BGP路由缺省情况下不开启负载，因此先设置形成负载分担的等价路由的最大条数为2，因为`R2-R4`、`R3-R4`都是IBGP邻居关系，因此设置等价路由时指定ibgp。在设置等价路由的条数前后观察R4的BGP表和IP路由表，等价路由的条数无法影响到BGP表，仅针对路由表进行负载分担

```yaml
[Router_4]bgp 234
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 10.10.5.5 ignore
[Router_4-bgp-af-ipv4]display bgp routing-table
[Router_4-bgp-af-ipv4]display ip routing-table 101.1.1.0
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 1
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      101.1.1.0/24  IBGP    255  0          RD   10.10.2.2       Serial1/0/0

[Router_4-bgp-af-ipv4]maximum load-balancing ibgp 2
[Router_4-bgp-af-ipv4]display bgp routing-table
[Router_4-bgp-af-ipv4]display ip routing-table 101.1.1.0
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table : Public
Summary Count : 2
Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      101.1.1.0/24  IBGP    255  0          RD   10.10.2.2       Serial1/0/0
                    IBGP    255  0          RD   10.10.3.3       Serial1/0/1
```

## Cluster_List

将R1-R3之间的BGP邻居关系断开，并将R4设置为路由反射器、R2设置为Client，R2从R1学习到的路由会传递给R3、R4，根据路由反射规则第2条，RR会将从Client处学习到的路由传递给除始发者以外的所有邻居。查看R3的BGP表时无法明显观察出优选路由，在R3上查看`101.1.1.0/24`路由的详细信息时，Router ID为`2.2.2.2`的下一跳被优选，根据BGP选路原则第11条比较Cluster\_List的长度，Router ID为`2.2.2.2`的下一跳的路由信息中未携带Cluster\_List字段

```yaml
[Router_1]bgp 1
[Router_1-bgp]ipv4-family unicast
[Router_1-bgp-af-ipv4]peer 10.10.3.3 ignore



[Router_4]bgp 234
[Router_4-bgp]ipv4-family unicast
[Router_4-bgp-af-ipv4]peer 10.10.2.2 reflect-client



[Router_3-bgp]display bgp routing-table 

 BGP Local router ID is 3.3.3.3 
 Status codes: * - valid, > - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete

 Total Number of Routes: 3
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *>i  101.1.1.0/24       10.10.2.2       0          100        0      1i
 * i                     10.10.2.2       0          100        0      1i
 *>i  104.1.1.0/24       10.10.4.4       0          100        0      i
[Router_3-bgp]display bgp routing-table 101.1.1.0

 BGP local router ID : 3.3.3.3
 Local AS number : 234
 Paths:   2 available, 1 best, 1 select
 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.2.2 (2.2.2.2)
 Route Duration: 00h45m33s  
 Relay IP Nexthop: 1.1.34.4
 Relay IP Out-Interface: Serial1/0/0
 Original nexthop: 10.10.2.2
 Qos information : 0x0
 AS-path 1, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost 96
 Not advertised to any peer yet

 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.4.4 (4.4.4.4)
 Route Duration: 00h03m07s  
 Relay IP Nexthop: 1.1.34.4
 Relay IP Out-Interface: Serial1/0/0
 Original nexthop: 10.10.2.2
 Qos information : 0x0
 AS-path 1, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 96, not preferred for Cluster List
 Originator:  2.2.2.2
 Cluster list: 4.4.4.4
 Not advertised to any peer yet
```

BGP选路规则第12条，Originator ID的比较仍与路由反射器相关，一个路由器节点从多个RR收到去往同一目标网络的路由时，如果BGP选路规则前11条完全匹配，则会进行Originator ID的比较。例如，对BGP选路拓扑新增2台路由器R6、R7，将R4的连接位置下沉，R2与R6互联、R3与R7互联、R4再与R6、R7互联，将R6、R7设置为路由反射器，R4在BGP选路规则前11条完全匹配的情况下，就会进行Originator ID的比较

![BGP选路原则-OriginatorID](file:///${DB}/image/LAB/BGP/BGP%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99-OriginatorID.png)

> **配置回退**
>
> [Router_1]bgp 1<br />
> [Router_1-bgp]undo peer 10.10.3.3 ignore

## Router ID

将选路拓扑中的反射器配置还原后，R4与R5的EBGP邻居关系保持断开，R4的BGP表中的路由`101.1.1.0/24`会从R2、R3学习到，在路由不经过路由反射器的情况下可以直接跳过BGP选路规则第11、12条，也就是说从负载直接跳到对比Router ID。同时这也说明，在选路拓扑的基础配置下，R4的`101.1.1.0/24`路由缺省下一跳就是R2，这就是根据BGP选路规则第13条选举得来的

```yaml
[Router_4]display bgp routing-table 101.1.1.0

 BGP local router ID : 4.4.4.4
 Local AS number : 234
 Paths:   2 available, 1 best, 2 select
 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.2.2 (2.2.2.2)
 Route Duration: 00h08m39s  
 Relay IP Nexthop: 1.1.24.2
 Relay IP Out-Interface: Serial1/0/0
 Original nexthop: 10.10.2.2
 Qos information : 0x0
 AS-path 1, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost 48
 Not advertised to any peer yet

 BGP routing table entry information of 101.1.1.0/24:
 From: 10.10.3.3 (3.3.3.3)
 Route Duration: 00h08m24s  
 Relay IP Nexthop: 1.1.34.3
 Relay IP Out-Interface: Serial1/0/1
 Original nexthop: 10.10.3.3
 Qos information : 0x0
 AS-path 1, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, select, active, pre 255, IGP cost 48, not preferred for router ID
 Not advertised to any peer yet
```

## Peer地址

BGP选路规则第14条应用场景较少，可能会用在两个BGP邻居之间既建立了物理端口邻居又建立了回环口邻居的场景，或两个BGP邻居之间存在多条物理链路并在多条物理链路上都建立的BGP邻居关系的场景，一般情况下不会比较到BGP选路规则第14条

![BGP选路原则-PeerIP](file:///${DB}/image/LAB/BGP/BGP%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99-PeerIP.png)

