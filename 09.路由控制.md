# 路由控制

在企业网络的设备通信中为了保证数据访问的安全性、提高链路带宽利用率，就需要对网络流量行为进行控制，如控制流量可达性、调整网络流量路径等，面对更加复杂、精细的流量控制需求时就需要灵活的使用一些工具来实现，单纯的通过路由协议计算出的路由一定是最优的，但最优的路由并不一定能满足实际的业务需求

**控制网络流量可达性**

通过两种方式能够实现控制网络流量的可达性：路由策略、策略路由，两者名称相近，但不是同一个东西

- 路由策略：通过修改路由条目，对接收和发布的路由进行过滤，来控制流量可达性
- 策略路由：依据用户制定的策略进行转发，该策略优于路由表转发

**调整网络流量路径**

- 路由策略：修改协议属性来控制路由表条目
- 策略路由：查找路由表之前控制流量行为

## 路由策略

路由策略就是通过一系列工具或方法对路由进行各种控制的策略，影响路由的产生、发布、选择，进而影响报文的转发。其最终的目的就是为了对路由进行过滤（要不要这条路由？）和修改路由属性。路由策略的作用能够控制路由的接收、发布和引入，提高网络安全性，也能通过修改路由属性，对网络数据流量进行合理规划，提高网络性能

**实现机制**

路由策略的核心内容是过滤器，通过过滤器定义一组匹配规则

|                   过滤器                   |    应用范围    |
| :----------------------------------------: | :------------: |
|            访问控制列表（ACL）             | 各动态路由协议 |
|       地址前缀列表（IP-Prefix List）       | 各动态路由协议 |
|       AS路径过滤器（AS-Path-Filter）       |    BGP协议     |
|     团体属性过滤器（Community-Filter）     |    BGP协议     |
| 扩展团体属性过滤器（Extcommunity-Filter）  |      VPN       |
| RD属性过滤器（Route Distinguisher-Filter） |      VPN       |
|          路由策略（Route-Policy）          | 各动态路由协议 |

Route-Policy可以使用前面6种过滤器定义自己的匹配规则，不仅可以匹配路由属性，还可以修改路由属性

![路由策略各工具间的调用关系](https://www.z4a.net/images/2023/10/12/f3a9a09390046b46fd1f02bff6130525.png)

|   类型   |                             备注                             |
| :------: | :----------------------------------------------------------: |
| 条件工具 | 把需要的路由“抓取”出来。此工具单独使用没有任何意义，如同此前ACL的特性，只配置ACL是没有用的，必须要在某个端口调用规则才会生效 |
| 策略工具 |   把“抓取”出的路由执行某个动作，如允许、拒绝、修改、属性等   |
| 调用工具 |         将路由策略应用到某个具体的路由协议，使其生效         |

### IP-Prefix List

能同时精准匹配网络号和前缀长度，性能及可用性比ACL更高，ACL无法匹配掩码/前缀长度，但前缀列表不能用于数据包的过滤

```VRP
#AR1
<AR1>sys
<AR1>sys AR1
[AR1]inte g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 12.0.0.1 24
[AR1]ospf 1 router-id 1.1.1.1
[AR1-ospf-1]area 0
[AR1-ospf-1-area-0.0.0.0]net 12.0.0.0 0.0.0.255
[AR1-ospf-1-area-0.0.0.0]ip route-static 192.168.0.0 16 NULL 0
[AR1]ip route-static 192.168.0.0 24 NULL 0
[AR1]ospf 1
[AR1-ospf-1]import-route static

#AR2
<Huawei>sys
[Huawei]sys AR2
[AR2]inte g0/0/0
[AR2-GigabitEthernet0/0/0]ip add 12.0.0.2 24
[AR2-GigabitEthernet0/0/0]ospf 1 router-id 2.2.2.2
[AR2-ospf-1]area 0
[AR2-ospf-1-area-0.0.0.0]net 12.0.0.0 0.0.0.255
[AR2-ospf-1-area-0.0.0.0]dis ip routing-table pro ospf
```

在上例中，指定静态路由的时候如果下一跳地址不存在，则该路由在路由表中状态是Unknown，也不会对外发布该静态路由，所以静态路由的下一跳使用黑洞接口NULL，数据包转发到NULL时会直接丢弃。同理，引入路由的前提是该外部路由一定要在路由表里，不在路由表里则意味着对与该设备而言，该外部路由都不是最优路由，引入将无意义

在上例场景中需要实现仅允许16网段的路由能够通过，通过ACL基本无法实现，ACL的过滤会将两个网段一并过滤

```VRP
#AR1
[AR1]acl 2000
[AR1-acl-basic-2000]rule 5 permit source 192.168.0.0 0.0.255.255
[AR1-acl-basic-2000]ospf 1
[AR1-ospf-1]filter-policy 2000 export	#export表示出方向匹配ACL

#AR2
[AR2]dis ip routing-table	#通过路由表可以查看到AR1的ACL并未过滤掉24网段

#AR1	
[AR1]ip ip-prefix hebor permit 192.168.0.0 16	#直接定义允许通过的掩码,hebor表示该前缀列表策略的名称
[AR1]ospf 1 
[AR1-ospf-1]filter-policy ip-prefix hebor export
```

与ACL一样，一条前缀列表下可以写多条规则，与ACL不同的是,如果所有前缀列表的规则都未匹配上，前缀列表缺省的操作是拒绝

**IP-Prefix语法规则**

IP-Prefix是存在其他范围性的参数可以配置的，以`ip-prefix hebor permit 192.168.0.0 16 greater-equal 24 less-equal 28`为例

| 语法规则 | 备注 |
| :-- | :-- |
| 不配置greater-equal和less-equal | IP地址范围为16，且子网掩码也是16，IP地址范围为16表示网络地址的前16位必须完全一致，也就是192.168.x.x |
| 配置greater-equal |掩码长度是24~32，IP地址范围为16意味着规则允许192.168.0.0/24~32网络地址通过 |
| 配置less-equal | 掩码长度是16~28，less-equal表示掩码必须小于等于28，同时前缀长度是16，所以掩码长度范围限制在16~28之间 |
| 同时配置greater-equal和less-equal | IP地址范围为16，前缀长度为24~28，允许通过网络地址范围是192.168.0.0/24~28 |

greater-equal和less-equal的前缀长度生效的优先级更高，ip-prefix中没有any参数，所以如果ip-prefix要允许所有路由通过就需要涵盖所有掩码范围，例如`permit 0.0.0.0 0 less 32`，而主机路由仍使用32位掩码即可

|       特殊的通配地址       |         含义         |
| :------------------------: | :------------------: |
|         0.0.0.0 0          |  表示只匹配缺省路由  |
|  0.0.0.0 0 less-equal 32   |   表示匹配所有路由   |
| 0.0.0.0 0 greater-equal 32 | 表示匹配所有主机路由 |

### Filter-policy

一种常用的路由过滤工具，只能过滤路由，无法过滤LSA，不能修改路由属性。路由过滤工具对LSA是没有办法的，每个LSDB的LSA都是完全同步的，所以能够间接影响LSA的手段就只能在*LSDB生成路由表的过程*和*路由表生成LSA的过程*进行干预

| 路由类型 | 路由传递原理 |
| :-: | :-: |
| 距离矢量 | 过滤路由的发送和接受 |
| 链路状态 | 过滤路由表的生成，不影响LSDB的完整性 |

#### Filter-Policy过滤的几种场景

![OSPF出入方向路由](https://www.z4a.net/images/2023/10/12/OSPF.png)

从其他路由器节点收到的LSA录入到LSDB后，需要经过SPF算法计算出最优路由，生成的最优路由会写入路由表，在写入路由表的过程中通过Filter-Policy可以过滤*入方向*的路由。OSPF中能在出接口过滤的只有5类LSA，也就是引入路由，这意味着路由器必须是ASBR

**RIP过滤路由**

![RIP出入方向过滤路由](https://www.z4a.net/images/2023/10/12/RIP.png)

RIP没有区域的概念，在SwitchB上过滤*入方向*的192.168.3.0网络后，SwitchB的路由表中自然就没有192.168.3.0的路由，那么SwitchB再向邻居发送路由表的时候，邻居也学不到192.168.3.0的路由了

**OSPF同区域过滤路由**

![OSPF单区域过滤路由](https://www.z4a.net/images/2023/10/12/OSPFc687193cbeb2bf4c.png)

OSPF同一区域下在*出方向*是无法过滤路由的，只能在*入方向*，也就是LSDB将最优路由写入路由表的过程中能够过滤路由。SwitchB在*入方向*过滤10.1.1.0的路由，那么它本身的路由表中就不会产生10.1.1.0的路由。但OSPF与RIP不同，同一区域内的所有LSDB都是统一数据的，由于Type1、Type2 LSA都是不能过滤的，SwitchC在没有过滤10.1.1.0网络的情况下，它的路由表中是存在该路由的

**OSPF区域间过滤路由**

![OSPF130f38e42192b6c3.png](https://www.z4a.net/images/2023/10/12/OSPF130f38e42192b6c3.png)


在SwitchB的*入方向*上过滤10.1.1.0网络，那么SwitchB自身的路由表中就不会产生10.1.1.0的路由，Type3 LSA由SwitchB的路由表计算生成，自然也不会带有10.1.1.0的路由，且OSPF不同区域间有不同的LSDB，所以SwitchC的LSDB收不到含有10.1.1.0路由的LSA，也就无法在路由表中产生该路由，这样就实现了过滤掉整个Area1的10.1.1.0的路由

### Route-Policy

一种强大而又复杂的过滤器，用于路由过滤和修改路由属性。在学习ACL时，ACL定义rule未强制要求写明规则编号，ACL的默认步长会自动填充编号，但Route-Policy的node编号必须手动指定

![Route-Policy](https://www.z4a.net/images/2023/10/21/Route-Policy.png)

- 一个route-policy可以由若干个node构成，node之间是“或”的关系
- 一个node可以由若干个if-match和apply子句组成
- if-match之间是“与”关系，必须要匹配所有条件，才能判定为匹配上该node

![Route-Policy匹配规则流程](https://www.z4a.net/images/2023/10/21/Route-Policye07257e7cf1b5c6d.png)

当一个node下没有任何子句时代表匹配所有路由，在构思过滤器的时候需要注意，如果仅需要拒绝某几条路由，那么在过滤器的结尾需要允许所有路由

route-policy的匹配模式相对比较复杂，route-policy自身存在两种模式permit和deny，而node下的条件acl或ip-prefix也存在两种操作permit和deny。因此，route-policy本身的模式和node下的条件操作就形成了4种排列组合

| Rule | Mode | 匹配结果 |
| :-: | :-: | :-- |
| permit | permit | - 匹配该node的if-match子句的路由，在本node允许通过route-policy，匹配结束<br /> - 不匹配if-match子句的路由，进行route-policy的下一个node匹配 |
| permit | deny | - 匹配该节点的if-match子句的路由，在本节点不允许通过route-policy，匹配结束<br /> - 不匹配if-match子句的路由，进行route-policy的下一个node的匹配 |
| deny | permit | - 匹配该节点if-match子句的路由，在本节点不允许通过route-policy，继续进行route-policy的下一个node的匹配<br /> - 不匹配if-match子句的路由，进行route-policy下一个node的匹配 |
| deny | deny | - 匹配该节点if-match子句的路由，在本节点不允许通过route-policy，继续匹配route-policy下一个node的匹配<br  /> - 不匹配if-match子句的路由，进行route-policy下一个node的匹配 |

- Rule表示if-match子句中包含的匹配模式是permit还是deny
- Mode表示route-policy中node节点对应的匹配模式是permit还是deny

**对于四种规则的理解概述**

- Rule是permit的前提下，Mode的模式决定了命中规则的路由该如何处理。Mode为permit时命中规则，允许通过；Mode为deny时命中规则，拒绝通过。路由未命中规则时都会进行route-policy的下一个node继续匹配
- Rule是deny的前提下，无论Mode的模式是什么，最终的结果都是拒绝通过。也就是说无论命中规则或未命中规则，最终都会进行route-policy的下一个node继续匹配

**关于匹配规则和动作**

| 匹配规则（if-match） | 描述 |
| :-: | :-- |
| acl | 匹配路由的目标IP的地址范围 |
| prefix-list | 匹配路由的目标IP的地址范围 |
| ip next-hop | 匹配路由的下一跳地址 |
| interface | 匹配路由的出接口 |
| route-type | 匹配路由类型 |
| tag | 匹配RIP、OSPF、IS-IS路由信息的标记 |
| cost | 匹配路由开销 |

| 动作（apply） | 描述 |
| :-: | :-- |
| ip-address next-hop | 修改过滤后的路由信息的下一跳地址 |
| preference | 修改过滤后的路由信息的优先级 |
| tag | 修改过滤后的RIP、OSPF、IS-IS的路由信息的标记 |
| cost | 修改过滤后的路由信息的开销值 |
| cost-type | 修改过滤后的路由信息的开销类型 |

匹配规则和动作是相辅相成的，动作实际上也就是修改路由属性

| 命令 | 描述 |
| :-- | :-- |
| route-policy hebor permit/deny node 10 | 创建route-policy |
| if-match acl 2000 | 配置匹配规则 |
| apply cost 10 | 配置应用动作 |
| display route-policy | 验证route-policy |

## 策略路由

策略路由和路由策略都可以影响数据包的转发过程，只不过两者对数据包的影响方式不同

**PBR**：Policy-Based-Route，该技术打破了路由表的传统选路规则，可以根据管理员定义的策略条件来选择性的转发数据包

**路由策略与策略路由的区别**

| 特性 | 特点 |
| :-: | :-- |
| 路由策略 | 1. 基于目标地址按路由表转发，通过路由策略可以影响路由表<br /> 2. 基于控制平面，为路由协议和路由表服务<br /> 3. 与路由协议结合完成策略<br /> 4. 应用命令：route-policy |
| 策略路由 | 1. 基于策略的转发，失败后再查找路由表转发<br /> 2. 基于转发平面，为转发策略服务<br /> 3. 需要手工逐跳配置，以保证报文按策略转发<br /> 4. 应用命令：policy-based-route |

- 路由策略中，拒绝的将不会被通过
- 策略路由中，拒绝的将做正常转发

路由策略以路由查找为主，它不看源地址和传输层、应用层的数据信息，它只看三层的目标IP然后查路由，因此，如果存在基于源IP或基于应用层服务的需求，就需要使用策略路由，策略路由打破了传统的路由查找的规则。策略路由需要手工在设备上配置，因为路由策略为路由协议和路由表服务，它可以基于路由协议学习到的路由相互影响；而策略路由是在哪台设备上配置后，该设备就会针对指定流量单独处理

![f63b3fb1097d39e58f2ac67eec64abb0.png](https://www.z4a.net/images/2023/10/21/f63b3fb1097d39e58f2ac67eec64abb0.png)

- 一个route-policy可以由若干个node构成，node之间是“或”的关系
- if-match之间是“与”关系，必须要匹配所有条件，才能判定为匹配上该node

![c02be08559fe9308c924435e9baf717c.png](https://www.z4a.net/images/2023/10/21/c02be08559fe9308c924435e9baf717c.png)

路由策略和策略路由命令结构和最终实现的功能都非常相似，但两者实现功能的方式和依据完全不一样，策略路由实现了跳过路由表并优于路由表先转发数据。策略路由也分为两种：

- **本地策略路由**：仅针对本机下发的报文进行处理，对转发的报文不起作用

- **接口策略路由**：仅对转发的报文起作用，对本地下发的报文不起作用

本地策略路由是指从交换机自身发送出去的流量，针对源头是自身的流量进行处理，大多数场景下都是配置接口策略路由

**本地策略路由配置**

| 命令 | 描述 |
| :-- | :-- |
| policy-based-route hebor permit node 10 | 创建PBR |
| if-match acl 2000 | 配置IP地址匹配条件 |
| if-match packet-length 64 1000 | 配置IP报文长度匹配条件 |
| apply output-interface g0/0/1 | 配置出站接口 |
| apply ip-address next-hop 12.0.0.2 | 配置下一跳 |
| ip local policy-based-route hebor | 调用PBR |

**接口策略路由配置**

通过流策略技术实现

```Topology
<AR1>=============<AR2>
```

```VRP
#----------------------AR1-----------------------
<Huawei>sys
[Huawei]sys AR1
[AR1]inte g0/0/0 
[AR1-GigabitEthernet0/0/0]ip add 1.0.0.1 24
[AR1-GigabitEthernet0/0/0]inte g0/0/1 
[AR1-GigabitEthernet0/0/1]ip add 2.0.0.1 24
[AR1-GigabitEthernet0/0/1]ip route-static 6.6.6.6 32 1.0.0.2
[AR1]ip route-static 7.7.7.7 32 2.0.0.2

#----------------------AR2-----------------------
<Huawei>sys
[Huawei]sys AR2
[AR2]inte g0/0/0 
[AR2-GigabitEthernet0/0/0]ip add 1.0.0.2 24
[AR2-GigabitEthernet0/0/0]inte g0/0/1 
[AR2-GigabitEthernet0/0/1]ip add 2.0.0.2 24
[AR2-GigabitEthernet0/0/1]inte loop 6
[AR2-LoopBack6]ip add 6.6.6.6 24
[AR2-LoopBack6]inte loop 7
[AR2-LoopBack7]ip add 7.7.7.7 24
```

此时AR1上已经具备两条通过不同链路去往AR2环回口的两条静态路由，此时通过抓包可以查看到ping测试两个换回口的过程。在真实网络环境中，大多数情况下可能无法抓包，因此，此处也可以通过查看两个端口收发的数据包数量来进行简单的判断

```VRP
#在测试环境下可以先清除端口的数据包计数器
<AR2>reset counters interface g0/0/0
<AR2>dis inte g0/0/0	#查看该端口分别收/发了多少个数据包。一次ping测试默认收到5个包，相应的回复也是5个包
```

目前正常情况下，访问6.6.6.6地址需要经过AR2的G0/0/0口，访问7.7.7.7地址需要经过AR2的G0/0/1口

```VRP
#策略工具
[AR1]policy-based-route hebor permit node 10
[AR1-policy-based-route-hebor-10]if-match acl 3000
[AR1-policy-based-route-hebor-10]apply output-interface g0/0/1
[AR1-policy-based-route-hebor-10]policy-based-route hebor permit node 20
[AR1-policy-based-route-hebor-20]if-match acl 3001
[AR1-policy-based-route-hebor-20]apply output-interface g0/0/0

#条件工具
[AR1-policy-based-route-hebor-20]acl 3000
[AR1-acl-adv-3000]rule 5 permit ip destination 6.6.6.6 0
[AR1-acl-adv-3000]acl 3001
[AR1-acl-adv-3001]rule 5 permit ip destination 7.7.7.7 0

#调用工具
[AR1-acl-adv-3001]ip local policy-based-route hebor	#由于是本地策略，不存在流量出、入方向
```

ACL匹配所有目标IP是6.6.6.6或7.7.7.7的路由，策略路由判断ACL条件，命中规则的路由修改出接口，在本地路由器上调用策略工具，最终实现访问6.6.6.6的流量都经过AR2的G0/0/1端口

### 以太网下的静态路由问题

通过策略路由实现了访问AR2的两个环回端口的链路反转，通过抓包信息可以明显观察到，再次访问7.7.7.7地址时，会经过AR2的G0/0/0端口，但此时两台路由器之间是不通的，抓包信息看到的也是AR1发出的ARP广播包。以访问7.7.7.7为例，AR1的G0/0/0端口IP是1.0.0.1，两个地址不在同一广播域，所以AR1发送的ARP广播包得不到7.7.7.7的回应

在路由技术章节有提及过，以太网环境下配置静态路由时，必须要指定下一跳地址，如果不指定下一跳地址而是指定出接口，那么**路由器就会认为该路由是自身路由器的直连路由**，所以路由器会向出接口发送ARP请求包。查看AR1的路由表也可以看到指定出接口的静态路由，其Flags标记为D，Flags标记为D的路由，设备都会直接向外发送ARP请求

此时策略路由确实实现了两条链路的访问反转的效果，现在是其他方面的问题，现在要解决通信问题有2种方法：ARP代理、

```VRP
#AR2开启ARP代理
[AR2]inte g0/0/0
[AR2-GigabitEthernet0/0/0]arp-proxy enable
[AR2-GigabitEthernet0/0/0]inte g0/0/1
[AR2-GigabitEthernet0/0/1]arp-proxy enable
```

