# 路由控制

在企业网络的设备通信中为了保证数据访问的安全性、提高链路带宽利用率，就需要对网络流量行为进行控制，如控制流量可达性、调整网络流量路径等，面对更加复杂、精细的流量控制需求时就需要灵活的使用一些工具来实现，单纯的通过路由协议计算出的路由一定是最优的，但最优的路由并不一定能满足实际的业务需求

**控制网络流量可达性**

通过两种方式能够实现控制网络流量的可达性：路由策略、策略路由，两者名称相近，但不是同一个东西

- 路由策略：通过修改路由条目，对接收和发布的路由进行过滤，来控制流量可达性
- 策略路由：依据用户制定的策略进行转发，该策略优于路由表转发

**调整网络流量路径**

- 路由策略：修改协议属性来控制路由表条目
- 策略路由：查找路由表之前控制流量行为

## 路由策略

路由策略就是通过一系列工具或方法对路由进行各种控制的策略，影响路由的产生、发布、选择，进而影响报文的转发。其最终的目的就是为了对路由进行过滤（要不要这条路由？）和修改路由属性。路由策略的作用能够控制路由的接收、发布和引入，提高网络安全性，也能通过修改路由属性，对网络数据流量进行合理规划，提高网络性能

**实现机制**

路由策略的核心内容时过滤器，通过过滤器定义一组匹配规则

|                   过滤器                   |    应用范围    |
| :----------------------------------------: | :------------: |
|            访问控制列表（ACL）             | 各动态路由协议 |
|       地址前缀列表（IP-Prefix List）       | 各动态路由协议 |
|       AS路径过滤器（AS-Path-Filter）       |    BGP协议     |
|     团体属性过滤器（Community-Filter）     |    BGP协议     |
| 扩展团体属性过滤器（Extcommunity-Filter）  |      VPN       |
| RD属性过滤器（Route Distinguisher-Filter） |      VPN       |
|          路由策略（Route-Policy）          | 各动态路由协议 |

Route-Policy可以使用前面6种过滤器定义自己的匹配规则，不仅可以匹配路由属性，还可以修改路由属性

![路由策略各工具间的调用关系](https://www.z4a.net/images/2023/10/12/f3a9a09390046b46fd1f02bff6130525.png)

|   类型   |                             备注                             |
| :------: | :----------------------------------------------------------: |
| 条件工具 | 把需要的路由“抓取”出来。此工具单独使用没有任何意义，如同此前ACL的特性，只配置ACL是没有用的，必须要在某个端口调用规则才会生效 |
| 策略工具 |   把“抓取”出的路由执行某个动作，如允许、拒绝、修改、属性等   |
| 调用工具 |         将路由策略应用到某个具体的路由协议，使其生效         |

### IP-Prefix List

能同时精准匹配网络号和前缀长度，性能及可用性比ACL更高，ACL无法匹配掩码/前缀长度，但前缀列表不能用于数据包的过滤

```VRP
#AR1
sys
sys AR1
inte g0/0/0
ip add 12.0.0.1 24
ospf 1 router-id 1.1.1.1
a 0 
net 12.0.0.1 0.0.0.0
ip route-static 192.168.0.0 16 NULL 0
ip route-static 192.168.0.0 24 NULL 0
a 0
import-route static

#AR2
sys
sys AR2
inte g0/0/0
ip add 12.0.0.2 24
ospf 1 router-id 2.2.2.2
a 0 
net 12.0.0.2 0.0.0.0
```

在上例中，指定静态路由的时候如果下一跳地址不存在，则该路由在路由表中状态是Unknown，也不会对外发布该静态路由，所以静态路由的下一跳使用黑洞接口NULL，数据包转发到NULL时会直接丢弃。同理，引入路由的前提是该外部路由一定要在路由表里，不在路由表里则意味着对与该设备而言，该外部路由都不是最优路由，引入将无意义

在上例场景中需要实现仅允许16网段的路由能够通过，通过ACL基本无法实现，ACL的过滤会将两个网段一并过滤

```VRP
#AR1
acl 2000
rule 5 permit source 192.168.0.0 0.0.255.255
ospf 1
filter-policy 2000 export	#export表示出方向匹配ACL

#AR2
dis ip routing-table	#通过路由表可以查看到AR1的ACL并未过滤掉24网段

#AR1
ip-prefix hebor permit 192.168.0.0 16	#直接定义允许通过的掩码,hebor表示该前缀列表策略的名称
ospf 1 
filter-policy ip-prefix hebor export
```

与ACL一样，一条前缀列表下可以写多条规则，与ACL不同的是,如果所有前缀列表的规则都未匹配上，前缀列表缺省的操作是拒绝

**IP-Prefix语法规则**

IP-Prefix是存在其他范围性的参数可以配置的，以`ip-prefix hebor permit 192.168.0.0 16 greater-equal 24 less-equal 28`为例

| 语法规则 | 备注 |
| 不配置greater-equal和less-equal | IP地址范围为16，且子网掩码也是16，IP地址范围为16表示网络地址的前16位必须完全一致，也就是192.168.x.x |
| 配置greater-equal |掩码长度是24~32，IP地址范围为16意味着规则允许192.168.0.0/24~32网络地址通过 |
| 配置less-equal | 掩码长度是16~28，less-equal表示掩码必须小于等于28，同时前缀长度是16，所以掩码长度范围限制在16~28之间 |
| 同时配置greater-equal和less-equal | IP地址范围为16，前缀长度为24~28，允许通过网络地址范围是192.168.0.0/24~28 |

greater-equal和less-equal的前缀长度生效的优先级更高，ip-prefix中没有any参数，所以如果ip-prefix要允许所有路由通过就需要涵盖所有掩码范围，例如`permit 0.0.0.0 0 less 32`，而主机路由仍使用32位掩码即可

|       特殊的通配地址       |         含义         |
| :------------------------: | :------------------: |
|         0.0.0.0 0          |  表示只匹配缺省路由  |
|  0.0.0.0 0 less-equal 32   |   表示匹配所有路由   |
| 0.0.0.0 0 greater-equal 32 | 表示匹配所有主机路由 |

### Filter-policy

一种常用的路由过滤工具，只能过滤路由，无法过滤LSA，不能修改路由属性。路由过滤工具对LSA是没有办法的，每个LSDB的LSA都是完全同步的，所以能够间接影响LSA的手段就只能在*LSDB生成路由表的过程*和*路由表生成LSA的过程*进行干预

| 路由类型 | 路由传递原理 |
| :-: | :-: |
| 距离矢量 | 过滤路由的发送和接受 |
| 链路状态 | 过滤路由表的生成，不影响LSDB的完整性 |

#### Filter-Policy过滤的几种场景

![OSPF出入方向路由](https://www.z4a.net/images/2023/10/12/OSPF.png)

从其他路由器节点收到的LSA录入到LSDB后，需要经过SPF算法计算出最优路由，生成的最优路由会写入路由表，在写入路由表的过程中通过Filter-Policy可以过滤*入方向*的路由。OSPF中能在出接口过滤的只有5类LSA，也就是引入路由，这意味着路由器必须是ASBR

**RIP过滤路由**

![RIP出入方向过滤路由](https://www.z4a.net/images/2023/10/12/RIP.png)

RIP没有区域的概念，在SwitchB上过滤*入方向*的192.168.3.0网络后，SwitchB的路由表中自然就没有192.168.3.0的路由，那么SwitchB再向邻居发送路由表的时候，邻居也学不到192.168.3.0的路由了

**OSPF同区域过滤路由**

![OSPF单区域过滤路由](https://www.z4a.net/images/2023/10/12/OSPFc687193cbeb2bf4c.png)

OSPF同一区域下在*出方向*是无法过滤路由的，只能在*入方向*，也就是LSDB将最优路由写入路由表的过程中能够过滤路由。SwitchB在*入方向*过滤10.1.1.0的路由，那么它本身的路由表中就不会产生10.1.1.0的路由。但OSPF与RIP不同，同一区域内的所有LSDB都是统一数据的，由于Type1、Type2 LSA都是不能过滤的，SwitchC在没有过滤10.1.1.0网络的情况下，它的路由表中是存在该路由的

**OSPF区域间过滤路由**

![OSPF130f38e42192b6c3.png](https://www.z4a.net/images/2023/10/12/OSPF130f38e42192b6c3.png)


在SwitchB的*入方向*上过滤10.1.1.0网络，那么SwitchB自身的路由表中就不会产生10.1.1.0的路由，Type3 LSA由SwitchB的路由表计算生成，自然也不会带有10.1.1.0的路由，且OSPF不同区域间有不同的LSDB，所以SwitchC的LSDB收不到含有10.1.1.0路由的LSA，也就无法在路由表中产生该路由，这样就实现了过滤掉整个Area1的10.1.1.0的路由