# STP

此前的STP章节中有提到，STP的BPDU类型有两种，由上向下用于选举根交换机以及确定每个交换机端口角色和状态的Configure BPDU、由下向上用于通知拓扑发生变更的TCN BPDU。TCN BPDU解决了MAC地址表的默认老化时间（300s）问题，二层数据转发依靠MAC地址表，即便通过STP解决了故障链路的问题，数据按照MAC地址表仍有可能会向故障Root Port转发导致通信失败

**网桥发送TCN BPDU的条件为**

- 有端口转变为Forwarding状态，且该网桥至少包含一个指定端口
- 有端口从Forwarding状态活Learning状态转变为Blocking状态

```Topology
    <SW1> 根桥
   /     \
<SW2>---<SW3>
```

以此拓扑示意图为例，假设SW2与根桥互联的Root Port故障，此时STP会恢复SW2的备用链路的通信，将SW2与SW3互联的链路重新选举为SW2的Root Port，那么此时SW2会发送TCN BPDU吗？由于此时SW2上没有指定端口，并且端口故障会回退到Disabled状态，因此SW2不会向上游发送TCP BPDU，反而是SW3是有可能发送TCN BPDU的。如果SW2与SW3互联的链路上，SW3的端口原本是阻塞端口，那么SW2重新选举Root Port后，SW3的阻塞端口会转变为Designated Port，并进入Forwarding状态。如果想要实现SW2向上游转发TCN BPDU，则在SW2的下游接上一个PC即可，一个PC则意味着一个指定端口

![TCA&TC置位的配置BPDU.png](https://www.z4a.net/images/2024/06/08/TCATCBPDU.png)

此前的STP章节中提到过BPDU标记字段有8个bit位，只不过STP仅使用首位和末位，MSTP是8位都使用；收到TCN类型的BPDU后，在标记字段中会标记TCA（Topology Change Acknowledgment）和TC（Topology Change）的值为1。STP的抓包数据中甚至都没有1~6置位的信息

# RSTP

STP协议虽然能够解决环路问题，但是由于网络拓扑收敛较慢，影响了用户通信质量，而且如果网络中的拓扑结构频繁变化，网络也会随之频繁失去连通性，从而导致用户通信频繁中断，这也是用户无法忍受的，由于STP的不足，IEEE于2001年发布的802.1w标准定义了RSTP。RSTP在STP基础上进行了诸多改进优化，使得协议更加清晰、规范，同时也实现了二层网络拓扑的快速收敛

## STP的五大问题

**一、设备开机运行STP初始化**

![STP五大问题其一](https://www.z4a.net/images/2024/06/08/STP.png)

由于STP的Forward Delay计时器，STP从初始状态到完全收敛至少需要30s

**二、直连链路故障**

![STP五大问题其二](https://www.z4a.net/images/2024/06/08/STP17e8540607a08b0e.png)

直连链路故障的场景对应的是SWC，SWC的Root Port故障后，由于Blocked Port一直从SWB的DP收到根桥的BPDU，因此SWC的Blocked Port转换为新的Root Port，经过2个Forward Delay超时后进入Forwarding状态

**三、非直连链路故障**

![STP五大问题其三](https://www.z4a.net/images/2024/06/08/STP2b620a78fef72f28.png)

非直连链路故障的场景对应的是SWB，SWB自身没有Blocked Port，也就意味着SWB不会从除Root Port以外的任何端口收到根桥的BPDU，那么当SWB的Root Port故障时，SWB不会立刻将Designated Port变更为Root Port，而是判断根桥故障，并认为自身就是新的根桥，向外发送自身的BPDU；SWC仍能正常收到根桥的BPDU，因此SWC对SWB的次优BPDU不做处理，直到STP的Max Age超时

**四、交换机连接用户终端**

![STP五大问题其四](https://www.z4a.net/images/2024/06/08/STP9f5eb80ad6c97c28.png)

交换机连接终端的链路进入转发都需要经过2次Forward Delay计时器，并且任何的变更（包括插拔网线）都有可能导致STP计算，影响到终端的连通性

**五、STP的拓扑变更机制**

![STP五大问题其五](https://www.z4a.net/images/2024/06/08/STP7a8248eb0506125c.png)

虽然通过TCN机制能够实现全网拓扑对齐，但TCN、TCA、TC的机制复杂，效率低下。在大二层环境下，由下游交换机逐层向上转发TCN报文、逐层向下转发TCA报文，根桥收到TCN报文后又向下游交换机转发TC报文，之后还需要等待老化时间

## RSTP

RSTP从STP发展而来，实现的基本思想一致，RSTP能够兼容STP运行，高版本的STP都能够兼容低版本的STP运行，包括MSTP也能够兼容STP运行，RSTP与STP的不同在于4点

- RSTP减少了端口状态
- RSTP增加了端口角色
- RSTP的BPDU格式及发送方式不同
- 当交换网络拓扑结构发生变化时，RSTP可以更快的恢复网络的连通性

### RSTP的变动

**基本抓包实验拓扑**

```Topology
    <SW1>
   /     \
<SW2>---<SW3>
```

```VRP
#----------------------------------SW1----------------------------------
system-view
sysname Switch_1
stp mode stp

#----------------------------------SW2----------------------------------
system-view
sysname Switch_2
stp mode stp

#----------------------------------SW3----------------------------------
system-view
sysname Switch_3
stp mode stp
```

修改STP模式后查看根桥属于哪个机器，修改SW1的优先级使其成为根桥，修改SW1优先级后可以频繁使用查看SW1的STP状态，很明显能观察到STP State由DISCARDING状态到LEARING、FORWADING状态的转变过程，非常直观的能感受到STP收敛速度之慢

```VRP
[Switch_1]stp priority 4096
[Switch_1]display stp brief
```

我的拓扑中SW2的另一个端口角色是阻塞端口，关闭SW2的Root Port后频繁查看SW2的STP状态可以观察到，即便拓扑中SW2就只有两个端口，关闭SW2的Root Port后SW2就只能选择阻塞端口成为新的Root Port，在这种情况下SW2的阻塞端口切换成Root Port仍需要经过2次Forward Delay计时器，理论上阻塞端口需要经过Listening、Learning、Forwarding三个状态，但eNSP上只能看到Discarding状态；恢复SW2的原Root Port观察STP状态，进一步感受STP的收敛速度之慢

```VRP
[Switch_2]interface g0/0/1
[Switch_2-GigabitEthernet0/0/1]shutdown
[Switch_2-GigabitEthernet0/0/1]display stp brief
[Switch_2-GigabitEthernet0/0/1]undo shutdown    #查看测试效果后重新开启端口
```

**RSTP将端口状态缩减为3个**

<table>
    <tr>
        <th>STP端口状态</th>
        <th>RSTP端口状态</th>
        <th>端口状态对应的行为</th>
    </tr>
    <tr>
        <td>Disabled</td>
        <td rowspan="3">Discarding</td>
        <td rowspan="3">不转发用户流量<br />不学习MAC地址</td>
    </tr>
    <tr>
        <td>Blocking</tr>
    </tr>
    <tr>
        <td>Listening</td>
    </tr>
    <tr>
        <td>Learning</td>
        <td>Learning</td>
        <td>不转发用户流量<br />学习MAC地址</td>
    </tr>
    <tr>
        <td>Forwarding</td>
        <td>Forwarding</td>
        <td>转发用户流量<br />学习MAC地址</td>
    </tr>
</table>

在eNSP模拟器上，即便运行STP协议也看不到5种端口状态，只能看到3种端口状态

**RSTP将端口角色增加到4个**

| 端口角色 | 说明 |
| :-- | :-- |
| Root Port<br />根端口 | 所在交换机上离根交换机最近的端口，处于转发状态 |
| Designated Port<br />指定端口 | 转发所连接的网段发往根交换机方向的数据<br />从根交换机方向发往所连接的网段的数据，处于转发状态 |
| Alternate Port<br />预备端口 | 根端口的备份，不处于转发状态 |
| Backup Port<br />备份端口 | 指定端口的备份，不处于转发状态 |

Alternate端口比较好理解，能够经常看到，但Backup端口不常见，Backup端口一般出现在两台交换机互联的链路中间穿插了集线器或分光器之类的设备的场景，一台交换机多条链路接在集线器上，与对端相连

```Topology
        <SW1>
       /     \
      /       \
     /         \
    /           \
 <SW2>--<hub>==<SW3>
```

在原有拓扑的SW2与SW3的互联链路中添加一台hub，SW3会根据指定端口的选举规则重新选举Designated Port，依次比较根路径开销、本端BID、本端PID，前两者都相同，最终比较PID，PID小的成为指定端口，反之称为Backup Port。在SW3上查看STP状态已经能观察到Backup Port，虽然显示Backup Port，但现在仍是运行的STP协议

```VRP
#----------------------------------SW1----------------------------------
[Switch_1]stp mode rstp

#----------------------------------SW2----------------------------------
[Switch_2]stp mode rstp

#----------------------------------SW3----------------------------------
[Switch_3]stp mode rstp
```

将所有交换机的STP版本切换为RSTP

