# STP

此前的STP章节中有提到，STP的BPDU类型有两种，由上向下用于选举根交换机以及确定每个交换机端口角色和状态的Configure BPDU、由下向上用于通知拓扑发生变更的TCN BPDU。TCN BPDU解决了MAC地址表的默认老化时间（300s）问题，二层数据转发依靠MAC地址表，即便通过STP解决了故障链路的问题，数据按照MAC地址表仍有可能会向故障Root Port转发导致通信失败

**网桥发送TCN BPDU的条件为**

- 有端口转变为Forwarding状态，且该网桥至少包含一个指定端口
- 有端口从Forwarding状态活Learning状态转变为Blocking状态

```Topology
    <SW1> 根桥
   /     \
<SW2>---<SW3>
```

以此拓扑示意图为例，假设SW2与根桥互联的Root Port故障，此时STP会恢复SW2的备用链路的通信，将SW2与SW3互联的链路重新选举为SW2的Root Port，那么此时SW2会发送TCN BPDU吗？由于此时SW2上没有指定端口，并且端口故障会回退到Disabled状态，因此SW2不会向上游发送TCP BPDU，反而是SW3是有可能发送TCN BPDU的。如果SW2与SW3互联的链路上，SW3的端口原本是阻塞端口，那么SW2重新选举Root Port后，SW3的阻塞端口会转变为Designated Port，并进入Forwarding状态。如果想要实现SW2向上游转发TCN BPDU，则在SW2的下游接上一个PC即可，一个PC则意味着一个指定端口

![TCA&TC置位的配置BPDU.png](https://www.z4a.net/images/2024/06/08/TCATCBPDU.png)

此前的STP章节中提到过BPDU标记字段有8个bit位，只不过STP仅使用首位和末位，MSTP是8位都使用；收到TCN类型的BPDU后，在标记字段中会标记TCA（Topology Change Acknowledgment）和TC（Topology Change）的值为1。STP的抓包数据中甚至都没有1~6置位的信息

# RSTP

STP协议虽然能够解决环路问题，但是由于网络拓扑收敛较慢，影响了用户通信质量，而且如果网络中的拓扑结构频繁变化，网络也会随之频繁失去连通性，从而导致用户通信频繁中断，这也是用户无法忍受的，由于STP的不足，IEEE于2001年发布的802.1w标准定义了RSTP。RSTP在STP基础上进行了诸多改进优化，使得协议更加清晰、规范，同时也实现了二层网络拓扑的快速收敛

## STP的五大问题

**一、设备开机运行STP初始化**

![STP五大问题其一](https://www.z4a.net/images/2024/06/08/STP.png)

由于STP的Forward Delay计时器，STP从初始状态到完全收敛至少需要30s

**二、直连链路故障**

![STP五大问题其二](https://www.z4a.net/images/2024/06/08/STP17e8540607a08b0e.png)

直连链路故障的场景对应的是SWC，SWC的Root Port故障后，由于Blocked Port一直从SWB的DP收到根桥的BPDU，因此SWC的Blocked Port转换为新的Root Port，经过2个Forward Delay超时后进入Forwarding状态

**三、非直连链路故障**

![STP五大问题其三](https://www.z4a.net/images/2024/06/08/STP2b620a78fef72f28.png)

非直连链路故障的场景对应的是SWB，SWB自身没有Blocked Port，也就意味着SWB不会从除Root Port以外的任何端口收到根桥的BPDU，那么当SWB的Root Port故障时，SWB不会立刻将Designated Port变更为Root Port，而是判断根桥故障，并认为自身就是新的根桥，向外发送自身的BPDU；SWC仍能正常收到根桥的BPDU，因此SWC对SWB的次优BPDU不做处理，直到STP的Max Age超时

**四、交换机连接用户终端**

![STP五大问题其四](https://www.z4a.net/images/2024/06/08/STP9f5eb80ad6c97c28.png)

