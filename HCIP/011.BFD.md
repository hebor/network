# BFD

为了减小设备故障对业务的影响、提高网络的可用性，设备需要能够尽快检测到与相邻设备间的通信故障，以便能够及时采取措施，从而保证业务继续进行

| 检测方式 | 说明 |
| :-- | :-- |
| 硬件检测 | 例如通过SDH（Synchronous Digital Hierarchy，同步数字体系）告警检测链路故障<br />优点是可以很快发现故障，但并不是所有介质都能提供硬件检测 |
| 慢Hello机制 | 通常采用路由协议中的Hello报文机制<br />这种机制检测到故障所需时间为秒级。对于高速数据传输，例如Gbit速率级，超过1秒的检测时间将导致大量数据丢失；对于时延敏感的业务，例如语音业务，超过1秒的延迟也是不能接受的 |
| 其他检测机制 | 不同的协议有时会提供专用的检测机制，但在系统间互联互通时，这样的专用检测机制通常难以部署 |

以上这些检测方式都存在各自的缺陷，非通用、检测慢等问题未得到解决

**BFD：<font color="red">Bidirectional Forwarding Detection，双向转发检测</font>

- 解决了上述检测机制的不足
- 通用、标准化、介质无关、协议无关，为上层协议服务
- 全网统一的检测机制，用于快速检测、监控网络中链路或路由的转发连通状况
- 保证邻居之间能够快速检测到通信故障，从而快速建立起备用通道恢复通信

**BFD工作机制**

- 本身没有发现机制，靠上层协议通知
- 建立BFD会话，周期性发送BFD控制报文进行检测；BFD的周期性检测以ms为单位
- 检测到故障后，再通知上层协议

![BFD会话建立流程](https://www.z4a.net/images/2024/06/18/BFD.png)

1. 上层协议通过自己的Hello机制发现邻居并建立连接
2. 上层协议在建立新的邻居关系时，将邻居的参数及检测参数都会通告给BFD，包括目的地址和源地址等参数
3. BFD根据收到的参数进行计算，并建立BFD邻居开始进行检测

BFD建立邻居后的检测速度和频率都高于OSPF，因此当OSPF的某一条链路故障后，BFD肯定是最先检测到故障的，BFD检测到故障后首先会拆除自身BFD的邻居会话，然后通知上层协议（OSPF）BFD邻居不可达，上层协议OSPF会终止故障链路的邻居关系，如果网络中存在备用路由，则OSPF会切换到备用路由

**BFD状态机制**

| 状态 | 说明 |
| :-- | :-- |
| Down | 会话处于Down状态或刚刚创建 |
| Init | 已经能够与对端系统通信<br />本端希望使会话进入Up状态 |
| Up | 会话已建立成功 |
| AdminDown | 会话处于管理性Down状态 |

BFD状态机制的建立和拆除都采用三次握手，以确保两端系统都能知道状态的变化；此三次握手非TCP三次握手，只是运行原理与TCP三次握手类似，三次握手的目的就是为了确保设备双方都能知道对方的状态变化

![BFD状态机制](https://www.z4a.net/images/2024/06/18/BFDe938ccec2843b749.png)

**<font color="red">状态迁移规则</font>：对端状态变化、检测定时器超时**

除了通过双方互相发送控制报文用于变更BFD状态，另外一种变更状态的方式就是定时器

**BFD会话工作方式**

<table>
    <tr>
        <td><font color="red">控制报文方式</font></td>
        <td>链路两端会话通过控制报文交互监测链路状态</td>
    </tr>
    <tr>
        <td><font color="red">Echo报文方式</font></td>
        <td>链路某一端通过发送Echo报文由对端转发回来，实现对链路的双向监测</td>
    </tr>
</table>

两端设备都支持配置BFD的情况下，设备间BFD可以通过控制报文的方式工作；当两端其中一个是服务器、非网管设备或其他不支持BFD技术的设备时，管理交换机的BFD通过Echo报文的方式工作，Echo报文工作方式是由支持BFD技术的交换机向对端发送Echo报文，对端收到Echo报文后会回复交换机，未对Echo报文做出回复则判断对端链路故障

**BFD报文格式：使用组播地址 <font color="red">224.0.0.184</font>**

<table>
    <tr>
        <td><font color="red">控制报文</font></td>
        <td>单跳检测其UDP目标端口号为 3784<br />多跳检测其UDP目标端口号为 4784</td>
    </tr>
    <tr>
        <td><font color="red">Echo报文</font></td>
        <td>UDP目标端口号未 3785</td>
    </tr>
</table>

**BFD运行模式**

会话建立前模式

<table>
    <tr>
        <td><font color="red">主动模式</font></br>
        <td>主动发送BFD控制报文，不管是否收到对端发来的BFD控制报文</td>
    </tr>
    <tr>
        <td><font color="red">被动模式</font></td>
        <td>不会主动发送BFD控制报文，直到收到对端发送来的BFD控制报文</td>
    </tr>
    <tr>
        <td>PS</td>
        <td>会话建立前至少要有一个运行在主动模式才能成功建立会话</td>
    </tr>
</table>

会话建立后模式

<table>
    <tr>
        <td><font color="red">异步模式</font></td>
        <td>周期性地发送BFD控制报文，如果在检测时间内没有收到BFD控制报文则将会话down</td>
    </tr>
    <tr>
        <td><font color="red">查询模式</font></td>
        <td>一旦BFD会话建立，不再周期性发送BFD控制报文，而是通过其他机制检测连通性，减少大量BFD会话带来的开销</td>
    </tr>
</table>