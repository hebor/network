# 组播基础

组播技术的关键和背景在于<font color="red">点到多点</font>的通信，当网络中部署点到多点通信应用时，若采用单播方式，网络传输的信息量与需要该信息的用户量成正比，多份内容相同的信息发送给不同用户，对信源及网络带宽都将造成巨大压力。若采用广播方式，无需接收信息的主机也将收到该信息，信息安全得不到保障，且会造成同一网段中信息泛滥

IP组播技术解决了单播和广播在点到多点应用中的问题，组播源只发送一份数据，数据在网络节点间被复制、分发，且只发送给需要该信息的接收者

**单播点到多点问题**

1. 单播方式下，网络<font color="red">传输的信息量与需要该信息的用户量成正比</font>，需要该信息的用户量较大时，网络中会出现过多重复流量，不仅占用源主机资源且浪费网络带宽
2. 单播方式比较适合用户稀少的点到多点应用，用户量较大时无法保证网络传输质量

**广播点到多点问题**

1. 广播方式下，信息源主机与用户主机被<font color="red">限制在一个共享网段中</font>，且该网段所有用户主机都能接收到该消息
2. 广播方式只适合共享网段，且信息安全性和有偿服务得不到保障

**组播解决方案**

- 信息的发送者称为“<font color="red">组播源</font>”
- 接收相同信息的接收者构成一个组播组，并且每个接收成员都是“<font color="red">组播组成员</font>”
- 提供组播功能的路由器称为“<font color="red">组播路由器</font>”
- 组播路由器不仅提供<font color="red">组播路由</font>功能，也提供<font color="red">组成员管理</font>功能，其本身也可以是组播组成员

**组播定义**：<font color="red">一点发出，多点接收</font>

- 在发送者和多个接收者之间实现点到多点网络连接
- 给多个接收者传输相同的数据，只需复制一份相同的数据包
- 提高了数据传输效率
- 减少了骨干网络出现拥塞的可能性

**组播的优势**

- <font color="red">提高效率</font>：降低网络流量、减轻硬件负荷
- <font color="red">优化性能</font>：减少冗余流量、节约网络带宽、降低网络负载
- <font color="red">分布式应用</font>：使用多点应用成为可能

**组播的劣势**：组播的应用大多是基于<font color="red">UDP</font>，从而导致

- <font color="red">尽力而为</font>（UDP连接特性）
- <font color="red">报文重复</font>
- <font color="red">报文失序</font>
- <font color="red">缺少拥塞控制机制</font>

组播的应用场景多用于多媒体、流媒体、联合作业场合的通信，任何”点到多点“的数据发布应用都能够通够使用组播技术

## 组播服务模型

组播服务模型指的是针对<font color="red">接收者对源如何进行选择</font>

| 模型 | 说明 |
| :-: | :-- |
| <font color="red">ASM</font> | <font color="red">Any-Source Multicast，任意组播源</font> <br />任意发送者都可以成为组播源，接收者无法预先知道组播源的位置，接收者可以在任意时间加入或离开该组播组。 <br />要求组播地址必须整个组播网络中唯一，同一时刻一个ASM地址只能被一种组播应用使用 |
| <font color="red">SSM</font>| <font color="red">Source-Specific Multicast，源指定组播</font> <br />接收者在加入组播组时，可以指定只接收哪些源的数据。 <br />加入组播组后，主机只会收到指定源发送到该组的数据。<br />组播地址不再要求全网唯一，只需要每个组播源上保持唯一，同一个源上不同的组播应用必须使用不同的SSM地址来区分 |

**组播IP地址**：一个组播组地址就是一个IP地址，不表示具体的主机，而是表示一系列系统的集合，主机加入某个组播组即声明自身接收目标地址为某个IP的报文

| 地址 | 说明 |
| :-: | :-- |
| <font color="red">D类地址空间</font> | 224.0.0.0~239.255.255.255；只作为目标地址 |
| <font color="red">永久组播地址</font> | 为路由协议预留的组播地址，用于标识一组特定的网络设备，也成为保留组播组 <br /> 永久组播地址保持不变，组成员的数量可以时任意的，甚至为零 |
| <font color="red">临时组播地址</font> | 为用户组播组临时分配的IP地址，组成员的数量一旦为零即取消 |

| D类地址范围 | 含义 |
| :-: | :-: |
| 224.0.0.0~224.0.0.255 | 为路由协议预留的永久组播地址 |
| 224.0.1.0~231.255.255.255 <br /> 233.0.0.0~238.255.255.255 | 用户可用的ASM临时组地址，全网范围内有效 |
| 232.0.0.0~232.255.255.255 | 用户可用的SSM临时组地址，全网范围内有效 |
| 239.0.0.0 239.255.255.255 | 用户可用的ASM临时组地址，仅在特定的本地管理域内有效，称为本地管理组播地址 |

| 永久组地址 | 说明 |
| :-- | :-- |
| 224.0.0.1 | 所有系统，包括主机与路由器 |
| 224.0.0.2 | 所有组播路由器 |
| 224.0.0.3 | 未分配 |
| 224.0.0.4 | DVMRP（Distance Vector Multicast Routing Protocol，距离矢量组播路由协议）路由器 |
| 224.0.0.5 | OSPF（Open Shortest Path First，开放式最短路径优先）路由器 |
| 224.0.0.6 | OSPF指定路由器/备用指定路由器 |
| 224.0.0.7 | ST（Shared Tree，共享树）路由器 |
| 224.0.0.8 | ST主机 |
| 224.0.0.9 | RIP-2（Routing Information Protocol version 2，路由信息协议版本2）路由器 |
| 224.0.0.11 | 移动代理 |
| 224.0.0.12 | DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）服务器/中继代理 |
| 224.0.0.13 | 所有PIM（Protocol Independent Multicast，协议无关组播）路由器 |
| 224.0.0.14 | RSVP（Resource Reservation Protocol，资源预留协议）封装 |
| 224.0.0.15 | 所有CBT（Core-Based Tree，有核树）路由器 |
| 224.0.0.16 | 指定SBM（Subnetwork Bandwidth Management，子网带宽管理） |
| 224.0.0.17 | 所有SBM |
| 224.0.0.18 | VRRP（Virtual Router Redundancy Protocol，虚拟路由冗余协议）|

[组播地址作用](https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml)

### 组播MAC地址

组播MAC地址高24bit=0x01005E，组播MAC地址第25bit=0，组播MAC地址低23bit=组播IP地址的低23bit

![组播MAC地址](https://www.z4a.net/images/2024/02/24/MAC.png)

由于IP组播地址的前4bit固定是1110，代表组播标识，而后28bit中只有23bit被映射到MAC地址上，这样IP地址中就有5bit信息丢失，直接导致的结果就是出现了32个IP组播地址映射到同一个MAC地址上；这个问题是客观存在的，无法解决

`224.1.1.1、224.129.1.1~239.1.1.1、239.129.1.1`共计32个IP地址都映射到了`0x0100.5E01.0101`MAC地址上，通过组播IP地址中丢失的5bit可以计算得出详细的32个IP地址，网络管理员在分配地址时必须考虑这种情况

## 组播协议

![组播的基本架构](https://www.z4a.net/images/2024/02/24/2e6d16c924503cbe5db2140d8dd53e45.png)

| 关注事项 | 组播技术 |
| :-: | :-: |
| 哪里有组播接收者 | 主机接入技术 |
| 从哪里可以获取组播数据 | 组播源发现技术 |
| 将组播数据传输到哪里 | 组播寻址机制 |
| 如何传输组播信息 | 组播路由 |

![组播相关协议](https://www.z4a.net/images/2024/02/24/d4788c6a794d24c5b69a8b4226b238ca.png)

- **域内组播路由协议**

  <table>
  <tr>
  	<td><font color="red">DVMRP</font></td>
      <td><font color="red">Distance Vector Multicast Routing Protocol，距离矢量组播路由协议</font>，一种密集模式协议。 <br /> 该协议有跳数限制，最大跳数32跳，已被淘汰 </td>
  </tr>
  <tr>
  	<td><font color="red">MOSPF</font></td>
  	<td>OSPF路由协议的扩展协议。它通过定义新的LSA来支持组播</td>
  </tr>
  <tr>
  	<td><font color="red">PIM</font></td>
  	<td><font color="red">Protocol Independent Multicast，协议无关组播</font> <br /> 分为DM（Dense Mode）和SM（Sparse Mode）两种模型。 <br /> 当接收者分布较为密集时，使用DM；较为稀疏时，使用SM。 <br /> PIM必须和单播路由协议协同工作
  </tr>
  </table>

- **域间组播路由协议**

  <table>
  <tr>
  	<td><font color="red">MSDP</font></td>
  	<td><font color="red">Multicast Source Discovery Protocol</font><br /> 能够跨越AS传播组播源信息。</td>
  </tr> 
  <tr>
  	<td><font color="red">MPBGP</font></td>
  	<td><font color="red">MultiProtocol Border Gateway Protocol</font><br /> 能够跨越AS传播组播路由。</td>
  </tr>
  </table>

- 对于SSM模型，没有域内和域间的划分。由于接收者预先知道组播源的具体位置，因此可以借助PIM SM的部分功能直接创建组播传输路径。

### IGMP

组播通信中，发送者将组播数据发送到特定的组播地址。要使组播报文最终能够到达接收者，需要某种机制使与连接港在接收者网段的组播路由器能够了解到该网段内有哪些组播接收者，保证接收者可以加入到相应的组播组中接收数据。

IGMP（Internet Group Management Protocol）因特网组管理协议，是TCP/IP协议族中负责IP组播成员管理的协议，它用来在接收者和与其直接相邻的组播路由器之间建立、维护组播组成员关系。

**组播组管理协议工作机制**

- <font color="red">主机加入或离开组播组</font>
- <font color="red">路由器维护组播组</font>
- <font color="red">查询器选举</font>
- <font color="red">成员报告抑制</font>

**IGMP**：<font color="red">Internet Group Management Protocol</font>，因特网组管理协议

- 负责组播成员管理，运行在主机和组播路由器之间。
- 主机侧：通过IGMP向路由器通告组成员关系。
- 路由器侧：通过IGMP协议维护组成员关系

IGMP协议分为3个版本，现网中最常见的版本是IGMPv2，IGMPv3也有被使用

| 版本 | 说明 | 
| :-: | :-: |
| IGMPv1 | 定义了基本的组成员*查询与报告* 过程。RFC1112 |
| IGMPv2 | 在IGMPv1的基础上添加了*查询器选举* 和*离开组* 机制。RFC2236 |
| IGMPv3 | 成员可以*指定接收或不接收* 某些组播源的报文。RFC3376 |

- 所有IGMP版本都支持ASM模型
- IGMPv3可以直接应用于SSM模型，而IGMPv1和IGMPv2则需要SSM-Mapping技术的支持。
- 运行IGMP高版本的路由器可以识别低版本的成员报告（向前兼容）

#### IGMPv1

**IGMPv1报文格式**

![IGMPv1报文格式](https://www.z4a.net/images/2024/02/25/IGMPv1.png)

- 路由器周期性的发送<font color="red">成员关系查询</font>，默认查询周期为<font color="red">60秒</font>。
- 成员关系报告的发送可以被动发送也可以主动发送。
  - 被动发送：主机收到成员关系查询消息后，发送成员关系报告。
  - 主动发送：主机主动发送成员关系报告。

IGMPv1具备0x11成员关系查询类型的包，但eNSP模拟器似乎因为bug问题路由器不会发送0x11包，wireshark抓包也看不到0x11包，并且由于IGMPv1不具备离开组机制，IGMPv1成员的离开是通过超时机制实现的，默认超过130秒没有发起0x12成员关系报告类型的包的成员会被认为是离开了组播组。正常情况下是先由组播路由器发起0x11，然后主机回复0x12，这种方式被称为被动宣告，并且每过60秒路由器会周期性发起0x11，以此保持成员关系

但由于eNSP模拟器的bug问题，路由器不会发起0x11成员关系查询，主机正常情况下也不会向路由器主动发起0x12成员关系报告，因此，主机在第一次主动发起0x12后，由于收不到0x11查询不会主动向组播组发送0x12，而路由器在等待130秒后未收到主机的0x12报告，会判定主机已经离开组播组

**IGMPv1工作机制**

- 普遍组查询与响应机制

  1. 路由器周期性的向子网内所有主机（224.0.0.1）发送0x11成员关系查询信息
  2. 收到普遍组查询后，主机发送IGMP 0x12成员关系报告，表示希望加入组播组

- 响应抑制机制

  同属于同一子网下且监听同一组播组的主机C监听到主机A的IGMP 0x12报告后，不再发送IGMP 0x12报告

每个收到查询的主机会启动一个计时器，默认0~10秒随机值，超时后发送报告。这也就意味着主机即便收到了路由器的0x11查询信息，也不是马上就回复0x12报告的
