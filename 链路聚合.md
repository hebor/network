# 链路聚合

以太网链路聚合通过多个物理接口捆绑成一个逻辑接口，在不进行硬件升级的条件下，实现带宽汇聚和热备份.从理念上来说链路聚合可以实现负载均衡，在配置链路聚合时，缺省情况下它是基于源IP、目标IP进行负载均衡的，但同时，缺省情况下的链路聚合基于二层转发，这意味着它根本不会识别三层IP，所以实际上它只会将一条链路跑满之后才会使用其他链路。二层链路聚合通过修改基于源MAC、目标MAC负载即可

## 链路聚合的基本概念

- 聚合组（Linkzgregation Group，LAG）：若干条链路捆绑在一起所形成的的逻辑链路。每个聚合组唯一对应着一个逻辑接口，这个逻辑接口又被称为链路聚合接口或Eth-Trunk接口

- 成员接口和成员链路：组成Eth-Trunk接口的各个物理接口称为成员接口，成员接口对应的链路称为成员链路
- 活动接口和活动链路：活动接口又叫选中（Selected）接口，是参与数据转发的成员接口。活动接口对应的链路被称为活动链路（Active link）
- 非活动接口和非活动链路：又叫非选中（Unselected）接口，是不参与转发数据的成员接口。非活动接口对应的链路被称为非活动链路（Inactive link）
- 聚合模式：根据是否开启LACP（Link Aggregation Control Protocol，链路聚合控制协议），链路聚合可以分为静态模式和LACP模式
- 其他概念：活动接口上限阈值和活动接口下限阈值

### 静态模式

静态模式一般出现在一些老旧、低端设备上，其不支持LACP协议，*静态模式下Eth-Trunk的建立、成员接口的加入均由手动配置，双方系统之间不使用LACP进行协商*。正常情况下所有链路都是活动链路，该模式下所有活动链路都参与数据的转发，平均分担流量，如果某条活动链路故障，链路聚合组自动在剩余的活动链路中平均分担流量。当聚合的两端设备中存在一个不支持LACP协议时，可以使用手工模式

**静态模式缺陷**

- 为了使链路聚合接口正常工作，必须保证本端链路聚合接口中所有成员接口的对端接口都 *属于同一设备的同一链路聚合接口*
- 静态模式下，设备间没有报文交互，因此只能通过管理员人工确认
- 静态模式下，设备只能通过物理层状态判断对端接口是否正常工作，静态模式下无法判断成员端口的逻辑状态是否正常（能否正常转发报文）

### LACP模式

LACP模式是采用LACP协议的一种链路聚合模式。设备间通过链路聚合控制协议数据单元（Link Aggregation Control Protocol Data Unit，LACPDU）进行交互，通过协议协商确保对端是同一台设备、同一个聚合接口的成员接口。同时LACPDU报文中包含设备优先级、MAC地址、接口优先级、接口号等信息，在LACP模式下聚合链路上会产生LACPDU报文交互

**系统优先级**

LACP模式下，两端设备所选择的活动接口数目必须保持一致，否则链路聚合组就无法建立。此时
可以使其中一端成为主动端，另一端（被动端）根据主动端选择活动接口。通过 *系统LACP优先级* 确定主动端，系统LACP优先级默认32768，越小越优先，通常保持默认。当优先级一致时LACP会通过比较MAC地址选择主动端，MAC地址越小越优先

**接口优先级**

选出主动端后，两端都会以主动端的接口优先级来选择活动接口，优先级高的接口将优先被选为活动接口。接口LACP优先级默认32768，越小越优先，通常保持默认，当优先级一致时，LACP会通过接口编号选择活动接口，越小越优先

**最大活动接口数**

LACP模式支持配置最大活动接口数目，当成员接口数目超过最大活动接口数目时会通过比较接口优先级、接口号，选举出较优的接口成为活动接口，其余的则成为备份端口（非活动接口），同时对应的链路分别成为活动链路、非活动链路，交换机只会从活动接口中发送、接收报文。华为设备默认支持的最大活动接口数是8个

当活动链路中出现链路故障时，可以从非活动链路中找出一条优先级最高（接口优先级、接口编号比较）的链路替换故障链路，实现总体带宽不发生变化、业务的不间断转发

**活动链路选举**

1. 通过LACPDU报文选举出优先级较高的交换机，作为LACP协商过程的主动端
2. 主动端通过比较接口优先级、接口编号选举出活动接口
3. 主动端通过LACPDU报文将本端活动端口选举结果发送给对端
4. 对端交换机根据主动端的接口选举结果，明确自身的活动端口，同时对应的链路成为活动链路

### 负载均衡

**基于包的负载均衡**

在使用Eth-Trunk转发数据时，由于聚合组两端设备之间有多条物理链路，如果每个数据帧在不同的链路上转发，则有可能导致数据帧到达对端时间不一致，从而引起数据乱序

**基于流的负载均衡**

Eth-Trunk推荐采用逐流负载分担的方式，即一条相同的流负载到一条链路，这样既保证了同一数据流的数据帧在同一条物理链路转发，又实现了流量在聚合组内各物理链路上的负载分担

**负载分担模式**

Eth-trunk支持基于报文的IP地址或MAC地址来进行负载分担，可以配置不同的模式（本地有效，对出方向报文生效）将数据流分担到不同的成员接口上

常见的模式有：源IP、源MAC、目的IP、目的MAC、源目IP、源目MAC

实际业务中用户需要根据业务流量特征选择配置合适的负载分担方式。业务流量中某种参数变化越频繁，选择与此参数相关的负载分担方式就越容易实现负载均衡

