# IP地址

IP网络中，通信节点需要有一个IP地址，IP地址以点分十进制表示，由32位二进制组成，分网络位和主机位两部分：

- 网络位代表IP地址所属网段
- 主机位代表网段上某个节点
- 由子网掩码决定分界点

在计算机网络中，2的指数倍是经常能被碰到的，例如OSPF的area区域ID也是2^32个

**IP地址分类**

<table>
<tr align="center">
    <td></td>
    <td>8Bits</td>
    <td>8Bits</td>
    <td>8Bits</td>
    <td>8Bits</td>
    <td>网络位范围</td>
    <td>备注</td>
</tr>
<tr align="center">
    <td>A类</td>
    <td>0NNNNNNN</td>
    <td colspan="3">Host</td>
    <td>1-126</td>
    <td align="left" rowspan="3">A类地址理论可用范围是0-127，但0和127都用作特殊用途；能被主机使用作为源地址的都是A、B、C三类地址范围，这三类地址也被称为单播地址（Unicast）</td>
</tr>
<tr align="center">
    <td>B类</td>
    <td>10NNNNNN</td>
    <td>Network</td>
    <td colspan="2">Host</td>
    <td>128-191</td>
</tr>
<tr align="center">
    <td>C类</td>
    <td>110NNNNN</td>
    <td colspan="2">Network</td>
    <td>Host</td>
    <td>192-223</td>
</tr>
<tr align="center">
    <td>D类</td>
    <td>1110NNNN</td>
    <td colspan="3">Multicast Group</td>
    <td>224-239</td>
    <td>组播地址</td>
</tr>
<tr align="center">
    <td>E类</td>
    <td colspan="5">Research</td>
    <td>保留地址，实验用途，不会在互联网上使用</td>
</tr>
</table>


0和127都是保留地址，0开头的地址大多情况下仅代表2种含义：所有IP地址或无IP地址，127地址也叫环回地址（loopback），环回地址就表示自身终端，环回地址一般是用于测试终端自身的TCP/IP协议栈，如果环回地址不通，表明终端本身无法接入网络

| 私有IP地址空间 | 地址范围 |
| -- | -- |
| 10.0.0.0/8 | 10.0.0.0-10.255.255.255，1个网段 |
| 172.16.0.0/12 | 172.16.0.0-172.31.255.255，共16个网段 |
| 192.168.0.0/16 | 192.168.0.0-192.168.255.255，共256个网段 |
| 169.254.0.0 | Windows客户端无法从DHCP服务器获取到地址时，会自动使用此私有地址 |
| 100.64.0.0/10 | 100.64.0.0~100.127.255.255，运营商专用私有地址 |

- 公网地址用于Internet，需要向ISP付费申请，全球唯一
- 私网地址用于内部网络，不能用于Internet，免费使用，可以重复
- 如果私网地址要访问Internet，必须转换为公网地址，该技术称为NAT

**IP数据包类型**

数据封装的时候有两种目标地址：MAC和IP，两者是互相牵制的，IP数据包是单播时，MAC也会是单播

| 类型 | 备注 |
| :-: | :-: |
| 单播 | Unicast，发送给单个目标 |
| 广播 | Broadcast，发送给广播域内的所有目标，广播报文无法穿越路由器，二层交换机默认不隔离广播域 |
| 组播 | Multicast，发送给一组目标，MAC地址=01-00-5E开头，组播报文能够穿越路由器 |

ip数据包类型中只有广播具备广播域的概念，OSPF的包使用组播传播

**冲突和广播**

<table>
	<tr>
	<td>冲突</td>
	<td>Collision，多个设备如果同时连接在一个传输信道上，发送的冲撞会导致信号破坏，这种情况只发生在早期使用集线器连接的共享式网络中</td>
	</tr>
	<tr>
	<td>冲突域	</td>
	<td>Collision Domain，能产生冲突的设备的集合（区域）</td>
	</tr>
	<tr>
	<td>广播</td>
	<td>Broadcast，发送给所有目标</td>
	</tr>
	<tr>
	<td>广播域</td>
	<td>Broadcast Domain，能收到广播的设备的集合（区域）</td>
	</tr>
	<tr>
	<td>集线器</td>
	<td>Hub，不分冲不分广，所有接口都属于同一个冲突域和广播域</td>
	</tr>
	<tr>
	<td>交换机</td>
	<td>Switch，分冲不分广，每一个端口就是一个冲突域</td>
	</tr>
	<tr>
	<td>路由器</td>
	<td>Router，分冲分广，每一个端口就是一个广播域</td>
	</tr>
</table>

冲突域现在已经不存在了，在早期没有交换机的时候，使用集线器连接局域网，Hub本身是个物理层设备，它不用识别MAC地址，简单一点说，它只是个信号复制器，它从某一个端口收到的数据，会从其他所有端口发送出去。并且，Hub虽然有多个端口，但只有一条信道，同一时间只能有一台设备发送数据，如果两台设备同时发送数据会产生冲突。如果抓包抓到的数据包小于64字节，这可能是因为冲突产生的碎片

## 子网掩码

子网掩码用于区分网络位和主机位，且将子网掩码转换为二进制时，永远都是连续的1或0

![子网掩码](https://www.z4a.net/images/2023/09/10/56f41e87fa2e6eaede1221566fa943c3.png)

可使用掩码长度的呈现方式：192.168.1.0/24（前缀表示法）

<table>
<tr>
    <td>网络地址</td>
    <td>主机位全0，代表一个网段（头）</td>
</tr>
<tr>
    <td>主机地址</td>
    <td>主机位非全0和全1，代表网段内的一个节点</td>
</tr>
<tr>
    <td>广播地址</td>
    <td>主机位全1，代表网段内所有节点（尾）<br />ping广播地址不一定会有回应</td>
</tr>
</table>
比较常见的还有一种特殊掩码是32位掩码，例如`192.168.2.252/32`，32位掩码表示该IP地址既是网络地址、又是主机地址、又是广播地址，32位掩码是最节约IP地址的一种形式，32位掩码都是独立成一条路由，表示整个网络内只有该IP一个节点。以`172.16.1.0/24`作为对比，24位掩码表示路由能去往该网段内的254个地址，而`192.168.2.252/32`则表示路由只能去往`192.168.2.252`这1个固定IP地址，32位掩码一般用于环回口

###  子网掩码的分类

- **主类掩码**：与自然分类一致的子网掩码
- **VLSM**：可变长子网掩码；通过将子网掩码变长来把一个网段划分为多个子网
- **CIDR**：无类域间路由；通过把子网掩码缩短来把多个网段聚合为一个网段，实现效果是将路由表中的若干条路由汇聚为1条路由。子网划分将submaks变长，CIDR将submask变短

## 子网划分

如果按照有类IP地址使用，例如一个B类地址默认掩码为16位，意味着这个地址空间里有2^16个IP，并且该网络号只能用于一个广播域，这对IP地址空间造成极大的浪费，且一个广播域中PC数量过于庞大，网络可能会被广播报文消耗大量资源

**子网划分的概述**

- 满足不同网络对IP地址的需求
- 实现网络的层次性
- 节省IP地址
- 默认子网掩码可以进一步划分，成为变长子网掩码（VLSM），即网络位向主机位“借位”

以`192.168.1.100/29`为例，计算其三类地址

```
192.168.1.100/29直观上能获取的信息是，网络位向主机位借5位，能划分32个子网，每个子网6台主机，其子网掩码部分分布如下
00000 000 网络位=0
00001 000 网络位=8
00010 000 网络位=16
00011 000 网络位=24
......

块=2^主机位数=256-掩码累加数值（248）=8，以上规律按照块公式计算能够快速计算出网络地址，网络地址代表全0地址，广播地址代表全1地址
由此可得与192.168.1.100最接近的网络位计算如下
网络地址：192.168.1.96/29
主机地址：192.168.1.97~192.168.1.102
广播地址：192.168.1.103
```

其他算法示例

```
#示例1：19.224.17.0/17，借位1位，能划分2个子网，每个子网内2^15个主机
0 0000000 网络位=0
1 0000000 网络位=1

块=2^主机位（7）=128
网络地址=19.224.0.0/17
地址范围=19.224.0.1~19.224.127.254
广播地址=19.224.127.255

#示例2：4个部门，1部门100个节点、2部门50个节点、3部门25个节点、4部门12个节点
1部门：至少保留7位主机位，网络位最多借1位
	块=128
	192.168.0.0/25
	192.168.0.128/25
2部门：至少保留6位主机位，网络位最多借2位
	块=64
	192.168.0.0/26  ->已被1部门使用
	192.168.0.64/26 ->已被1部门使用
	192.168.0.128/26
	192.168.0.192/26
3部门、4部门依此类推，最终3部门网段192.168.100.192/27、4部门网段192.168.100.224/27
```

**子网划分测试**

子网划分是对有类网络的更细分，通过查看路由表可直接得出某个子网内所有可用的主机数

```
AR1 <---> AR2
```

示例：子网地址通信

```
[AR1]inte g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 10.1.1.1 24
[AR1-GigabitEthernet0/0/0]dis ip rout
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 8        Routes : 8        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.1.1.0/24  Direct  0    0           D   10.1.1.1        GigabitEthernet0/0/0
       10.1.1.1/32  Direct  0    0           D   127.0.0.1       GigabitEthernet0/0/0
     10.1.1.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet0/0/0

# 从以上3条路由信息得出子网内可用的主机数位是1~254，全零地址是10.1.1.0，全1地址是10.1.1.255

[AR2]inte g0/0/0
[AR2-GigabitEthernet0/0/0]ip add 10.1.1.9 29
[AR2-GigabitEthernet0/0/0]dis ip rout
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 7        Routes : 7        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.1.1.8/29  Direct  0    0           D   10.1.1.9        GigabitEthernet0/0/0
       10.1.1.9/32  Direct  0    0           D   127.0.0.1       GigabitEthernet0/0/0
      10.1.1.15/32  Direct  0    0           D   127.0.0.1       GigabitEthernet0/0/0
      
# 从以上3条路由信息得出子网内可用主机地址是9~14
```

这种情况下两个终端是不通的，因为不满足双向通信的准则，AR1的接口地址范围包含AR2的接口地址，所以AR1会认为AR2与自己处于同一网段内，而AR2由于子网划分的原因没有去往AR1的路由。AR1访问AR2时会直接发起ARP请求，对于AR2而言，其接口地址与AR1地址并不处于同一网段，路由器也默认隔离广播域，因此AR2不会对AR1的ARP请求做出响应。通过抓包能够看出来AR1一直向外发送ARP请求广播，如果想实现AR1与AR2的通信，将AR1的IP最后一位更改为9~14即可

每日更新电信IP段：https://ispip.clang.cn/

## 数据转发过程

**网关**

- 位于不同网络间的主机要实现通讯，必须将数据包发送给网关
- 网关通常就是一台三层网络设备（路由器、三层交换机、防火墙、服务器）
- 网关地址就是网关设备跟自身终端连接的接口地址

网关地址不是必须的，IP地址和掩码是必须的，同局域网内通信不需要网关，跨网络通信需要网关

```
#查看windows的路由表
route print
```

**数据转发过程**

![数据转发过程](https://www.z4a.net/images/2023/09/11/2e3c1bd5bebb07a887ffc297efde0868.png)

打开浏览器访问百度首页www.baidu.com所经历的数据转换过程

1. 浏览器调用HTTP协议
2. 传输层调用TCP协议，目标端口80，发起三次握手
3. 网络层调用IP协议，目标IP未知，发起DNS解析
    1. DNS解析调用传输层UDP协议，目标端口53
    2. 网络层IP协议封装目标IP，此时目标IP是DNS服务器的IP
    3. IP封装时会对DNS服务器的IP做一个判断，是否在同一局域网内，不在同一局域网则需要网关
    4. 数据链路层封装Ethernet Ⅱ包，需要目标MAC，目标MAC使用网关MAC
    5. 主机检索ARP缓存查询网关MAC，缓存无记录则发起ARP广播请求获取网关MAC
    6. 网关经过路由将请求转发到DNS服务器
    7. DNS服务器根据检索域名IP对应关系，自身有记录直接返回IP，无记录则需要通过递归或迭代方式向上请求记录
4. DNS解析到服务端IP后需要对目标IP做一个判断，是否在同一局域网内，不在同一局域网则需要网关
5. 数据链路层封装Ethernet Ⅱ包，通过ARP缓存封装目标MAC为网关MAC