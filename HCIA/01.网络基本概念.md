# 网络基础

网络就是在硬件方面通过介质将网络设备和终端互联，在软件方面实现操作系统、应用软件的互联，实现资源共享、信息传递；网络通信是相互的，有发包就一定要有回包，计算机之间建立通信的前提是必须使用相同的协议

**计算机网络术语**

|术语|备注|
|:-:|:-:|
|设备|Device|
|介质|Media|
|消息/报文|Message/Data|
|协议|protocol|
|发送方/信息源|Sender/Source|
|接收方/信息目|Receiver/Destination|

**网络的演进**

|术语|备注|
|:-:|:-:|
|network|网络，一组互联、通讯的设备|
|internet|互联网，多个互联互通的网络|
|Internet|因特网，互联全世界的网络。因特网是互联网里最大的网络|

ISP：Internet Service Providers，因特网服务提供商，向用户提供互联网接入业务、信息业务、增值业务，俗称运营商

**网络类型**

根据覆盖范围不同，组网技术不同进行分类。组网技术主要体现在二层，跟三层以上基本没什么关系，三层以上网络基本上都是一样的，IP报头、udp、tcp传输层报头，这些都不会变，基本上区别就在于下二层

|类型|备注|
|:-:|:-:|
|PAN|Personal Area Network，个域网，例如蓝牙、红外线遥控|
|LAN|Local Area Network，局域网|
|CAN|Campus Area Network，园区网|
|MAN|Metropolitan Area Network，城域网，家用或企业用的网络出口线缆都会先连接到运营商的CO（局端）上，城市马路边上印有运营商logo的大铁箱子就是CO，一个CO对接的是该片区所有运营商的宽带用户，一个城市的所有CO互联后就是城域网|
|WAN|Wide Area Network，广域网，又称为骨干网，由运营商建设连接全国城域网的网络|
|WLAN|Wireless Local Area Network，无线局域网|
|WWAN|Wireless Wide Area Network，无线广域网|

广域网的定义被分为2种：狭义广域网、广义广域网。以上的广域网是指的狭义广域网的定义，事实上，广义广域网的定义指的是，局域网之外都是广域网，包括城域网也是广域网的一部分

**网络的性能指标**

1. 带宽（bandwidth）：以bps（bit per second，比特每秒）为单位，表示在单位时间内从一个节点到另一个点的数据量
2. 延迟（delay）：通常以ms为单位，表示数据从一个节点到另一个节点所经历的时间

网络带宽以bps为单位，但一般软件都以Byte为单位显示，由于1byte=8bit，所以中间还要经过一层换算，也就是宽带数值要除8

网络拓扑：Topology，用于描绘网络结构的示意图

拓扑类型：根据接口、线缆、封装判断

## 网络模型

由于计算机网络的飞速发展，各个厂商生产的硬件和软件无法相互兼容，为了实现网络设备间的互相通讯而定义了网络模型标准。网络标准化实现了规范不同的互联标准，互相兼容

分层思想：将复杂的流程分解为几个功能相对单一的子过程

- 流程更加清晰，复杂问题简单化
- 更容易发现问题并针对性解决问题

### 两大模型：协议簇（Protocol Suit）

- OSI模型：Open System Interconnect，开放系统互联模型，由ISO（国际标准化组织）定义

|层级|功能|实例|
|:-:|:-:|:-:|
|应用层|为应用程序提供网络服务|HTTP<br />Telnet|
|表示层|数据的表现形式如-显示器画面、特定的功能实现如-格式化、加密、解密|ASCII、JPEG|
|会话层|建立、维护、管理应用程序间的会话连接，例如SQL、NFS、RPC等，用于实现区分同一个应用程序的不同访问者，例如视频软件判断用户是否为会员|操作系统/应用读取|
|传输层|建立、维护、管理端到端连接，端口用于区分同一台计算机上的不同应用程序，主要有TCP/IP协议簇的TCP和UDP协议，以及IPX/SPX协议簇的SPX协议等|TCP、UDP|
|网络层|IP寻址和路由选择，IPX、Apple talk已被淘汰|IP|
|数据链路层|控制网络层与物理层之间的通信|802.3/802.2<br />HDLC/FR/PPP|
|物理层|比特流传输，定义电压、接口、线缆标准、传输距离、传输介质等参数|EIA/TIA-232<br />RJ45|

- TCP/IP模型：现在TCP/IP模型被分为4层或5层模型，教材上描述TCP/IP大多是4层模型，4层模型就是将数据链路层和物理层合并为网络接口层，在抓包数据中一般是看不到物理层的数据的，物理层是光电信号，实际工作仍应用TCP/IP的5层模型

|层级|数据包封装|代表性设备|
|:-:|:-:|:-:|
|应用层|数据|直接与人交互的终端设备都是应用层设备，例如PC、手机|
|传输层|数据段（Segment）|防火墙、流控设备、负载均衡设备等|
|网络层|数据包（Packet）|路由器|
|数据链路层|数据帧（Frame）|交换机|
|物理层|比特流（Bit）|线缆、集线器、中继器|

OSI模型停留在理论网络模型上，实际中更多的被使用的是TCP/IP模型，TCP/IP模型中的每一层都有其代表性设备，例如数据链路层对应的交换机

**数据的封装与解封**

- 所有的应用数据都需要经过每一层处理后才能通过网络传输到目的端
- OSI七层模型中，上三层统一将PDU（Protocol Data Unit，协议数据单元）作为数据计量单位，下四层计量单位与TCP/IP模型一致
- TCP/IP根据不同层分别使用了段、包、帧、比特
- 发送方逐层向下传递数据，并添加报头和报尾的过程称为封装
- 接收方逐层向上传递数据，称为解封

**TCP/IP协议簇中常见的协议**

|层级|协议|
|:-:|:-:|
|应用层|HTTP、FTP、TFTP、SMTP、SNMP、DNS|
|传输层|TCP、UDP|
|网络层|ICMP、IP、ARP|
|数据链路层<br />物理层|由底层网络定义的协议|

#### 应用层常见协议概述

TCP/IP模型的最高层，直接为应用程序提供网络服务。应用层不是指应用程序，而是为应用程序提供网络服务，例如QQ，在使用QQ聊天时，应用层是指的QQ的协议，QQ的应用程序必须要经过QQ的协议才能与腾讯的QQ服务端进行通信

1. DNS：Domain Name System，域名解析系统

    - 建立IP地址与域名之间的映射关系
    - 将域名解析为IP地址
    - 将IP地址解析为域名

    windows DNS调试

    ```
    nslookup	#DNS调试工具
    > www.baidu.com		#查询baidu的DNS解析
    
    ipconfig /displaydns	#查看DNS缓存
    ipconfig /flushdns	#清空DNS缓存
    ```

    以一个常见域名形式为例`base.hebor.cc`，实际上完整的域名应该是`base.hebor.cc.`，末尾的`.`代表根域，每个域名都是从根域起始，只不过日常的使用过程中会省略根域的书写；`.cc`代表顶级域，偶尔能看到`.cc.cn`的顶级域，两者之间没有直接关联，从域名中判断两者是通过不同机构申报的域名，`.cc`表示全球范围性域名，通过APNIC申报、`.cc.cn`表示国内范围性域名，通过CNNIC申报；`.hebor`代表二级域，由申请人自定义；`base`代表主机名，最常见的主机名是`www`

    **DNS解析的两种方式**

    - 递归查询：DNS服务器一定会返回一个确切的查询结果；递归查询一般用在客户端到DNS服务器的查询

    - 迭代查询：DNS服务器会返回一个已知的其他DNS服务器，由请求者自行查询；迭代查询一般用在DNS服务器到DNS服务器的查询

    在PC上配置IP信息时需要配置一个DNS服务器地址，此DNS服务器也被称为本地域名服务器，当PC需要进行域名解析时，PC会将解析请求发送给本地域名服务器，本地域名服务器如果能够直接得到解析IP，则会将解析IP回复给PC，这个过程就是递归查询；如果本地域名服务器无法直接得到解析IP，则本地域名服务器会从根域名服务器开始逐层解析，根域名服务器只会解析自身下一层的域名，也就是`.cc`，根域名服务器将顶级域名服务器的IP回复给本地域名服务器，本地域名服务器再去请求顶级域名服务器，由此进一步查询到二级域名`.hebor`的域名服务器，依此类推，直到解析到完整域名`base.hebor.cc`的IP，这个由本地域名服务器向其他域名服务器请求解析的过程称为迭代查询

2. HTTP：Hypertext Transfer Protocol，超文本传输协议

    - 帮助客户端访问万维网（World Wide Web）
    - 浏览器通过翻译HTML文件来表现文本、图像等对象

3. SMTP与POP3：邮件服务

    - SMTP：Simple Mail Transfer Protocol，简单邮件传输协议，用于发送邮件
    - POP3：Post Office Portocol v3，邮局协议版本3，用于接收邮件
    - IMAP：Internet Message Access Protocol，互联网邮件访问协议，类似POP3，功能更多

4. Terminal Network：终端网络

    远程管理的主要协议之一，常用终端工具有SecureCRT、Putty、Xshell

5. FTP与TFTP

    - FTP：File Transfer Protocol，文件传输协议，提供可靠的文件传输服务，具有认证、权限等功能
    - TFTP：Trivial File Transfer Protocol，简单文件传输协议，提供不可靠的文件传输服务，常用于网络设备配置文件和系统文件传输

    FTP会用到20、21端口，其中21端口用于控制连接传输控制信号，例如FTP命令和执行信息等。20端口用于数据连接，用于上传、下载数据；FTP的数据传输方式分为*主动传输* 和*被动传输*，主动传输方式由服务端主动发起连接，使用20、21端口；被动传输方式由客户端主动发起，使用21端口和一个由服务器产生的随机高端口。因此，根据FTP的两个端口的不同作用判断，21端口属于常驻端口，而20端口不一定会用上，也可以是任意一个随机端口提供数据传输功能

以上应用层服务都基于C/S结构

#### 传输层

传输层定义主机应用程序之间端到端的连通性，最常见的两个协议是传输控制协议TCP（Transmission Control Protocol）和用户数据包协议UDP（User Datagram Protocol）

通常，传输层提供端到端的连接，网络层提供点到点的连接。数据包到达传输层后，通过数据包内的目标端口号进行区分该数据包属于上层某个应用程序，不同的应用层协议对应的端口号不一样，传输层实现对于上层不同应用程序的数据包分类、转发

##### 端口

|端口号范围|端口类别|
|:-:|:-:|
|0~1023|公认端口|
|1024~49151|注册端口|
|49152~65535|私有或动态端口|


|协议|端口号|备注|
|:-:|:-:|:-:|
|FTP|21、20|TCP|
|HTTP|80|TCP，8008和8080也是http已注册的备用端口|
|HTTPS|443|TCP|
|Telnet|23|TCP|
|SMTP|25|TCP|
|POP3|110|TCP|
|IRC|194|TCP，Internet中继聊天|
|TFTP|69|UDP|
|RIP|520|UDP|
|DHCP|67、68|UDP，服务端使用67端口，客户端使用68端口|
|SNMP|161|TCP/UDP|
|DNS|53|TCP/UDP|

##### 协议

- TCP协议：面向连接的可靠传输、适用于可靠性要求高的应用、开销大
- UDP协议：无连接的不可靠传输、适用于关注传输效率的应用、可靠性由应用层负责

TCP报文与UDP报文结构

![TCP&UDP数据包结构对比](https://www.z4a.net/images/2023/09/08/TCPUDP.png)

关于TCP报文中的6个控制位：

- URG（urgent 紧急）：紧急指针，值为1时，表明此数据包通过紧急方式发送，需要优先处理
- ACK（acknowledgement 确认）：TCP会话确认号
- PSH（push 推送）：表示接收者应尽快将该数据报文交给应用层
- RST（reset 重置）：重置TCP连接
- SYN（synchronous 建立连接）：用于发起TCP连接
- FIN（finish 结束）：用于发起断开TCP连接

URG仅用于标识数据包中是否存在紧急数据，具体的紧急数据或者紧急数据的位置，是通过紧急位标识的，因此URG字段和紧急位字段是联动使用的，紧急位也叫做紧急指针；操作系统收到的网络数据会先放在TCP缓冲池中，TCP缓冲池存满数据后再将数据重组并统一上传到应用层，PSH位的作用就是立即结束TCP缓冲池的存储，立即将TCP缓存池中的数据上传到应用层

##### TCP四个机制

1. **TCP会话的建立-三次握手**

    ![TCP会话确认](https://www.z4a.net/images/2023/09/09/TCP.png)

    在TCP三次握手过程中，ack确认号的值等于对端seq序列号的值加1

    TCP拒绝服务——SYN Flood攻击（DDoS攻击）：SYN报文是TCP连接的第一个报文，攻击者通过大量发送SYN报文，造成大量未完全建立的TCP连接，占用服务端的资源

2. **TCP会话的确认**

    ![TCP三次握手](https://www.z4a.net/images/2023/09/09/TCP590856ec25c92052.png)

    TCP为了保证所有的数据包是可靠的，所有的数据包都要有确认，也就是ACK确认号，包括TCP三次握手报文，除了第一个由Client端发起的SYN包没有ACK确认号；发送方长时间未收到接收方发送过来的确认包时会重新发送数据包
    
    在TCP会话过程中，ack确认号的值等于上一个数据报文内的数据大小（Data）加seq序列号的值，以上面过程为例，第二个包，Server向Client回复的ack确认号就是10，这个值不仅仅是只做了Client第一个包的计算（seq=1 + Data(9字节)），它同时也是回复Client，Data(9字节)已经收到了，可以开始发送seq序列号为10的数据包了（Client第一个包Data只有9字节），最终的ACK确认号就是整个数据包的大小
    
    换言之，ack确认号的意义就是告诉对端，你发送过来的数据包我已经收到了，你可以从下一个数据包开始发送了，同时ack确认号也会告诉对端自己已经收到了多少数据，便于对端对已发送的数据做确认、为即将发送的数据做准备，而seq就是对端即将准备发送的数据包的第一位序号
    
    在实际抓包的过程中可能还会看到一个词眼叫Next Seq，实际上它就代表对端的下一个回包内容中Seq的值，正常来说每一个包都应该有ack确认包，但在一些情况下，对端可能向我端发送批量的、连续的数据包，此时我端不会对对端的每一个包都做出回应，而是每几个包做出一个回应，比如每3个包做出一个回应，那么这个回应包中的seq和ack的值就只要与第3个包的值能对应上即可
    
3. **TCP会话的拥塞和流量控制**

    ![TCP会话的拥塞和流量控制](https://www.z4a.net/images/2023/09/09/TCP197357989ad06a16.png)

    在每个数据包里会有个window字段，window字段的作用是告诉对端，我端最多能收到到多少字节的数据，同样的，对端向我端回复的数据包中也会带有window字段，两端在通信过程中window字段会根据实际情况动态调整，两端通信互相发送的数据包大小都需要保持在winodw字段的值以内

4. **TCP会话的终止-四次挥手**

    ![TCP四次挥手](https://www.z4a.net/images/2023/09/09/TCPd131dd4642b4da5f.png)

    客户端向服务端发起终止位FIN时代表发起四次挥手，请求断开连接

在正常情况下，TCP的三次握手一定是发送3个数据包，在数据拥塞的场景下可能会重传，所以可能会发3个以上的包，但不可能少于3个包；而TCP的四次挥手在一些场景下可能不一定有4个包，例如浏览器崩溃、客户端重启等

在两端互相通信的过程中，如果数据包内没有携带数据，那么将该数据包本身大小视作1字节，从抓包过程也能够看出来，这也就导致了TCP三次握手和TCP四次挥手过程中的seq和ack的计算结果是一致的，而和TCP会话确认过程中的seq和ack的计算结果差距很大，因为三次握手和四次挥手的数据包内是没有携带数据字段的

**时隙**

一台计算机的一个网卡或网络设备的某一个接口，在同一时间点只能收、发1个数据包，因此在计算机上运行的多个程序也只能通过轮询的方式逐个程序收发数据包，这是时隙机制。只不过计算机的处理速度非常快，毫秒级的处理效率人为感知不明显，然而，如果仅通过时隙机制去实现传输一个大数据时，可以想象到其他程序一定会断开网络一段时间，直至大数据传输完成

例如，传输一个1GB的文件，如果仅通过时隙机制实现传输，那么在1GB数据传输完成前，计算机上所有的应用程序都会断开网络，为了避免这种情况，传输层实现了分段功能，大数据包传输前会被切分为多个小数据段，封装与接封装的过程也实现了数据包的切分与重组

#### 数据链路层

数据链路层主要实现**封装成帧、透明传输、差错检测**，将比特流组合成字节进一步合成数据帧，通过MAC地址访问介质，发现错误但不能纠正。数据链路层主要用于管理交换网络，也就是局域网

**双工模式**

- 半双工：同一时间只能发送或接收数据
  - 冲突域：共享式网络中的信号冲突。冲突域出现在MA（多点接入）网络
  - NBMA：非广播多路访问。面临淘汰的技术，但可以作为一种网络设计，如DSVPN
  - CSMA/CD：载波侦听多路访问冲突检测技术。先听后发、边听边发、冲突停发，随即延迟后重发
- 全双工：任意时间既可接收也可发送数据

以太网：Ethernet，当今主导地位的局域网组网技术

**以太网分类**

<table>
    <tr>
        <td align="center">DIX以太网</td>
        <td rowspan="2">10Mbit/s 以太网</td>
        <td rowspan="2">使用CSMA/CD</td>
    </tr>
    <tr>
        <td align="center">IEEE 802.3</td>
    </tr>
    <tr>
        <td align="center">IEEE 802.3u</td>
        <td>100Mbit/s 以太网</td>
        <td rowspan="2">可以选择使用CSMA/CD</td>
    </tr>
    <tr>
        <td align="center">IEEE 802.3z</td>
        <td>1Gbit/s 以太网</td>
    </tr>
    <tr>
        <td align="center">IEEE 802.3ae</td>
        <td>10Gbit/s 以太网</td>
        <td rowspan="2">不使用CSMA/CD</td>
    </tr>
    <tr>
        <td align="center">IEEE 802.3ba</td>
        <td>40/100Gbit/s 以太网</td>
    </tr>
</table>

通过抓包查看数据链路层可能能够看到两种二层封装，Ethernet Ⅱ和IEEE 802.3，IEEE802.3就是Ethernet Ⅱ的前身，在IEEE802.3封装内就只有一个STP协议；数据链路层在开发时创建了两个子层，LLC子层和MAC子层，LLC子层在MAC子层之上，它为网络层服务

| 子层 | 作用 |
| :-: | :-- |
| LLC | Logical Link Control，逻辑链路层，负责识别网络层协议类型，接收上层数据包封装成帧后，向下层传递 |
| MAC | Media Access Control，介质访问控制，负责控制、连接物理层的介质。处理硬件设备的物理寻址、定义网络拓扑及数据帧的传递顺序 |

##### 以太网帧结构

![以太网帧结构](https://www.z4a.net/images/2023/09/09/89b23e1db3a2f2673621f5cb283ad5cd.png)

实际抓包能看到目标地址、源地址、协议类型，收起数据部分的抓包信息后可以看到帧校验序列FCS在最末尾，FCS字段固定4字节。协议类型表明了上层使用的协议，此字段为2字节，代表两百多种协议。常见的协议类型有0x0800（ip协议）、0x0806（ARP协议）、0x8864（PPPoE）

传输层和网络层的抓包都是源地址在前、目标地址在后，数据链路层则相反

| 协议类型 | 代表上层的协议 |
| -- | -- |
| 帧大小范围 | 64~1518，这个计算是没有将前导码和帧起始定界符算进去的，以太网帧包头大小是18字节，至于为什么数据最小是46字节，是因为以太网帧必须满足最小长度要求64字节，数据较小时必须加以填充 |
| MTU | 最大传输单元，默认1500字节，每次发送的数据（仅指数据部分）的最大值 |
| 帧校验 | 通过一定的计算公式对数据包进行计算。如果接收方校验的FCS值与发送方的FCS值不相等，则视作该帧无效并丢弃 |
| MAC地址 | 代表一个网络接口的物理地址，全球唯一。如果接收方查看目标MAC不是自己，则丢弃该数据帧 |

MAC地址烧录在网卡中无法更改，MAC地址总共48bits，前24bit为厂商代码，后24bit为生产编号。MAC地址表以交换机端口对应MAC地址的方式映射，当主机收到的数据帧所包含的MAC地址是自己时，会将以太网封装剥削掉后送往上层协议

**MAC地址的分类**

- 单播：一对一通信。DMAC的第8位固定是0
- 广播：一对所有通信。DMAC地址为全F
- 组播：一对部分通信，DMAC地址第8位固定是1

一个完整48位MAC中的第8位也称IG位，用于区分一个MAC是单播/组播/广播MAC，该位为0时，表示该MAC地址是一个单播MAC、该位为1时，表示该MAC地址是一个广播/组播MAC。而通过wireshark抓包时，通过过滤式`eth [0] & 1`能够过滤出所有的广播数据帧，该公式表示表示将eth封装的首字节（过滤式中的eth【0】）和二进制数字00000001（过滤式中的1）进行按位逻辑与运算（过滤式中的&）。在与运算中，只有两个数同时为1的时候才能计算出结果1

#### 网络层

网络层主要实现逻辑寻址、广播控制、路由选择

##### ARP

Address Resolution Protocol，地址解析协议，终端要将数据发送给另一台终端时，必须知道对端的IP地址，IP地址由网络层提供，但仅有IP地址还不够，IP报文必须封装成帧才能通过数据链路层发送，数据帧必须要包含对端MAC地址，因此发送端还必须获取到对端的MAC地址。通过目标IP地址获取到目标MAC地址的过程通过ARP协议实现

**ARP的工作过程**

如果一台终端是第一次与其他终端通信，此时终端并不知道对端的MAC地址，会向外发送一个ARP请求报文，ARP的请求报文中，由于必须要封装对端MAC，但又不知道对端的MAC的情况下，为了能够顺利的将ARP报文转发出去，ARP的第一个请求报文（Request）会封装一个全0的对端MAC，这代表广播地址，在同一个广播域内的所有主机都能够收到这个ARP请求，但是只有目标IP地址的对端主机才会回应APR响应报文（Reply），收到对端的ARP响应报文后会在本地生成缓存

<table>
    <tr>
        <td align="center">arp -a</td>
        <td>查看arp缓存</td>
    </tr>
    <tr>
        <td align="center">arp -d</td>
        <td>清空arp缓存</td>
    </tr>
    <tr>
        <td align="center">arp -s IP_ADDRESS MAC_ADDRESS</td>
        <td>静态绑定IP与MAC的关系</td>
    </tr>
</table>

在抓包过程中可以看到一个明显迹象，清空ARP缓存后测试两个终端之间的连通性，首先会发送ARP请求/响应报文，在本地有ARP缓存的前提下，不会发送ARP报文

ARP响应是不会被阻止的，阻止了ARP响应就意味着拿不到对端的MAC，拿不到对面MAC就意味这无法建立通信，所以没有任何一个安全技术策略会去阻止ARP的响应；一般的扫描工具也是利用ARP协议执行的，ARP协议的效率要比ICMP协议效率更高

ARP报文不能跨越路由器，不能被转发到其他广播域，这也意味着获取到的MAC地址都是同一个广播域内的，而数据包不可能只在一个广播域内传输，所以数据包在传输的过程中，IP地址不一定会变（局域网IP经过NAT的前提下也会变），但MAC地址每经过一个广播域都会产生变化

**ARP欺骗**

但在某些场景下，攻击者收到ARP请求报文，即便目标IP不是自己，也会回复ARP响应报文。在局域网场景下，通过查询网关的IP和MAC地址，再通过一些工具修改局域网内的ARP响应包的信息，如果没有ARP响应包也可以通过自身终端创造，修改ARP响应包的网关IP和网关MAC后，例如将网关IP对应的MAC地址修改为随意MAC，然后不断向局域网内其他主机发送虚假ARP响应包，可以干扰其他主机正常上网，如果发送虚假ARP包的频率较高，甚至可以导致其他主机无法上网

ARP欺骗通过DAI或ARP双向绑定可以解决，双向绑定仅需PC端和路由器双方都新增一条静态ARP绑定地址即可，但PC端的ARP表保存在内存中，重启即失效，路由器的ARP静态绑定是写入配置的，重启不会失效

**免费ARP**

免费ARP报文中携带的目标IP是自身的地址，向局域网内的所有MAC地址（硬件地址）发送ARP请求，可以用于探测IP地址是否冲突。在自己主机上手动配置一个IP地址后，主机会通过ARP广播请求手动配置的这个IP，如果没有收到ARP响应报文则说明局域网内没有终端在使用这个IP，反之IP冲突

同时设备更新IP后，也会通过免费ARP通知局域网内的其他设备更新ARP地址表；通过免费ARP实现的第二个功能也可以用于判断网络中是否出现环路，环路会引起MAC地址震荡

**RARP**

反向地址解析协议，主机通过自身的MAC地址解析自己的IP地址，这种方式一般用于无盘工作站，无盘工作站节点知晓自身的MAC地址但没有IP地址，它会向局域网中发送RARP广播，向RARP服务器请求IP，局域网内的所有节点都会收到RARP报文，但只有RARP服务器会对RARP报文做出回应，RARP服务器上会存在一个MAC地址与IP地址的映射表，收到无盘工作站的RARP请求后，根据无盘工作站的MAC地址查找到对应的IP，并通过单播回应给无盘工作站。不是所有网卡都支持无盘系统的，必须要带有PXE启动芯片的网卡才能实现无盘系统功能

**代理ARP**

ARP代理不是一个协议，它只是三层网络设备上的一个功能，所以它会受到硬件限制，部分硬件并不支持ARP代理功能，Cisco设备默认开启了ARP代理功能，华为设备默认关闭ARP代理

两台主机需要建立通信时，数据封装需要对端的MAC地址。在数据封装前，根据源IP和目标IP信息计算掩码后，如果判断目标主机和本端处于同一网段，会认为不需要经过路由，而直接向对方发送ARP请求以获取对端MAC地址，如果路由设备未开启ARP代理功能，那么路由设备默认会隔离广播域，本端的ARP请求自然无法到达对端主机，双方无法建立通信。如果掩码计算后判断不在同一网段，就需要路由，所以接下来就是向网关发送ARP请求以获得路由器的MAC地址，再将请求交给路由器转发去寻找目的主机

例如`192.168.0.0/16`和`192.168.0.0/24`，16位掩码会认为24位掩码的地址与本端处于同一网段

**ARP数据包格式**

![ARP数据包格式](https://www.z4a.net/images/2023/09/09/ARP.png)

##### ICMP

Internet Control Message Protocol，因特网控制报文协议，用于在网络设备之间传递各种差错和控制信息。最常见的ping命令就是通过ICMP协议用于可达性测试，ICMP报文结构非常简单，由3部分组成：Type、Code、Checksum，不同类型和代码标识不同的内容

| 类型 | 代码 | 描述 |
| :-: | :-: | :-: |
| 0 | 0 | Echo Reply |
| 3 | 0 | 网络不可达 |
| 3 | 1 | 主机不可达 |
| 3 | 2 | 协议不可达 |
| 3 | 3 | 端口不可达 |
| 5 | 0 | 重定向 |
| 8 | 0 | Echo Request |
| 11 | 0 | TTL值归零 |

ping命令常用选项

<table>
    <tr>
        <td rowspan="4">参数</td>
        <td>-t  长ping</td>
    </tr>
    <tr>
        <td>-l  指定每个数据包发送的字节大小</td>
    </tr>
    <tr>
        <td>-i  TTL</td>
    </tr>
    <tr>
        <td>-f  在数据包中设置“不分段”标记(仅适用于 IPv4)</td>
    </tr>
    <tr>
        <td>ping成功</td>
        <td>回显有来自对端主机的回复，包括字节大小、延时、TTL</td>
    </tr>
    <tr>
        <td>无法访问目标主机</td>
        <td>网关没有路由、没有获取到目标MAC。场景是随便输入一个广播域内的IP地址，本地大概率是没有该IP的ARP缓存的，所以首先会发送ARP请求包，而该IP根本不存在，所以ARP请求无法获取到对端主机的MAC地址，ICMP报文无法封装</td>
    </tr>
    <tr>
        <td>请求超时</td>
        <td>对方主机不在线、屏蔽等。对方主机不在线跟ARP请求没有必然联系，请求超时问题是由于目标主机没有回应ICMP响应包导致的，目标主机可能会因为关机、屏蔽ICMP包等原因，都会导致请求超时</td>
    </tr>
    <tr>
        <td>传输失败</td>
        <td>尝试访问其他网络的主机，而本身没有配置网关</td>
    </tr>
</table>


##### IP

Internet Protocol，因特网协议，网络层中包含有许多协议，其中最重要的就是IP协议，网络层提供了IP路由功能

![IP包头结构](https://www.z4a.net/images/2023/09/10/IP.png)

IP包头固定20字节

| 字段 | 作用 | 解析 |
| :-: | :-: | :-- |
| Version | 版本 | IPv4和IPv6|
| Header Length | 头部长度 | 头部长度是固定的20字节，在抓包看到的数据固定是5，他用于表示IP包头的大小|
| DS Field | 差异化服务 | 早期用来表示业务类型，现用于支持QoS中的差分服务模型，实现网络流量优化 |
| Total Length | 总长度 | IP包头长度+上层数据长度=总长度，默认情况下总长度不能超过1500。因为对于数据链路层来说，上层的数据部分也包括了网络层的封装，MTU默认是1500，则总长度不能超过1500，那么实际上去掉IP包头的长度后，上层数据长度不能超过1480，如果上层数据使用TCP传输，TCP包头也是固定20字节，那么应用层数据长度最大则不能超过1460 |
| Identified | 标识| 同一个数据包的多个分片数据包的标识位是相同的 |
| Flags | 分段标志 | 在Flags分段标识下面还有3个字段：Reserved、Fragment、More Fragments，Reserved是保留字段，Fragment值为1时表示不允许对数据包分片；More Fragments值等于1时，表示此数据包后面还有其他分片，More Fragments值等于0表示此分片数据包已经是最后一个分片了 |
| Fragment Offset | 分段偏移量 | 以上一个分片数据包的长度为对比，记录下一个分片数据包的头部长度编号。例如发送一个字节为2000的ICMP数据包，对于IP包来说默认能够承载的最大数据长度是1480，那么数据包的长度自然就是0-1479，下一个分片数据长度应该是从1480-2000，所以Fragment Offset字段记录的值应该是1480 |
| Time to Live | 生存时间 | 它用于防止IP数据包在网络内环路，数据包每经过一次路由（路由表查找）TTL值就会-1，当TTL值为0时丢弃数据包。利用TTL的特性能够防止数据包环路，也实现了路由跟踪技术 |
| Protocol | 协议号 | 用于标识上层协议 |

Identified、Flags、Fragment Offset，这三个字段都用于分片，当数据包比链路MTU大时，就可以被分解为多个片段。IPv6数据包是不允许分片的，因为IPv6数据包中已经没有分片的三个字段结构了，IPv6有一个机制在发送数据包之前会先检测整条链路上最小的MTU值，按照最小MTU值进行发包

关于数据的切分，在传输层的数据切分称为分段、在网络层的数据切分称为分片，两者都是TCP/IP协议中的重要概念，用于处理网络数据包在传输过程中的大小限制。只不过分段只应用在传输层的TCP协议中，UDP协议对来自应用层的数据直接封装，其自身是不对数据进行分段的，UDP依靠网络层的IP协议对数据包进行分片

**TTL路由跟踪**

TTL路由跟踪可以使用两个最常见的命令实现：ping -i或tracert -d

```
ping -i 1 www.baidu.com
正在 Ping www.a.shifen.com [14.119.104.189] 具有 32 字节的数据:
来自 10.20.239.254 的回复: TTL 传输中过期。     #回复的这个IP地址就是主机当前所处局域网的网关
ping -i 2 www.baidu.com
正在 Ping www.a.shifen.com [14.119.104.189] 具有 32 字节的数据:
来自 10.20.224.1 的回复: TTL 传输中过期。

tracert -d www.baidu.com    #-d表示不将地址解析成主机名
1     3 ms    28 ms     4 ms  10.20.239.254
2     4 ms     4 ms     4 ms  10.20.224.1
3     5 ms     6 ms     4 ms  175.6.17.161
4     *        *        *     请求超时。
5     4 ms     4 ms     4 ms  175.6.12.141
6     4 ms     4 ms     3 ms  61.137.12.253
7     *        *        *     请求超时。
8     *        *        *     请求超时。
```

tracert命令每行解析都有三个毫秒延迟时间，这是因为tracert命令一次会发送3个ICMP包，同一批的3个ICMP包TTL时间相同，不同批的ICMP包TTL逐渐累加，其中部分节点出现*号请求超时，因为有些设备出于ping的保护机制，ping包太快或太频繁时不予回复；通过tracert跟踪到的地址查询IP所处地域，可以看到路由逐步出省

通过eNSP制造环路后抓包，可以在wireshark里看到有单独颜色的包标记，TTL Exceeded是TTL值归零时，对端网络设备的ICMP回包

**IP协议号**

常见的IP协议号：1（ICMP）、2（IGMP）、6（TCP）、9（IGRP）、17（UDP）、47（GRE）、50（ESP）、51（AH）、57（SKIP）、88（EIGRP）、89（OSPF）、115（L2TP）

到目前为止，对于数据包的结构就应该有个清晰的认知了。假设应用层是DNS协议、那么传输层就应该是UDP协议、网络层就是IP包头、链路层是Ethernet Ⅱ包头，这过程中每个层级每个协议的数据包构成应该要有记忆

<table>
    <tr>
        <td>Ethernet Ⅱ帧封装协议类型是0x0800</td>
        <td>ip包头封装协议号是17</td>
        <td>UDP目标端口号是53</td>
    </tr>
</table>

#### 物理层

物理层的主要设备包括网线、光纤、中继器、集线器（Hub），集线器外观上与交换机非常相似，但集线器不具备寻址能力，所有数据泛洪式转发，所以其工作在物理层。双绞线的线型分为2种：直连线和交叉线，异类直连、同类交叉，不过现在大多网口具备收发自动转换能力，已经不需要明显区分线型

计算机之所以只识别二进制是因为bit流电信号其非正即负的简易性，如果采用十进制，有可能因为计算机对电信号强弱的误判导致整段数据出错

**常见的设备以太网接口类型**

| 接口                                | 说明                                        |
| ----------------------------------- | ------------------------------------------- |
| Ethernet                            | 10M 以太网接口                              |
| FastEthernet                        | 100M 以太网接口                             |
| GigabitEthernet                     | 1G 以太网接口，交换机上会缩写端口名称为GE   |
| XGigabitEthernet/TenGigabitEthernet | 10G 以太网接口，交换机上会缩写端口名称为XGE |

